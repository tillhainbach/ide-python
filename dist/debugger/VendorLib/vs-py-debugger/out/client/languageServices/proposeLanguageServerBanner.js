// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/types");

const random_1 = require("../common/utils/random"); // persistent state names, exported to make use of in testing


var ProposeLSStateKeys;

(function (ProposeLSStateKeys) {
  ProposeLSStateKeys["ShowBanner"] = "ProposeLSBanner";
})(ProposeLSStateKeys = exports.ProposeLSStateKeys || (exports.ProposeLSStateKeys = {}));

var ProposeLSLabelIndex;

(function (ProposeLSLabelIndex) {
  ProposeLSLabelIndex[ProposeLSLabelIndex["Yes"] = 0] = "Yes";
  ProposeLSLabelIndex[ProposeLSLabelIndex["No"] = 1] = "No";
  ProposeLSLabelIndex[ProposeLSLabelIndex["Later"] = 2] = "Later";
})(ProposeLSLabelIndex || (ProposeLSLabelIndex = {}));
/*
This class represents a popup that propose that the user try out a new
feature of the extension, and optionally enable that new feature if they
choose to do so. It is meant to be shown only to a subset of our users,
and will show as soon as it is instructed to do so, if a random sample
function enables the popup for this user.
*/


let ProposeLanguageServerBanner = class ProposeLanguageServerBanner {
  constructor(appShell, persistentState, configuration, sampleSizePerOneHundredUsers = 10) {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.configuration = configuration;
    this.disabledInCurrentSession = false;
    this.bannerMessage = 'Try out Preview of our new Python Language Server to get richer and faster IntelliSense completions, and syntax errors as you type.';
    this.bannerLabels = ['Try it now', 'No thanks', 'Remind me Later'];
    this.sampleSizePerHundred = sampleSizePerOneHundredUsers;
    this.initialize();
  }

  initialize() {
    if (this.initialized) {
      return;
    }

    this.initialized = true; // Don't even bother adding handlers if banner has been turned off.

    if (!this.enabled) {
      return;
    } // we only want 10% of folks that use Jedi to see this survey.


    const randomSample = random_1.getRandomBetween(0, 100);

    if (randomSample >= this.sampleSizePerHundred) {
      this.disable().ignoreErrors();
      return;
    }
  }

  get shownCount() {
    return Promise.resolve(-1); // we don't count this popup banner!
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled) {
        return;
      }

      const show = yield this.shouldShowBanner();

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[ProposeLSLabelIndex.Yes]:
          {
            yield this.enableNewLanguageServer();
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.Later]:
          {
            this.disabledInCurrentSession = true;
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      return Promise.resolve(this.enabled && !this.disabledInCurrentSession);
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  enableNewLanguageServer() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.configuration.updateSetting('jediEnabled', false, undefined, vscode_1.ConfigurationTarget.Global);
    });
  }

};
ProposeLanguageServerBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IPersistentStateFactory)), __param(2, inversify_1.inject(types_2.IConfigurationService))], ProposeLanguageServerBanner);
exports.ProposeLanguageServerBanner = ProposeLanguageServerBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInJhbmRvbV8xIiwiUHJvcG9zZUxTU3RhdGVLZXlzIiwiUHJvcG9zZUxTTGFiZWxJbmRleCIsIlByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJjb25maWd1cmF0aW9uIiwic2FtcGxlU2l6ZVBlck9uZUh1bmRyZWRVc2VycyIsImRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiIsImJhbm5lck1lc3NhZ2UiLCJiYW5uZXJMYWJlbHMiLCJzYW1wbGVTaXplUGVySHVuZHJlZCIsImluaXRpYWxpemUiLCJpbml0aWFsaXplZCIsImVuYWJsZWQiLCJyYW5kb21TYW1wbGUiLCJnZXRSYW5kb21CZXR3ZWVuIiwiZGlzYWJsZSIsImlnbm9yZUVycm9ycyIsInNob3duQ291bnQiLCJvcHRpb25MYWJlbHMiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJTaG93QmFubmVyIiwic2hvd0Jhbm5lciIsInNob3ciLCJzaG91bGRTaG93QmFubmVyIiwicmVzcG9uc2UiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiWWVzIiwiZW5hYmxlTmV3TGFuZ3VhZ2VTZXJ2ZXIiLCJObyIsIkxhdGVyIiwidXBkYXRlVmFsdWUiLCJ1cGRhdGVTZXR0aW5nIiwidW5kZWZpbmVkIiwiQ29uZmlndXJhdGlvblRhcmdldCIsIkdsb2JhbCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFp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ZSxDQUFoQjtBQUdIOztBQUNESCxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPdEQsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQsWUFBTSxLQUFLK0IsYUFBTCxDQUFtQjJCLGFBQW5CLENBQWlDLGFBQWpDLEVBQWdELEtBQWhELEVBQXVEQyxTQUF2RCxFQUFrRXRDLFFBQVEsQ0FBQ3VDLG1CQUFULENBQTZCQyxNQUEvRixDQUFOO0FBQ0gsS0FGZSxDQUFoQjtBQUdIOztBQWpGK0QsQ0FBcEU7QUFtRkFsQywyQkFBMkIsR0FBRzlDLFVBQVUsQ0FBQyxDQUNyQ3NDLFdBQVcsQ0FBQzJDLFVBQVosRUFEcUMsRUFFckNqRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDNEMsTUFBWixDQUFtQnpDLE9BQU8sQ0FBQzBDLGlCQUEzQixDQUFKLENBRjhCLEVBR3JDbkUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzRDLE1BQVosQ0FBbUJ4QyxPQUFPLENBQUMwQyx1QkFBM0IsQ0FBSixDQUg4QixFQUlyQ3BFLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUM0QyxNQUFaLENBQW1CeEMsT0FBTyxDQUFDMkMscUJBQTNCLENBQUosQ0FKOEIsQ0FBRCxFQUtyQ3ZDLDJCQUxxQyxDQUF4QztBQU1BVCxPQUFPLENBQUNTLDJCQUFSLEdBQXNDQSwyQkFBdEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xuY29uc3QgcmFuZG9tXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL3JhbmRvbVwiKTtcbi8vIHBlcnNpc3RlbnQgc3RhdGUgbmFtZXMsIGV4cG9ydGVkIHRvIG1ha2UgdXNlIG9mIGluIHRlc3RpbmdcbnZhciBQcm9wb3NlTFNTdGF0ZUtleXM7XG4oZnVuY3Rpb24gKFByb3Bvc2VMU1N0YXRlS2V5cykge1xuICAgIFByb3Bvc2VMU1N0YXRlS2V5c1tcIlNob3dCYW5uZXJcIl0gPSBcIlByb3Bvc2VMU0Jhbm5lclwiO1xufSkoUHJvcG9zZUxTU3RhdGVLZXlzID0gZXhwb3J0cy5Qcm9wb3NlTFNTdGF0ZUtleXMgfHwgKGV4cG9ydHMuUHJvcG9zZUxTU3RhdGVLZXlzID0ge30pKTtcbnZhciBQcm9wb3NlTFNMYWJlbEluZGV4O1xuKGZ1bmN0aW9uIChQcm9wb3NlTFNMYWJlbEluZGV4KSB7XG4gICAgUHJvcG9zZUxTTGFiZWxJbmRleFtQcm9wb3NlTFNMYWJlbEluZGV4W1wiWWVzXCJdID0gMF0gPSBcIlllc1wiO1xuICAgIFByb3Bvc2VMU0xhYmVsSW5kZXhbUHJvcG9zZUxTTGFiZWxJbmRleFtcIk5vXCJdID0gMV0gPSBcIk5vXCI7XG4gICAgUHJvcG9zZUxTTGFiZWxJbmRleFtQcm9wb3NlTFNMYWJlbEluZGV4W1wiTGF0ZXJcIl0gPSAyXSA9IFwiTGF0ZXJcIjtcbn0pKFByb3Bvc2VMU0xhYmVsSW5kZXggfHwgKFByb3Bvc2VMU0xhYmVsSW5kZXggPSB7fSkpO1xuLypcblRoaXMgY2xhc3MgcmVwcmVzZW50cyBhIHBvcHVwIHRoYXQgcHJvcG9zZSB0aGF0IHRoZSB1c2VyIHRyeSBvdXQgYSBuZXdcbmZlYXR1cmUgb2YgdGhlIGV4dGVuc2lvbiwgYW5kIG9wdGlvbmFsbHkgZW5hYmxlIHRoYXQgbmV3IGZlYXR1cmUgaWYgdGhleVxuY2hvb3NlIHRvIGRvIHNvLiBJdCBpcyBtZWFudCB0byBiZSBzaG93biBvbmx5IHRvIGEgc3Vic2V0IG9mIG91ciB1c2VycyxcbmFuZCB3aWxsIHNob3cgYXMgc29vbiBhcyBpdCBpcyBpbnN0cnVjdGVkIHRvIGRvIHNvLCBpZiBhIHJhbmRvbSBzYW1wbGVcbmZ1bmN0aW9uIGVuYWJsZXMgdGhlIHBvcHVwIGZvciB0aGlzIHVzZXIuXG4qL1xubGV0IFByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciA9IGNsYXNzIFByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciB7XG4gICAgY29uc3RydWN0b3IoYXBwU2hlbGwsIHBlcnNpc3RlbnRTdGF0ZSwgY29uZmlndXJhdGlvbiwgc2FtcGxlU2l6ZVBlck9uZUh1bmRyZWRVc2VycyA9IDEwKSB7XG4gICAgICAgIHRoaXMuYXBwU2hlbGwgPSBhcHBTaGVsbDtcbiAgICAgICAgdGhpcy5wZXJzaXN0ZW50U3RhdGUgPSBwZXJzaXN0ZW50U3RhdGU7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYmFubmVyTWVzc2FnZSA9ICdUcnkgb3V0IFByZXZpZXcgb2Ygb3VyIG5ldyBQeXRob24gTGFuZ3VhZ2UgU2VydmVyIHRvIGdldCByaWNoZXIgYW5kIGZhc3RlciBJbnRlbGxpU2Vuc2UgY29tcGxldGlvbnMsIGFuZCBzeW50YXggZXJyb3JzIGFzIHlvdSB0eXBlLic7XG4gICAgICAgIHRoaXMuYmFubmVyTGFiZWxzID0gWydUcnkgaXQgbm93JywgJ05vIHRoYW5rcycsICdSZW1pbmQgbWUgTGF0ZXInXTtcbiAgICAgICAgdGhpcy5zYW1wbGVTaXplUGVySHVuZHJlZCA9IHNhbXBsZVNpemVQZXJPbmVIdW5kcmVkVXNlcnM7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBpZiAodGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICAvLyBEb24ndCBldmVuIGJvdGhlciBhZGRpbmcgaGFuZGxlcnMgaWYgYmFubmVyIGhhcyBiZWVuIHR1cm5lZCBvZmYuXG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gd2Ugb25seSB3YW50IDEwJSBvZiBmb2xrcyB0aGF0IHVzZSBKZWRpIHRvIHNlZSB0aGlzIHN1cnZleS5cbiAgICAgICAgY29uc3QgcmFuZG9tU2FtcGxlID0gcmFuZG9tXzEuZ2V0UmFuZG9tQmV0d2VlbigwLCAxMDApO1xuICAgICAgICBpZiAocmFuZG9tU2FtcGxlID49IHRoaXMuc2FtcGxlU2l6ZVBlckh1bmRyZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZSgpLmlnbm9yZUVycm9ycygpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCBzaG93bkNvdW50KCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKC0xKTsgLy8gd2UgZG9uJ3QgY291bnQgdGhpcyBwb3B1cCBiYW5uZXIhXG4gICAgfVxuICAgIGdldCBvcHRpb25MYWJlbHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJhbm5lckxhYmVscztcbiAgICB9XG4gICAgZ2V0IGVuYWJsZWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoUHJvcG9zZUxTU3RhdGVLZXlzLlNob3dCYW5uZXIsIHRydWUpLnZhbHVlO1xuICAgIH1cbiAgICBzaG93QmFubmVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzaG93ID0geWllbGQgdGhpcy5zaG91bGRTaG93QmFubmVyKCk7XG4gICAgICAgICAgICBpZiAoIXNob3cpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHRoaXMuYXBwU2hlbGwuc2hvd0luZm9ybWF0aW9uTWVzc2FnZSh0aGlzLmJhbm5lck1lc3NhZ2UsIC4uLnRoaXMuYmFubmVyTGFiZWxzKTtcbiAgICAgICAgICAgIHN3aXRjaCAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW1Byb3Bvc2VMU0xhYmVsSW5kZXguWWVzXToge1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmVuYWJsZU5ld0xhbmd1YWdlU2VydmVyKCk7XG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZGlzYWJsZSgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tQcm9wb3NlTFNMYWJlbEluZGV4Lk5vXToge1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRpc2FibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgdGhpcy5iYW5uZXJMYWJlbHNbUHJvcG9zZUxTTGFiZWxJbmRleC5MYXRlcl06IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGZvciB0aGUgY3VycmVudCBzZXNzaW9uLlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2hvdWxkU2hvd0Jhbm5lcigpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5lbmFibGVkICYmICF0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBkaXNhYmxlKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKFByb3Bvc2VMU1N0YXRlS2V5cy5TaG93QmFubmVyLCBmYWxzZSkudXBkYXRlVmFsdWUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZW5hYmxlTmV3TGFuZ3VhZ2VTZXJ2ZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmNvbmZpZ3VyYXRpb24udXBkYXRlU2V0dGluZygnamVkaUVuYWJsZWQnLCBmYWxzZSwgdW5kZWZpbmVkLCB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0Lkdsb2JhbCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5Qcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpKSxcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkpXG5dLCBQcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIpO1xuZXhwb3J0cy5Qcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIgPSBQcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1wcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIuanMubWFwIl19