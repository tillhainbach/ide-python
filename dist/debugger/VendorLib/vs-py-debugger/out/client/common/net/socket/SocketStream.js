"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const uint64be = require("uint64be");

class SocketStream {
  constructor(socket, buffer) {
    this.bytesRead = 0;
    this.hasInsufficientDataForReading = false;
    this.buffer = buffer;
    this.socket = socket;
  }

  WriteInt32(num) {
    this.WriteInt64(num);
  }

  WriteInt64(num) {
    let buffer = uint64be.encode(num);
    this.socket.write(buffer);
  }

  WriteString(value) {
    let stringBuffer = new Buffer(value, "utf-8");
    this.WriteInt32(stringBuffer.length);

    if (stringBuffer.length > 0) {
      this.socket.write(stringBuffer);
    }
  }

  Write(buffer) {
    this.socket.write(buffer);
  }

  get Buffer() {
    return this.buffer;
  }

  BeginTransaction() {
    this.isInTransaction = true;
    this.bytesRead = 0;
    this.ClearErrors();
  }

  EndTransaction() {
    this.isInTransaction = false;
    this.buffer = this.buffer.slice(this.bytesRead);
    this.bytesRead = 0;
    this.ClearErrors();
  }

  RollBackTransaction() {
    this.isInTransaction = false;
    this.bytesRead = 0;
    this.ClearErrors();
  }

  ClearErrors() {
    this.hasInsufficientDataForReading = false;
  }

  get HasInsufficientDataForReading() {
    return this.hasInsufficientDataForReading;
  }

  toString() {
    return this.buffer.toString();
  }

  get Length() {
    return this.buffer.length;
  }

  Append(additionalData) {
    if (this.buffer.length === 0) {
      this.buffer = additionalData;
      return;
    }

    let newBuffer = new Buffer(this.buffer.length + additionalData.length);
    this.buffer.copy(newBuffer);
    additionalData.copy(newBuffer, this.buffer.length);
    this.buffer = newBuffer;
  }

  isSufficientDataAvailable(length) {
    if (this.buffer.length < this.bytesRead + length) {
      this.hasInsufficientDataForReading = true;
    }

    return !this.hasInsufficientDataForReading;
  }

  ReadByte() {
    if (!this.isSufficientDataAvailable(1)) {
      return null;
    }

    let value = this.buffer.slice(this.bytesRead, this.bytesRead + 1)[0];

    if (this.isInTransaction) {
      this.bytesRead++;
    } else {
      this.buffer = this.buffer.slice(1);
    }

    return value;
  }

  ReadString() {
    let byteRead = this.ReadByte();

    if (this.HasInsufficientDataForReading) {
      return null;
    }

    if (byteRead < 0) {
      throw new Error("IOException() - Socket.ReadString failed to read string type;");
    }

    let type = new Buffer([byteRead]).toString();
    let isUnicode = false;

    switch (type) {
      case "N":
        // null string
        return null;

      case "U":
        isUnicode = true;
        break;

      case "A":
        {
          isUnicode = false;
          break;
        }

      default:
        {
          throw new Error("IOException(); Socket.ReadString failed to parse unknown string type " + type);
        }
    }

    let len = this.ReadInt32();

    if (this.HasInsufficientDataForReading) {
      return null;
    }

    if (!this.isSufficientDataAvailable(len)) {
      return null;
    }

    let stringBuffer = this.buffer.slice(this.bytesRead, this.bytesRead + len);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + len;
    } else {
      this.buffer = this.buffer.slice(len);
    }

    let resp = isUnicode ? stringBuffer.toString("utf-8") : stringBuffer.toString();
    return resp;
  }

  ReadInt32() {
    return this.ReadInt64();
  }

  ReadInt64() {
    if (!this.isSufficientDataAvailable(8)) {
      return null;
    }

    let buf = this.buffer.slice(this.bytesRead, this.bytesRead + 8);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + 8;
    } else {
      this.buffer = this.buffer.slice(8);
    }

    let returnValue = uint64be.decode(buf);
    return returnValue;
  }

  ReadAsciiString(length) {
    if (!this.isSufficientDataAvailable(length)) {
      return null;
    }

    let stringBuffer = this.buffer.slice(this.bytesRead, this.bytesRead + length);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + length;
    } else {
      this.buffer = this.buffer.slice(length);
    }

    return stringBuffer.toString("ascii");
  }

  readValueInTransaction(dataType) {
    let startedTransaction = false;

    if (!this.isInTransaction) {
      this.BeginTransaction();
      startedTransaction = true;
    }

    let data;

    switch (dataType) {
      case DataType.string:
        {
          data = this.ReadString();
          break;
        }

      case DataType.int32:
        {
          data = this.ReadInt32();
          break;
        }

      case DataType.int64:
        {
          data = this.ReadInt64();
          break;
        }
    }

    if (this.HasInsufficientDataForReading) {
      if (startedTransaction) {
        this.RollBackTransaction();
      }

      return undefined;
    }

    if (startedTransaction) {
      this.EndTransaction();
    }

    return data;
  }

  readStringInTransaction() {
    return this.readValueInTransaction(DataType.string);
  }

  readInt32InTransaction() {
    return this.readValueInTransaction(DataType.int32);
  }

  readInt64InTransaction() {
    return this.readValueInTransaction(DataType.int64);
  }

}

exports.SocketStream = SocketStream;
var DataType;

(function (DataType) {
  DataType[DataType["string"] = 0] = "string";
  DataType[DataType["int32"] = 1] = "int32";
  DataType[DataType["int64"] = 2] = "int64";
})(DataType || (DataType = {}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNvY2tldFN0cmVhbS5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInVpbnQ2NGJlIiwicmVxdWlyZSIsIlNvY2tldFN0cmVhbSIsImNvbnN0cnVjdG9yIiwic29ja2V0IiwiYnVmZmVyIiwiYnl0ZXNSZWFkIiwiaGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmciLCJXcml0ZUludDMyIiwibnVtIiwiV3JpdGVJbnQ2NCIsImVuY29kZSIsIndyaXRlIiwiV3JpdGVTdHJpbmciLCJzdHJpbmdCdWZmZXIiLCJCdWZmZXIiLCJsZW5ndGgiLCJXcml0ZSIsIkJlZ2luVHJhbnNhY3Rpb24iLCJpc0luVHJhbnNhY3Rpb24iLCJDbGVhckVycm9ycyIsIkVuZFRyYW5zYWN0aW9uIiwic2xpY2UiLCJSb2xsQmFja1RyYW5zYWN0aW9uIiwiSGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmciLCJ0b1N0cmluZyIsIkxlbmd0aCIsIkFwcGVuZCIsImFkZGl0aW9uYWxEYXRhIiwibmV3QnVmZmVyIiwiY29weSIsImlzU3VmZmljaWVudERhdGFBdmFpbGFibGUiLCJSZWFkQnl0ZSIsIlJlYWRTdHJpbmciLCJieXRlUmVhZCIsIkVycm9yIiwidHlwZSIsImlzVW5pY29kZSIsImxlbiIsIlJlYWRJbnQzMiIsInJlc3AiLCJSZWFkSW50NjQiLCJidWYiLCJyZXR1cm5WYWx1ZSIsImRlY29kZSIsIlJlYWRBc2NpaVN0cmluZyIsInJlYWRWYWx1ZUluVHJhbnNhY3Rpb24iLCJkYXRhVHlwZSIsInN0YXJ0ZWRUcmFuc2FjdGlvbiIsImRhdGEiLCJEYXRhVHlwZSIsInN0cmluZyIsImludDMyIiwiaW50NjQiLCJ1bmRlZmluZWQiLCJyZWFkU3RyaW5nSW5UcmFuc2FjdGlvbiIsInJlYWRJbnQzMkluVHJhbnNhY3Rpb24iLCJyZWFkSW50NjRJblRyYW5zYWN0aW9uIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQUEsTUFBTSxD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QixDQUFSLEdBQWtDLE9BQWxDO0FBQ0FBLEVBQUFBLFFBQVEsQ0FBQ0EsUUFBUSxDQUFDLE9BQUQsQ0FBUixHQUFvQixDQUFyQixDQUFSLEdBQWtDLE9BQWxDO0FBQ0gsQ0FKRCxFQUlHQSxRQUFRLEtBQUtBLFFBQVEsR0FBRyxFQUFoQixDQUpYIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCB1aW50NjRiZSA9IHJlcXVpcmUoXCJ1aW50NjRiZVwiKTtcbmNsYXNzIFNvY2tldFN0cmVhbSB7XG4gICAgY29uc3RydWN0b3Ioc29ja2V0LCBidWZmZXIpIHtcbiAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSAwO1xuICAgICAgICB0aGlzLmhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyO1xuICAgICAgICB0aGlzLnNvY2tldCA9IHNvY2tldDtcbiAgICB9XG4gICAgV3JpdGVJbnQzMihudW0pIHtcbiAgICAgICAgdGhpcy5Xcml0ZUludDY0KG51bSk7XG4gICAgfVxuICAgIFdyaXRlSW50NjQobnVtKSB7XG4gICAgICAgIGxldCBidWZmZXIgPSB1aW50NjRiZS5lbmNvZGUobnVtKTtcbiAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoYnVmZmVyKTtcbiAgICB9XG4gICAgV3JpdGVTdHJpbmcodmFsdWUpIHtcbiAgICAgICAgbGV0IHN0cmluZ0J1ZmZlciA9IG5ldyBCdWZmZXIodmFsdWUsIFwidXRmLThcIik7XG4gICAgICAgIHRoaXMuV3JpdGVJbnQzMihzdHJpbmdCdWZmZXIubGVuZ3RoKTtcbiAgICAgICAgaWYgKHN0cmluZ0J1ZmZlci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLnNvY2tldC53cml0ZShzdHJpbmdCdWZmZXIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIFdyaXRlKGJ1ZmZlcikge1xuICAgICAgICB0aGlzLnNvY2tldC53cml0ZShidWZmZXIpO1xuICAgIH1cbiAgICBnZXQgQnVmZmVyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5idWZmZXI7XG4gICAgfVxuICAgIEJlZ2luVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuaXNJblRyYW5zYWN0aW9uID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSAwO1xuICAgICAgICB0aGlzLkNsZWFyRXJyb3JzKCk7XG4gICAgfVxuICAgIEVuZFRyYW5zYWN0aW9uKCkge1xuICAgICAgICB0aGlzLmlzSW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuYnl0ZXNSZWFkKTtcbiAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSAwO1xuICAgICAgICB0aGlzLkNsZWFyRXJyb3JzKCk7XG4gICAgfVxuICAgIFJvbGxCYWNrVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuaXNJblRyYW5zYWN0aW9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYnl0ZXNSZWFkID0gMDtcbiAgICAgICAgdGhpcy5DbGVhckVycm9ycygpO1xuICAgIH1cbiAgICBDbGVhckVycm9ycygpIHtcbiAgICAgICAgdGhpcy5oYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZyA9IGZhbHNlO1xuICAgIH1cbiAgICBnZXQgSGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nO1xuICAgIH1cbiAgICB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGdldCBMZW5ndGgoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlci5sZW5ndGg7XG4gICAgfVxuICAgIEFwcGVuZChhZGRpdGlvbmFsRGF0YSkge1xuICAgICAgICBpZiAodGhpcy5idWZmZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IGFkZGl0aW9uYWxEYXRhO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBuZXdCdWZmZXIgPSBuZXcgQnVmZmVyKHRoaXMuYnVmZmVyLmxlbmd0aCArIGFkZGl0aW9uYWxEYXRhLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuYnVmZmVyLmNvcHkobmV3QnVmZmVyKTtcbiAgICAgICAgYWRkaXRpb25hbERhdGEuY29weShuZXdCdWZmZXIsIHRoaXMuYnVmZmVyLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gbmV3QnVmZmVyO1xuICAgIH1cbiAgICBpc1N1ZmZpY2llbnREYXRhQXZhaWxhYmxlKGxlbmd0aCkge1xuICAgICAgICBpZiAodGhpcy5idWZmZXIubGVuZ3RoIDwgKHRoaXMuYnl0ZXNSZWFkICsgbGVuZ3RoKSkge1xuICAgICAgICAgICAgdGhpcy5oYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICF0aGlzLmhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nO1xuICAgIH1cbiAgICBSZWFkQnl0ZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzU3VmZmljaWVudERhdGFBdmFpbGFibGUoMSkpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuYnl0ZXNSZWFkLCB0aGlzLmJ5dGVzUmVhZCArIDEpWzBdO1xuICAgICAgICBpZiAodGhpcy5pc0luVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuYnl0ZXNSZWFkKys7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKDEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgUmVhZFN0cmluZygpIHtcbiAgICAgICAgbGV0IGJ5dGVSZWFkID0gdGhpcy5SZWFkQnl0ZSgpO1xuICAgICAgICBpZiAodGhpcy5IYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJ5dGVSZWFkIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSU9FeGNlcHRpb24oKSAtIFNvY2tldC5SZWFkU3RyaW5nIGZhaWxlZCB0byByZWFkIHN0cmluZyB0eXBlO1wiKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdHlwZSA9IG5ldyBCdWZmZXIoW2J5dGVSZWFkXSkudG9TdHJpbmcoKTtcbiAgICAgICAgbGV0IGlzVW5pY29kZSA9IGZhbHNlO1xuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgXCJOXCI6IC8vIG51bGwgc3RyaW5nXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICBjYXNlIFwiVVwiOlxuICAgICAgICAgICAgICAgIGlzVW5pY29kZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiQVwiOiB7XG4gICAgICAgICAgICAgICAgaXNVbmljb2RlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSU9FeGNlcHRpb24oKTsgU29ja2V0LlJlYWRTdHJpbmcgZmFpbGVkIHRvIHBhcnNlIHVua25vd24gc3RyaW5nIHR5cGUgXCIgKyB0eXBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZXQgbGVuID0gdGhpcy5SZWFkSW50MzIoKTtcbiAgICAgICAgaWYgKHRoaXMuSGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5pc1N1ZmZpY2llbnREYXRhQXZhaWxhYmxlKGxlbikpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGxldCBzdHJpbmdCdWZmZXIgPSB0aGlzLmJ1ZmZlci5zbGljZSh0aGlzLmJ5dGVzUmVhZCwgdGhpcy5ieXRlc1JlYWQgKyBsZW4pO1xuICAgICAgICBpZiAodGhpcy5pc0luVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuYnl0ZXNSZWFkID0gdGhpcy5ieXRlc1JlYWQgKyBsZW47XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKGxlbik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc3AgPSBpc1VuaWNvZGUgPyBzdHJpbmdCdWZmZXIudG9TdHJpbmcoXCJ1dGYtOFwiKSA6IHN0cmluZ0J1ZmZlci50b1N0cmluZygpO1xuICAgICAgICByZXR1cm4gcmVzcDtcbiAgICB9XG4gICAgUmVhZEludDMyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5SZWFkSW50NjQoKTtcbiAgICB9XG4gICAgUmVhZEludDY0KCkge1xuICAgICAgICBpZiAoIXRoaXMuaXNTdWZmaWNpZW50RGF0YUF2YWlsYWJsZSg4KSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGJ1ZiA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuYnl0ZXNSZWFkLCB0aGlzLmJ5dGVzUmVhZCArIDgpO1xuICAgICAgICBpZiAodGhpcy5pc0luVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuYnl0ZXNSZWFkID0gdGhpcy5ieXRlc1JlYWQgKyA4O1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zbGljZSg4KTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcmV0dXJuVmFsdWUgPSB1aW50NjRiZS5kZWNvZGUoYnVmKTtcbiAgICAgICAgcmV0dXJuIHJldHVyblZhbHVlO1xuICAgIH1cbiAgICBSZWFkQXNjaWlTdHJpbmcobGVuZ3RoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1N1ZmZpY2llbnREYXRhQXZhaWxhYmxlKGxlbmd0aCkpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGxldCBzdHJpbmdCdWZmZXIgPSB0aGlzLmJ1ZmZlci5zbGljZSh0aGlzLmJ5dGVzUmVhZCwgdGhpcy5ieXRlc1JlYWQgKyBsZW5ndGgpO1xuICAgICAgICBpZiAodGhpcy5pc0luVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuYnl0ZXNSZWFkID0gdGhpcy5ieXRlc1JlYWQgKyBsZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKGxlbmd0aCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0cmluZ0J1ZmZlci50b1N0cmluZyhcImFzY2lpXCIpO1xuICAgIH1cbiAgICByZWFkVmFsdWVJblRyYW5zYWN0aW9uKGRhdGFUeXBlKSB7XG4gICAgICAgIGxldCBzdGFydGVkVHJhbnNhY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgaWYgKCF0aGlzLmlzSW5UcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgdGhpcy5CZWdpblRyYW5zYWN0aW9uKCk7XG4gICAgICAgICAgICBzdGFydGVkVHJhbnNhY3Rpb24gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGxldCBkYXRhO1xuICAgICAgICBzd2l0Y2ggKGRhdGFUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIERhdGFUeXBlLnN0cmluZzoge1xuICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLlJlYWRTdHJpbmcoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUuaW50MzI6IHtcbiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5SZWFkSW50MzIoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUuaW50NjQ6IHtcbiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5SZWFkSW50NjQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5IYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZykge1xuICAgICAgICAgICAgaWYgKHN0YXJ0ZWRUcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgICAgIHRoaXMuUm9sbEJhY2tUcmFuc2FjdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3RhcnRlZFRyYW5zYWN0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLkVuZFRyYW5zYWN0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIHJlYWRTdHJpbmdJblRyYW5zYWN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZWFkVmFsdWVJblRyYW5zYWN0aW9uKERhdGFUeXBlLnN0cmluZyk7XG4gICAgfVxuICAgIHJlYWRJbnQzMkluVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlYWRWYWx1ZUluVHJhbnNhY3Rpb24oRGF0YVR5cGUuaW50MzIpO1xuICAgIH1cbiAgICByZWFkSW50NjRJblRyYW5zYWN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZWFkVmFsdWVJblRyYW5zYWN0aW9uKERhdGFUeXBlLmludDY0KTtcbiAgICB9XG59XG5leHBvcnRzLlNvY2tldFN0cmVhbSA9IFNvY2tldFN0cmVhbTtcbnZhciBEYXRhVHlwZTtcbihmdW5jdGlvbiAoRGF0YVR5cGUpIHtcbiAgICBEYXRhVHlwZVtEYXRhVHlwZVtcInN0cmluZ1wiXSA9IDBdID0gXCJzdHJpbmdcIjtcbiAgICBEYXRhVHlwZVtEYXRhVHlwZVtcImludDMyXCJdID0gMV0gPSBcImludDMyXCI7XG4gICAgRGF0YVR5cGVbRGF0YVR5cGVbXCJpbnQ2NFwiXSA9IDJdID0gXCJpbnQ2NFwiO1xufSkoRGF0YVR5cGUgfHwgKERhdGFUeXBlID0ge30pKTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPVNvY2tldFN0cmVhbS5qcy5tYXAiXX0=