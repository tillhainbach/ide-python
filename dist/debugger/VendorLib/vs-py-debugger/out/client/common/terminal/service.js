"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

require("../../common/extensions");

const contracts_1 = require("../../interpreter/contracts");

const types_1 = require("../../ioc/types");

const telemetry_1 = require("../../telemetry");

const constants_1 = require("../../telemetry/constants");

const types_2 = require("../application/types");

const types_3 = require("../types");

const types_4 = require("./types");

let TerminalService = class TerminalService {
  constructor(serviceContainer, resource, title = 'Python') {
    this.serviceContainer = serviceContainer;
    this.resource = resource;
    this.title = title;
    this.terminalClosed = new vscode_1.EventEmitter();
    const disposableRegistry = this.serviceContainer.get(types_3.IDisposableRegistry);
    disposableRegistry.push(this);
    this.terminalHelper = this.serviceContainer.get(types_4.ITerminalHelper);
    this.terminalManager = this.serviceContainer.get(types_2.ITerminalManager);
    this.terminalManager.onDidCloseTerminal(this.terminalCloseHandler, this, disposableRegistry);
    this.terminalActivator = this.serviceContainer.get(types_4.ITerminalActivator);
  }

  get onDidCloseTerminal() {
    return this.terminalClosed.event.bind(this.terminalClosed);
  }

  dispose() {
    if (this.terminal) {
      this.terminal.dispose();
    }
  }

  sendCommand(command, args) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal();
      const text = this.terminalHelper.buildCommandForTerminal(this.terminalShellType, command, args);
      this.terminal.show(true);
      this.terminal.sendText(text, true);
    });
  }

  sendText(text) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal();
      this.terminal.show(true);
      this.terminal.sendText(text);
    });
  }

  show(preserveFocus = true) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal(preserveFocus);
      this.terminal.show(preserveFocus);
    });
  }

  ensureTerminal(preserveFocus = true) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.terminal) {
        return;
      }

      const shellPath = this.terminalHelper.getTerminalShellPath();
      this.terminalShellType = !shellPath || shellPath.length === 0 ? types_4.TerminalShellType.other : this.terminalHelper.identifyTerminalShell(shellPath);
      this.terminal = this.terminalManager.createTerminal({
        name: this.title
      }); // Sometimes the terminal takes some time to start up before it can start accepting input.

      yield new Promise(resolve => setTimeout(resolve, 100));
      yield this.terminalActivator.activateEnvironmentInTerminal(this.terminal, this.resource, preserveFocus);
      this.terminal.show(preserveFocus);
      this.sendTelemetry().ignoreErrors();
    });
  }

  terminalCloseHandler(terminal) {
    if (terminal === this.terminal) {
      this.terminalClosed.fire();
      this.terminal = undefined;
    }
  }

  sendTelemetry() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonPath = this.serviceContainer.get(types_3.IConfigurationService).getSettings(this.resource).pythonPath;
      const interpreterInfo = yield this.serviceContainer.get(contracts_1.IInterpreterService).getInterpreterDetails(pythonPath);
      const pythonVersion = interpreterInfo && interpreterInfo.version_info ? interpreterInfo.version_info.join('.') : undefined;
      const interpreterType = interpreterInfo ? interpreterInfo.type : undefined;
      telemetry_1.captureTelemetry(constants_1.TERMINAL_CREATE, {
        terminal: this.terminalShellType,
        pythonVersion,
        interpreterType
      });
    });
  }

};
TerminalService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IServiceContainer))], TerminalService);
exports.TerminalService = TerminalService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInZzY29kZV8xIiwiY29udHJhY3RzXzEiLCJ0eXBlc18xIiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwidHlwZXNfNCIsIlRlcm1pbmFsU2VydmljZSIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsInJlc291cmNlIiwidGl0bGUiLCJ0ZXJtaW5hbENsb3NlZCIsIkV2ZW50RW1pdHRlciIsImRpc3Bvc2FibGVSZWdpc3RyeSIsImdldCIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJwdXNoIiwidGVybWluYWxIZWxwZXIiLCJJVGVybWluYWxIZWxwZXIiLCJ0ZXJtaW5hbE1hbmFnZXIiLCJJVGVybWluYWxNYW5hZ2VyIiwib25EaWRDbG9zZVRlcm1pbmFsIiwidGVybWluYWxDbG9zZUhhbmRsZXIiLCJ0ZXJtaW5hbEFjdGl2YXRvciIsIklUZXJtaW5hbEFjdGl2YXRvciIsImV2ZW50IiwiYmluZCIsImRpc3Bvc2UiLCJ0ZXJtaW5hbCIsInNlbmRDb21tYW5kIiwiY29tbWFuZCIsImFyZ3MiLCJlbnN1cmVUZXJtaW5hbCIsInRleHQiLCJidWlsZENvbW1hbmRGb3JUZXJtaW5hbCIsInRlcm1pbmFsU2hlbGxUeXBlIiwic2hvdyIsInNlbmRUZXh0IiwicHJlc2VydmVGb2N1cyIsInNoZWxsUGF0aCIsImdldFRlcm1pbmFsU2hlbGxQYXRoIiwiVGVybWluYWxTaGVsbFR5cGUiLCJvdGhlciIsImlkZW50aWZ5VGVybWluYWxTaGVsbCIsImNyZWF0ZVRlcm1pbmFsIiwibmFtZSIsInNldFRpbWVvdXQiLCJhY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCIsInNlbmRUZWxlbWV0cnkiLCJpZ25vcmVFcnJvcnMiLCJmaXJlIiwidW5kZWZpbmVkIiwicHl0aG9uUGF0aCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiaW50ZXJwcmV0ZXJJbmZvIiwiSUludGVycHJldGVyU2VydmljZSIsImdldEludGVycHJldGVyRGV0YWlscyIsInB5dGhvblZlcnNpb24iLCJ2ZXJzaW9uX2luZm8iLCJqb2luIiwiaW50ZXJwcmV0ZXJUeXBlIiwidHlwZSIsImNhcHR1cmVUZWxlbWV0cnkiLCJURVJNSU5BTF9DUkVBVEUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FB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QVcsQ0FBQzhELGdCQUFaLENBQTZCN0QsV0FBVyxDQUFDOEQsZUFBekMsRUFBMEQ7QUFBRXBDLFFBQUFBLFFBQVEsRUFBRSxLQUFLTyxpQkFBakI7QUFBb0N1QixRQUFBQSxhQUFwQztBQUFtREcsUUFBQUE7QUFBbkQsT0FBMUQ7QUFDSCxLQU5lLENBQWhCO0FBT0g7O0FBdkV1QyxDQUE1QztBQXlFQXZELGVBQWUsR0FBR2hELFVBQVUsQ0FBQyxDQUN6QnNDLFdBQVcsQ0FBQ3FFLFVBQVosRUFEeUIsRUFFekIzRixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDc0UsTUFBWixDQUFtQmxFLE9BQU8sQ0FBQ21FLGlCQUEzQixDQUFKLENBRmtCLENBQUQsRUFHekI3RCxlQUh5QixDQUE1QjtBQUlBWCxPQUFPLENBQUNXLGVBQVIsR0FBMEJBLGVBQTFCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5yZXF1aXJlKFwiLi4vLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uLy4uL3RlbGVtZXRyeVwiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcbmxldCBUZXJtaW5hbFNlcnZpY2UgPSBjbGFzcyBUZXJtaW5hbFNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIsIHJlc291cmNlLCB0aXRsZSA9ICdQeXRob24nKSB7XG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XG4gICAgICAgIHRoaXMucmVzb3VyY2UgPSByZXNvdXJjZTtcbiAgICAgICAgdGhpcy50aXRsZSA9IHRpdGxlO1xuICAgICAgICB0aGlzLnRlcm1pbmFsQ2xvc2VkID0gbmV3IHZzY29kZV8xLkV2ZW50RW1pdHRlcigpO1xuICAgICAgICBjb25zdCBkaXNwb3NhYmxlUmVnaXN0cnkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSURpc3Bvc2FibGVSZWdpc3RyeSk7XG4gICAgICAgIGRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKHRoaXMpO1xuICAgICAgICB0aGlzLnRlcm1pbmFsSGVscGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklUZXJtaW5hbEhlbHBlcik7XG4gICAgICAgIHRoaXMudGVybWluYWxNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklUZXJtaW5hbE1hbmFnZXIpO1xuICAgICAgICB0aGlzLnRlcm1pbmFsTWFuYWdlci5vbkRpZENsb3NlVGVybWluYWwodGhpcy50ZXJtaW5hbENsb3NlSGFuZGxlciwgdGhpcywgZGlzcG9zYWJsZVJlZ2lzdHJ5KTtcbiAgICAgICAgdGhpcy50ZXJtaW5hbEFjdGl2YXRvciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JVGVybWluYWxBY3RpdmF0b3IpO1xuICAgIH1cbiAgICBnZXQgb25EaWRDbG9zZVRlcm1pbmFsKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXJtaW5hbENsb3NlZC5ldmVudC5iaW5kKHRoaXMudGVybWluYWxDbG9zZWQpO1xuICAgIH1cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICBpZiAodGhpcy50ZXJtaW5hbCkge1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbC5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgc2VuZENvbW1hbmQoY29tbWFuZCwgYXJncykge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5lbnN1cmVUZXJtaW5hbCgpO1xuICAgICAgICAgICAgY29uc3QgdGV4dCA9IHRoaXMudGVybWluYWxIZWxwZXIuYnVpbGRDb21tYW5kRm9yVGVybWluYWwodGhpcy50ZXJtaW5hbFNoZWxsVHlwZSwgY29tbWFuZCwgYXJncyk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNob3codHJ1ZSk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNlbmRUZXh0KHRleHQsIHRydWUpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2VuZFRleHQodGV4dCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5lbnN1cmVUZXJtaW5hbCgpO1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbC5zaG93KHRydWUpO1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbC5zZW5kVGV4dCh0ZXh0KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNob3cocHJlc2VydmVGb2N1cyA9IHRydWUpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuZW5zdXJlVGVybWluYWwocHJlc2VydmVGb2N1cyk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNob3cocHJlc2VydmVGb2N1cyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbnN1cmVUZXJtaW5hbChwcmVzZXJ2ZUZvY3VzID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMudGVybWluYWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzaGVsbFBhdGggPSB0aGlzLnRlcm1pbmFsSGVscGVyLmdldFRlcm1pbmFsU2hlbGxQYXRoKCk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsU2hlbGxUeXBlID0gIXNoZWxsUGF0aCB8fCBzaGVsbFBhdGgubGVuZ3RoID09PSAwID8gdHlwZXNfNC5UZXJtaW5hbFNoZWxsVHlwZS5vdGhlciA6IHRoaXMudGVybWluYWxIZWxwZXIuaWRlbnRpZnlUZXJtaW5hbFNoZWxsKHNoZWxsUGF0aCk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsID0gdGhpcy50ZXJtaW5hbE1hbmFnZXIuY3JlYXRlVGVybWluYWwoeyBuYW1lOiB0aGlzLnRpdGxlIH0pO1xuICAgICAgICAgICAgLy8gU29tZXRpbWVzIHRoZSB0ZXJtaW5hbCB0YWtlcyBzb21lIHRpbWUgdG8gc3RhcnQgdXAgYmVmb3JlIGl0IGNhbiBzdGFydCBhY2NlcHRpbmcgaW5wdXQuXG4gICAgICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLnRlcm1pbmFsQWN0aXZhdG9yLmFjdGl2YXRlRW52aXJvbm1lbnRJblRlcm1pbmFsKHRoaXMudGVybWluYWwsIHRoaXMucmVzb3VyY2UsIHByZXNlcnZlRm9jdXMpO1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbC5zaG93KHByZXNlcnZlRm9jdXMpO1xuICAgICAgICAgICAgdGhpcy5zZW5kVGVsZW1ldHJ5KCkuaWdub3JlRXJyb3JzKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICB0ZXJtaW5hbENsb3NlSGFuZGxlcih0ZXJtaW5hbCkge1xuICAgICAgICBpZiAodGVybWluYWwgPT09IHRoaXMudGVybWluYWwpIHtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWxDbG9zZWQuZmlyZSgpO1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZW5kVGVsZW1ldHJ5KCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JQ29uZmlndXJhdGlvblNlcnZpY2UpLmdldFNldHRpbmdzKHRoaXMucmVzb3VyY2UpLnB5dGhvblBhdGg7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlckluZm8gPSB5aWVsZCB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlclNlcnZpY2UpLmdldEludGVycHJldGVyRGV0YWlscyhweXRob25QYXRoKTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblZlcnNpb24gPSAoaW50ZXJwcmV0ZXJJbmZvICYmIGludGVycHJldGVySW5mby52ZXJzaW9uX2luZm8pID8gaW50ZXJwcmV0ZXJJbmZvLnZlcnNpb25faW5mby5qb2luKCcuJykgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlclR5cGUgPSBpbnRlcnByZXRlckluZm8gPyBpbnRlcnByZXRlckluZm8udHlwZSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRlbGVtZXRyeV8xLmNhcHR1cmVUZWxlbWV0cnkoY29uc3RhbnRzXzEuVEVSTUlOQUxfQ1JFQVRFLCB7IHRlcm1pbmFsOiB0aGlzLnRlcm1pbmFsU2hlbGxUeXBlLCBweXRob25WZXJzaW9uLCBpbnRlcnByZXRlclR5cGUgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5UZXJtaW5hbFNlcnZpY2UgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBUZXJtaW5hbFNlcnZpY2UpO1xuZXhwb3J0cy5UZXJtaW5hbFNlcnZpY2UgPSBUZXJtaW5hbFNlcnZpY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1zZXJ2aWNlLmpzLm1hcCJdfQ==