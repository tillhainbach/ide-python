// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

const getos = require("getos");

const os = require("os");

const semver = require("semver");

const version_1 = require("./version");

var Architecture;

(function (Architecture) {
  Architecture[Architecture["Unknown"] = 1] = "Unknown";
  Architecture[Architecture["x86"] = 2] = "x86";
  Architecture[Architecture["x64"] = 3] = "x64";
})(Architecture = exports.Architecture || (exports.Architecture = {}));

var OSType;

(function (OSType) {
  OSType[OSType["Unknown"] = 0] = "Unknown";
  OSType[OSType["Windows"] = 1] = "Windows";
  OSType[OSType["OSX"] = 2] = "OSX";
  OSType[OSType["Linux"] = 3] = "Linux";
})(OSType = exports.OSType || (exports.OSType = {}));

var OSDistro;

(function (OSDistro) {
  OSDistro[OSDistro["Unknown"] = 0] = "Unknown"; // linux:

  OSDistro[OSDistro["Ubuntu"] = 1] = "Ubuntu";
  OSDistro[OSDistro["Debian"] = 2] = "Debian";
  OSDistro[OSDistro["RHEL"] = 3] = "RHEL";
  OSDistro[OSDistro["Fedora"] = 4] = "Fedora";
  OSDistro[OSDistro["CentOS"] = 5] = "CentOS"; // The remainder aren't officially supported.
  // See: https://code.visualstudio.com/docs/supporting/requirements

  OSDistro[OSDistro["Suse"] = 6] = "Suse";
  OSDistro[OSDistro["Gentoo"] = 7] = "Gentoo";
  OSDistro[OSDistro["Arch"] = 8] = "Arch";
})(OSDistro = exports.OSDistro || (exports.OSDistro = {}));

let local;

function getLocal() {
  if (!local) {
    local = getInfo();
  }

  return local;
}

function getOSType(platform = process.platform) {
  if (/^win/.test(platform)) {
    return OSType.Windows;
  } else if (/^darwin/.test(platform)) {
    return OSType.OSX;
  } else if (/^linux/.test(platform)) {
    return OSType.Linux;
  } else {
    return OSType.Unknown;
  }
}

exports.getOSType = getOSType;

class Info {
  constructor(type, arch = os.arch(), // See:
  //  https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/semver/index.d.ts#L152
  version = new semver.SemVer('0.0.0'), distro = OSDistro.Unknown) {
    this.type = type;
    this.arch = arch;
    this.version = version;
    this.distro = distro;
  }

  get architecture() {
    return this.arch === 'x64' ? Architecture.x64 : Architecture.x86;
  }

  matchPlatform(names) {
    return matchPlatform(names, this);
  }

}

exports.Info = Info;

function getInfo(getArch = os.arch, getRelease = os.release, getDistro = getLinuxDistro, platform) {
  const osType = getOSType(platform);
  const arch = getArch();

  switch (osType) {
    case OSType.Windows:
      return getDefaultInfo(osType, arch, getRelease);

    case OSType.OSX:
      return getDefaultInfo(osType, arch, getRelease);

    case OSType.Linux:
      return getLinuxInfo(arch, getDistro);

    default:
      return new Info(OSType.Unknown, arch);
  }
}

exports.getInfo = getInfo;

function getDefaultInfo(osType, arch, getRelease) {
  const version = version_1.parseVersion(getRelease());
  return new Info(osType, arch, version);
}

function getLinuxInfo(arch, getDistro) {
  const [distro, version] = getDistro();
  return new Info(OSType.Linux, arch, version, distro);
}

function getLinuxDistro() {
  let distro = OSDistro.Unknown;
  let version = new semver.SemVer('0.0.0');
  getos((exc, info) => {
    if (exc) {
      throw exc;
    }

    distro = getLinuxDistroFromName(info.dist);
    version = version_1.parseVersion(info.release);
  });
  return [distro, version];
}

function getLinuxDistroFromName(name) {
  name = name.toLowerCase(); // See https://github.com/zyga/os-release-zoo.

  if (/ubuntu/.test(name)) {
    return OSDistro.Ubuntu;
  } else if (/debian/.test(name)) {
    return OSDistro.Debian;
  } else if (/rhel/.test(name) || /red hat/.test(name)) {
    return OSDistro.RHEL;
  } else if (/fedora/.test(name)) {
    return OSDistro.Fedora;
  } else if (/centos/.test(name)) {
    return OSDistro.CentOS;
  } // The remainder aren't officially supported by VS Code.


  if (/suse/.test(name)) {
    return OSDistro.Suse;
  } else if (/gentoo/.test(name)) {
    return OSDistro.Suse;
  } else if (/arch/.test(name)) {
    return OSDistro.Arch;
  } else {
    return OSDistro.Unknown;
  }
} // helpers


function isWindows(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.Windows;
}

exports.isWindows = isWindows;

function isMac(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.OSX;
}

exports.isMac = isMac;

function isLinux(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.Linux;
}

exports.isLinux = isLinux;

function is64bit(info) {
  if (!info) {
    info = getLocal();
  }

  return info.architecture === Architecture.x64;
}

exports.is64bit = is64bit; // Match the platform string to the given OS info.

function matchPlatform(names, info = getInfo()) {
  if (info.type === OSType.Unknown) {
    return false;
  }

  names = names.trim();

  if (names === '') {
    return true;
  }

  for (let name of names.split('|')) {
    name = name.trim();

    if (matchOnePlatform(name, info)) {
      return true;
    }
  }

  return false;
}

exports.matchPlatform = matchPlatform;

function matchOnePlatform(name, info) {
  if (name === '' || name === '-') {
    return false;
  }

  const negate = name[0] === '-';

  if (negate) {
    name = name.replace(/^-/, '');
  }

  const [osType, distro] = identifyOS(name);

  if (osType === OSType.Unknown) {
    return false;
  }

  let result = false;

  if (osType === info.type) {
    result = true;

    if (osType === OSType.Linux) {
      if (distro !== OSDistro.Unknown) {
        result = distro === info.distro;
      }
    }
  }

  return negate ? !result : result;
}

function identifyOS(name) {
  name = name.toLowerCase();

  if (/win/.test(name)) {
    return [OSType.Windows, OSDistro.Unknown];
  } else if (/darwin|mac|osx/.test(name)) {
    return [OSType.OSX, OSDistro.Unknown];
  } else if (/linux/.test(name)) {
    return [OSType.Linux, OSDistro.Unknown];
  } // Try linux distros.


  const distro = getLinuxDistroFromName(name);

  if (distro !== OSDistro.Unknown) {
    return [OSType.Linux, distro];
  } else {
    return [OSType.Unknown, OSDistro.Unknown];
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBsYXRmb3JtLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZ2V0b3MiLCJyZXF1aXJlIiwib3MiLCJzZW12ZXIiLCJ2ZXJzaW9uXzEiLCJBcmNoaXRlY3R1cmUiLCJPU1R5cGUiLCJPU0Rpc3RybyIsImxvY2FsIiwiZ2V0TG9jYWwiLCJnZXRJbmZvIiwiZ2V0T1NUeXBlIiwicGxhdGZvcm0iLCJwcm9jZXNzIiwidGVzdCIsIldpbmRvd3MiLCJPU1giLCJMaW51eCIsIlVua25vd24iLCJJbmZvIiwiY29uc3RydWN0b3IiLCJ0eXBlIiwiYXJjaCIsInZlcnNpb24iLCJTZW1WZXIiLCJkaXN0cm8iLCJhcmNoaXRlY3R1cmUiLCJ4NjQiLCJ4ODYiLCJtYXRjaFBsYXRmb3JtIiwibmFtZXMiLCJnZXRBcmNoIiwiZ2V0UmVsZWFzZSIsInJlbGVhc2UiLCJnZXREaXN0cm8iLCJnZXRMaW51eERpc3RybyIsIm9zVHlwZSIsImdldERlZmF1bHRJbmZvIiwiZ2V0TGludXhJbmZvIiwicGFyc2VWZXJzaW9uIiwiZXhjIiwiaW5mbyIsImdldExpbnV4RGlzdHJvRnJvbU5hbWUiLCJkaXN0IiwibmFtZSIsInRvTG93ZXJDYXNlIiwiVWJ1bnR1IiwiRGViaWFuIiwiUkhFTCIsIkZlZG9yYSIsIkNlbnRPUyIsIlN1c2UiLCJBcmNoIiwiaXNXaW5kb3dzIiwiaXNNYWMiLCJpc0xpbnV4IiwiaXM2NGJpdCIsInRyaW0iLCJzcGxpdCIsIm1hdGNoT25lUGxhdGZvcm0iLCJuZWdhdGUiLCJyZXBsYWNlIiwiaWRlbnRpZnlPUyIsInJlc3VsdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQUVDLEVBQUFBLEtBQUssRUFBRTtBQUFULENBQTdDOztBQUNBLE1BQU1DLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNRSxNQUFNLEdBQUdGLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1HLFNBQVMsR0FBR0gsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBSUksWUFBSjs7QUFDQSxDQUFDLFVBQVVBLFlBQVYsRUFBd0I7QUFDckJBLEVBQUFBLFlBQVksQ0FBQ0EsWUFBWSxDQUFDLFNBQUQsQ0FBWixHQUEwQixDQUEzQixDQUFaLEdBQTRDLFNBQTVDO0FBQ0FBLEVBQUFBLFlBQVksQ0FBQ0EsWUFBWSxDQUFDLEtBQUQsQ0FBWixHQUFzQixDQUF2QixDQUFaLEdBQXdDLEtBQXhDO0FBQ0FBLEVBQUFBLFlBQVksQ0FBQ0EsWUFBWSxDQUFDLEtBQUQsQ0FBWixHQUFzQixDQUF2QixDQUFaLEdBQXdDLEtBQXhDO0FBQ0gsQ0FKRCxFQUlHQSxZQUFZLEdBQUdQLE9BQU8sQ0FBQ08sWUFBUixLQUF5QlAsT0FBTyxDQUFDTyxZQUFSLEdBQXVCLEVBQWhELENBSmxCOztBQUtBLElBQUlDLE1BQUo7O0FBQ0EsQ0FBQyxVQUFVQSxNQUFWLEVBQWtCO0FBQ2ZBLEVBQUFBLE1BQU0sQ0FBQ0EsTUFBTSxDQUFDLFNBQUQsQ0FBTixHQUFvQixDQUFyQixDQUFOLEdBQWdDLFNBQWhDO0FBQ0FBLEVBQUFBLE1BQU0sQ0FBQ0EsTUFBTSxDQUFDLFNBQUQsQ0FBTixHQUFvQixDQUFyQixDQUFOLEdBQWdDLFNBQWhDO0FBQ0FBLEVBQUFBLE1BQU0sQ0FBQ0EsTUFBTSxDQUFDLEtBQUQsQ0FBTixHQUFnQixDQUFqQixDQUFOLEdBQTRCLEtBQTVCO0FBQ0FBLEVBQUFBLE1BQU0sQ0FBQ0EsTUFBTSxDQUFDLE9BQUQsQ0FBTixHQUFrQixDQUFuQixDQUFOLEdBQThCLE9BQTlCO0FBQ0gsQ0FMRCxFQUtHQSxNQUFNLEdBQUdSLE9BQU8sQ0FBQ1EsTUFBUixLQUFtQlIsT0FBTyxDQUFDUSxNQUFSLEdBQWlCLEVBQXBDLENBTFo7O0FBTUEsSUFBSUMsUUFBSjs7QUFDQSxDQUFDLFVBQVVBLFFBQVYsRUFBb0I7QUFDakJBLEVBQUFBLFFBQVEsQ0FBQ0EsUUFBUSxDQUFDLFNBQUQsQ0FBUixHQUFzQixDQUF2QixDQUFSLEdBQW9DLFNBQXBDLENBRGlCLENBRWpCOztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxRQUFELENBQVIsR0FBcUIsQ0FBdEIsQ0FBUixHQUFtQyxRQUFuQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxRQUFELENBQVIsR0FBcUIsQ0FBdEIsQ0FBUixHQUFtQyxRQUFuQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxNQUFELENBQVIsR0FBbUIsQ0FBcEIsQ0FBUixHQUFpQyxNQUFqQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxRQUFELENBQVIsR0FBcUIsQ0FBdEIsQ0FBUixHQUFtQyxRQUFuQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxRQUFELENBQVIsR0FBcUIsQ0FBdEIsQ0FBUixHQUFtQyxRQUFuQyxDQVBpQixDQVFqQjtBQUNBOztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxNQUFELENBQVIsR0FBbUIsQ0FBcEIsQ0FBUixHQUFpQyxNQUFqQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxRQUFELENBQVIsR0FBcUIsQ0FBdEIsQ0FBUixHQUFtQyxRQUFuQztBQUNBQSxFQUFBQSxRQUFRLENBQUNBLFFBQVEsQ0FBQyxNQUFELENBQVIsR0FBbUIsQ0FBcEIsQ0FBUixHQUFpQyxNQUFqQztBQUNILENBYkQsRUFhR0EsUUFBUSxHQUFHVCxPQUFPLENBQUNTLFFBQVIsS0FBcUJULE9BQU8sQ0FBQ1MsUUFBUixHQUFtQixFQUF4QyxDQWJkOztBQWNBLElBQUlDLEtBQUo7O0FBQ0EsU0FBU0MsUUFBVCxHQUFvQjtBQUNoQixNQUFJLENBQUNELEtBQUwsRUFBWTtBQUNSQSxJQUFBQSxLQUFLLEdBQUdFLE9BQU8sRUFBZjtBQUNIOztBQUNELFNBQU9GLEtBQVA7QUFDSDs7QUFDRCxTQUFTRyxTQUFULENBQW1CQyxRQUFRLEdBQUdDLE9BQU8sQ0FBQ0QsUUFBdEMsRUFBZ0Q7QUFDNUMsTUFBSSxPQUFPRSxJQUFQLENBQVlGLFFBQVosQ0FBSixFQUEyQjtBQUN2QixXQUFPTixNQUFNLENBQUNTLE9BQWQ7QUFDSCxHQUZELE1BR0ssSUFBSSxVQUFVRCxJQUFWLENBQWVGLFFBQWYsQ0FBSixFQUE4QjtBQUMvQixXQUFPTixNQUFNLENBQUNVLEdBQWQ7QUFDSCxHQUZJLE1BR0EsSUFBSSxTQUFTRixJQUFULENBQWNGLFFBQWQsQ0FBSixFQUE2QjtBQUM5QixXQUFPTixNQUFNLENBQUNXLEtBQWQ7QUFDSCxHQUZJLE1BR0E7QUFDRCxXQUFPWCxNQUFNLENBQUNZLE9BQWQ7QUFDSDtBQUNKOztBQUNEcEIsT0FBTyxDQUFDYSxTQUFSLEdBQW9CQSxTQUFwQjs7QUFDQSxNQUFNUSxJQUFOLENBQVc7QUFDUEMsRUFBQUEsV0FBVyxDQUFDQyxJQUFELEVBQU9DLElBQUksR0FBR3BCLEVBQUUsQ0FBQ29CLElBQUgsRUFBZCxFQUNYO0FBQ0E7QUFDQUMsRUFBQUEsT0FBTyxHQUFHLElBQUlwQixNQUFNLENBQUNxQixNQUFYLENBQWtCLE9BQWxCLENBSEMsRUFHMkJDLE1BQU0sR0FBR2xCLFFBQVEsQ0FBQ1csT0FIN0MsRUFHc0Q7QUFDN0QsU0FBS0csSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0UsTUFBTCxHQUFjQSxNQUFkO0FBQ0g7O0FBQ0QsTUFBSUMsWUFBSixHQUFtQjtBQUNmLFdBQU8sS0FBS0osSUFBTCxLQUFjLEtBQWQsR0FBc0JqQixZQUFZLENBQUNzQixHQUFuQyxHQUF5Q3RCLFlBQVksQ0FBQ3VCLEdBQTdEO0FBQ0g7O0FBQ0RDLEVBQUFBLGFBQWEsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2pCLFdBQU9ELGFBQWEsQ0FBQ0MsS0FBRCxFQUFRLElBQVIsQ0FBcEI7QUFDSDs7QUFmTTs7QUFpQlhoQyxPQUFPLENBQUNxQixJQUFSLEdBQWVBLElBQWY7O0FBQ0EsU0FBU1QsT0FBVCxDQUFpQnFCLE9BQU8sR0FBRzdCLEVBQUUsQ0FBQ29CLElBQTlCLEVBQW9DVSxVQUFVLEdBQUc5QixFQUFFLENBQUMrQixPQUFwRCxFQUE2REMsU0FBUyxHQUFHQyxjQUF6RSxFQUF5RnZCLFFBQXpGLEVBQW1HO0FBQy9GLFFBQU13QixNQUFNLEdBQUd6QixTQUFTLENBQUNDLFFBQUQsQ0FBeEI7QUFDQSxRQUFNVSxJQUFJLEdBQUdTLE9BQU8sRUFBcEI7O0FBQ0EsVUFBUUssTUFBUjtBQUNJLFNBQUs5QixNQUFNLENBQUNTLE9BQVo7QUFDSSxhQUFPc0IsY0FBYyxDQUFDRCxNQUFELEVBQVNkLElBQVQsRUFBZVUsVUFBZixDQUFyQjs7QUFDSixTQUFLMUIsTUFBTSxDQUFDVSxHQUFaO0FBQ0ksYUFBT3FCLGNBQWMsQ0FBQ0QsTUFBRCxFQUFTZCxJQUFULEVBQWVVLFVBQWYsQ0FBckI7O0FBQ0osU0FBSzFCLE1BQU0sQ0FBQ1csS0FBWjtBQUNJLGFBQU9xQixZQUFZLENBQUNoQixJQUFELEVBQU9ZLFNBQVAsQ0FBbkI7O0FBQ0o7QUFDSSxhQUFPLElBQUlmLElBQUosQ0FBU2IsTUFBTSxDQUFDWSxPQUFoQixFQUF5QkksSUFBekIsQ0FBUDtBQVJSO0FBVUg7O0FBQ0R4QixPQUFPLENBQUNZLE9BQVIsR0FBa0JBLE9BQWxCOztBQUNBLFNBQVMyQixjQUFULENBQXdCRCxNQUF4QixFQUFnQ2QsSUFBaEMsRUFBc0NVLFVBQXRDLEVBQWtEO0FBQzlDLFFBQU1ULE9BQU8sR0FBR25CLFNBQVMsQ0FBQ21DLFlBQVYsQ0FBdUJQLFVBQVUsRUFBakMsQ0FBaEI7QUFDQSxTQUFPLElBQUliLElBQUosQ0FBU2lCLE1BQVQsRUFBaUJkLElBQWpCLEVBQXVCQyxPQUF2QixDQUFQO0FBQ0g7O0FBQ0QsU0FBU2UsWUFBVCxDQUFzQmhCLElBQXRCLEVBQTRCWSxTQUE1QixFQUF1QztBQUNuQyxRQUFNLENBQUNULE1BQUQsRUFBU0YsT0FBVCxJQUFvQlcsU0FBUyxFQUFuQztBQUNBLFNBQU8sSUFBSWYsSUFBSixDQUFTYixNQUFNLENBQUNXLEtBQWhCLEVBQXVCSyxJQUF2QixFQUE2QkMsT0FBN0IsRUFBc0NFLE1BQXRDLENBQVA7QUFDSDs7QUFDRCxTQUFTVSxjQUFULEdBQTBCO0FBQ3RCLE1BQUlWLE1BQU0sR0FBR2xCLFFBQVEsQ0FBQ1csT0FBdEI7QUFDQSxNQUFJSyxPQUFPLEdBQUcsSUFBSXBCLE1BQU0sQ0FBQ3FCLE1BQVgsQ0FBa0IsT0FBbEIsQ0FBZDtBQUNBeEIsRUFBQUEsS0FBSyxDQUFDLENBQUN3QyxHQUFELEVBQU1DLElBQU4sS0FBZTtBQUNqQixRQUFJRCxHQUFKLEVBQVM7QUFDTCxZQUFNQSxHQUFOO0FBQ0g7O0FBQ0RmLElBQUFBLE1BQU0sR0FBR2lCLHNCQUFzQixDQUFDRCxJQUFJLENBQUNFLElBQU4sQ0FBL0I7QUFDQXBCLElBQUFBLE9BQU8sR0FBR25CLFNBQVMsQ0FBQ21DLFlBQVYsQ0FBdUJFLElBQUksQ0FBQ1IsT0FBNUIsQ0FBVjtBQUNILEdBTkksQ0FBTDtBQU9BLFNBQU8sQ0FBQ1IsTUFBRCxFQUFTRixPQUFULENBQVA7QUFDSDs7QUFDRCxTQUFTbUIsc0JBQVQsQ0FBZ0NFLElBQWhDLEVBQXNDO0FBQ2xDQSxFQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0MsV0FBTCxFQUFQLENBRGtDLENBRWxDOztBQUNBLE1BQUksU0FBUy9CLElBQVQsQ0FBYzhCLElBQWQsQ0FBSixFQUF5QjtBQUNyQixXQUFPckMsUUFBUSxDQUFDdUMsTUFBaEI7QUFDSCxHQUZELE1BR0ssSUFBSSxTQUFTaEMsSUFBVCxDQUFjOEIsSUFBZCxDQUFKLEVBQXlCO0FBQzFCLFdBQU9yQyxRQUFRLENBQUN3QyxNQUFoQjtBQUNILEdBRkksTUFHQSxJQUFJLE9BQU9qQyxJQUFQLENBQVk4QixJQUFaLEtBQXFCLFVBQVU5QixJQUFWLENBQWU4QixJQUFmLENBQXpCLEVBQStDO0FBQ2hELFdBQU9yQyxRQUFRLENBQUN5QyxJQUFoQjtBQUNILEdBRkksTUFHQSxJQUFJLFNBQVNsQyxJQUFULENBQWM4QixJQUFkLENBQUosRUFBeUI7QUFDMUIsV0FBT3JDLFFBQVEsQ0FBQzBDLE1BQWhCO0FBQ0gsR0FGSSxNQUdBLElBQUksU0FBU25DLElBQVQsQ0FBYzhCLElBQWQsQ0FBSixFQUF5QjtBQUMxQixXQUFPckMsUUFBUSxDQUFDMkMsTUFBaEI7QUFDSCxHQWpCaUMsQ0FrQmxDOzs7QUFDQSxNQUFJLE9BQU9wQyxJQUFQLENBQVk4QixJQUFaLENBQUosRUFBdUI7QUFDbkIsV0FBT3JDLFFBQVEsQ0FBQzRDLElBQWhCO0FBQ0gsR0FGRCxNQUdLLElBQUksU0FBU3JDLElBQVQsQ0FBYzhCLElBQWQsQ0FBSixFQUF5QjtBQUMxQixXQUFPckMsUUFBUSxDQUFDNEMsSUFBaEI7QUFDSCxHQUZJLE1BR0EsSUFBSSxPQUFPckMsSUFBUCxDQUFZOEIsSUFBWixDQUFKLEVBQXVCO0FBQ3hCLFdBQU9yQyxRQUFRLENBQUM2QyxJQUFoQjtBQUNILEdBRkksTUFHQTtBQUNELFdBQU83QyxRQUFRLENBQUNXLE9BQWhCO0FBQ0g7QUFDSixDLENBQ0Q7OztBQUNBLFNBQVNtQyxTQUFULENBQW1CWixJQUFuQixFQUF5QjtBQUNyQixNQUFJLENBQUNBLElBQUwsRUFBVztBQUNQQSxJQUFBQSxJQUFJLEdBQUdoQyxRQUFRLEVBQWY7QUFDSDs7QUFDRCxTQUFPZ0MsSUFBSSxDQUFDcEIsSUFBTCxLQUFjZixNQUFNLENBQUNTLE9BQTVCO0FBQ0g7O0FBQ0RqQixPQUFPLENBQUN1RCxTQUFSLEdBQW9CQSxTQUFwQjs7QUFDQSxTQUFTQyxLQUFULENBQWViLElBQWYsRUFBcUI7QUFDakIsTUFBSSxDQUFDQSxJQUFMLEVBQVc7QUFDUEEsSUFBQUEsSUFBSSxHQUFHaEMsUUFBUSxFQUFmO0FBQ0g7O0FBQ0QsU0FBT2dDLElBQUksQ0FBQ3BCLElBQUwsS0FBY2YsTUFBTSxDQUFDVSxHQUE1QjtBQUNIOztBQUNEbEIsT0FBTyxDQUFDd0QsS0FBUixHQUFnQkEsS0FBaEI7O0FBQ0EsU0FBU0MsT0FBVCxDQUFpQmQsSUFBakIsRUFBdUI7QUFDbkIsTUFBSSxDQUFDQSxJQUFMLEVBQVc7QUFDUEEsSUFBQUEsSUFBSSxHQUFHaEMsUUFBUSxFQUFmO0FBQ0g7O0FBQ0QsU0FBT2dDLElBQUksQ0FBQ3BCLElBQUwsS0FBY2YsTUFBTSxDQUFDVyxLQUE1QjtBQUNIOztBQUNEbkIsT0FBTyxDQUFDeUQsT0FBUixHQUFrQkEsT0FBbEI7O0FBQ0EsU0FBU0MsT0FBVCxDQUFpQmYsSUFBakIsRUFBdUI7QUFDbkIsTUFBSSxDQUFDQSxJQUFMLEVBQVc7QUFDUEEsSUFBQUEsSUFBSSxHQUFHaEMsUUFBUSxFQUFmO0FBQ0g7O0FBQ0QsU0FBT2dDLElBQUksQ0FBQ2YsWUFBTCxLQUFzQnJCLFlBQVksQ0FBQ3NCLEdBQTFDO0FBQ0g7O0FBQ0Q3QixPQUFPLENBQUMwRCxPQUFSLEdBQWtCQSxPQUFsQixDLENBQ0E7O0FBQ0EsU0FBUzNCLGFBQVQsQ0FBdUJDLEtBQXZCLEVBQThCVyxJQUFJLEdBQUcvQixPQUFPLEVBQTVDLEVBQWdEO0FBQzVDLE1BQUkrQixJQUFJLENBQUNwQixJQUFMLEtBQWNmLE1BQU0sQ0FBQ1ksT0FBekIsRUFBa0M7QUFDOUIsV0FBTyxLQUFQO0FBQ0g7O0FBQ0RZLEVBQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDMkIsSUFBTixFQUFSOztBQUNBLE1BQUkzQixLQUFLLEtBQUssRUFBZCxFQUFrQjtBQUNkLFdBQU8sSUFBUDtBQUNIOztBQUNELE9BQUssSUFBSWMsSUFBVCxJQUFpQmQsS0FBSyxDQUFDNEIsS0FBTixDQUFZLEdBQVosQ0FBakIsRUFBbUM7QUFDL0JkLElBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDYSxJQUFMLEVBQVA7O0FBQ0EsUUFBSUUsZ0JBQWdCLENBQUNmLElBQUQsRUFBT0gsSUFBUCxDQUFwQixFQUFrQztBQUM5QixhQUFPLElBQVA7QUFDSDtBQUNKOztBQUNELFNBQU8sS0FBUDtBQUNIOztBQUNEM0MsT0FBTyxDQUFDK0IsYUFBUixHQUF3QkEsYUFBeEI7O0FBQ0EsU0FBUzhCLGdCQUFULENBQTBCZixJQUExQixFQUFnQ0gsSUFBaEMsRUFBc0M7QUFDbEMsTUFBSUcsSUFBSSxLQUFLLEVBQVQsSUFBZUEsSUFBSSxLQUFLLEdBQTVCLEVBQWlDO0FBQzdCLFdBQU8sS0FBUDtBQUNIOztBQUNELFFBQU1nQixNQUFNLEdBQUdoQixJQUFJLENBQUMsQ0FBRCxDQUFKLEtBQVksR0FBM0I7O0FBQ0EsTUFBSWdCLE1BQUosRUFBWTtBQUNSaEIsSUFBQUEsSUFBSSxHQUFHQSxJQUFJLENBQUNpQixPQUFMLENBQWEsSUFBYixFQUFtQixFQUFuQixDQUFQO0FBQ0g7O0FBQ0QsUUFBTSxDQUFDekIsTUFBRCxFQUFTWCxNQUFULElBQW1CcUMsVUFBVSxDQUFDbEIsSUFBRCxDQUFuQzs7QUFDQSxNQUFJUixNQUFNLEtBQUs5QixNQUFNLENBQUNZLE9BQXRCLEVBQStCO0FBQzNCLFdBQU8sS0FBUDtBQUNIOztBQUNELE1BQUk2QyxNQUFNLEdBQUcsS0FBYjs7QUFDQSxNQUFJM0IsTUFBTSxLQUFLSyxJQUFJLENBQUNwQixJQUFwQixFQUEwQjtBQUN0QjBDLElBQUFBLE1BQU0sR0FBRyxJQUFUOztBQUNBLFFBQUkzQixNQUFNLEtBQUs5QixNQUFNLENBQUNXLEtBQXRCLEVBQTZCO0FBQ3pCLFVBQUlRLE1BQU0sS0FBS2xCLFFBQVEsQ0FBQ1csT0FBeEIsRUFBaUM7QUFDN0I2QyxRQUFBQSxNQUFNLEdBQUd0QyxNQUFNLEtBQUtnQixJQUFJLENBQUNoQixNQUF6QjtBQUNIO0FBQ0o7QUFDSjs7QUFDRCxTQUFPbUMsTUFBTSxHQUFHLENBQUNHLE1BQUosR0FBYUEsTUFBMUI7QUFDSDs7QUFDRCxTQUFTRCxVQUFULENBQW9CbEIsSUFBcEIsRUFBMEI7QUFDdEJBLEVBQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDQyxXQUFMLEVBQVA7O0FBQ0EsTUFBSSxNQUFNL0IsSUFBTixDQUFXOEIsSUFBWCxDQUFKLEVBQXNCO0FBQ2xCLFdBQU8sQ0FBQ3RDLE1BQU0sQ0FBQ1MsT0FBUixFQUFpQlIsUUFBUSxDQUFDVyxPQUExQixDQUFQO0FBQ0gsR0FGRCxNQUdLLElBQUksaUJBQWlCSixJQUFqQixDQUFzQjhCLElBQXRCLENBQUosRUFBaUM7QUFDbEMsV0FBTyxDQUFDdEMsTUFBTSxDQUFDVSxHQUFSLEVBQWFULFFBQVEsQ0FBQ1csT0FBdEIsQ0FBUDtBQUNILEdBRkksTUFHQSxJQUFJLFFBQVFKLElBQVIsQ0FBYThCLElBQWIsQ0FBSixFQUF3QjtBQUN6QixXQUFPLENBQUN0QyxNQUFNLENBQUNXLEtBQVIsRUFBZVYsUUFBUSxDQUFDVyxPQUF4QixDQUFQO0FBQ0gsR0FWcUIsQ0FXdEI7OztBQUNBLFFBQU1PLE1BQU0sR0FBR2lCLHNCQUFzQixDQUFDRSxJQUFELENBQXJDOztBQUNBLE1BQUluQixNQUFNLEtBQUtsQixRQUFRLENBQUNXLE9BQXhCLEVBQWlDO0FBQzdCLFdBQU8sQ0FBQ1osTUFBTSxDQUFDVyxLQUFSLEVBQWVRLE1BQWYsQ0FBUDtBQUNILEdBRkQsTUFHSztBQUNELFdBQU8sQ0FBQ25CLE1BQU0sQ0FBQ1ksT0FBUixFQUFpQlgsUUFBUSxDQUFDVyxPQUExQixDQUFQO0FBQ0g7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuJ3VzZSBzdHJpY3QnO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgZ2V0b3MgPSByZXF1aXJlKFwiZ2V0b3NcIik7XG5jb25zdCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcbmNvbnN0IHNlbXZlciA9IHJlcXVpcmUoXCJzZW12ZXJcIik7XG5jb25zdCB2ZXJzaW9uXzEgPSByZXF1aXJlKFwiLi92ZXJzaW9uXCIpO1xudmFyIEFyY2hpdGVjdHVyZTtcbihmdW5jdGlvbiAoQXJjaGl0ZWN0dXJlKSB7XG4gICAgQXJjaGl0ZWN0dXJlW0FyY2hpdGVjdHVyZVtcIlVua25vd25cIl0gPSAxXSA9IFwiVW5rbm93blwiO1xuICAgIEFyY2hpdGVjdHVyZVtBcmNoaXRlY3R1cmVbXCJ4ODZcIl0gPSAyXSA9IFwieDg2XCI7XG4gICAgQXJjaGl0ZWN0dXJlW0FyY2hpdGVjdHVyZVtcIng2NFwiXSA9IDNdID0gXCJ4NjRcIjtcbn0pKEFyY2hpdGVjdHVyZSA9IGV4cG9ydHMuQXJjaGl0ZWN0dXJlIHx8IChleHBvcnRzLkFyY2hpdGVjdHVyZSA9IHt9KSk7XG52YXIgT1NUeXBlO1xuKGZ1bmN0aW9uIChPU1R5cGUpIHtcbiAgICBPU1R5cGVbT1NUeXBlW1wiVW5rbm93blwiXSA9IDBdID0gXCJVbmtub3duXCI7XG4gICAgT1NUeXBlW09TVHlwZVtcIldpbmRvd3NcIl0gPSAxXSA9IFwiV2luZG93c1wiO1xuICAgIE9TVHlwZVtPU1R5cGVbXCJPU1hcIl0gPSAyXSA9IFwiT1NYXCI7XG4gICAgT1NUeXBlW09TVHlwZVtcIkxpbnV4XCJdID0gM10gPSBcIkxpbnV4XCI7XG59KShPU1R5cGUgPSBleHBvcnRzLk9TVHlwZSB8fCAoZXhwb3J0cy5PU1R5cGUgPSB7fSkpO1xudmFyIE9TRGlzdHJvO1xuKGZ1bmN0aW9uIChPU0Rpc3Rybykge1xuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiVW5rbm93blwiXSA9IDBdID0gXCJVbmtub3duXCI7XG4gICAgLy8gbGludXg6XG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJVYnVudHVcIl0gPSAxXSA9IFwiVWJ1bnR1XCI7XG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJEZWJpYW5cIl0gPSAyXSA9IFwiRGViaWFuXCI7XG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJSSEVMXCJdID0gM10gPSBcIlJIRUxcIjtcbiAgICBPU0Rpc3Ryb1tPU0Rpc3Ryb1tcIkZlZG9yYVwiXSA9IDRdID0gXCJGZWRvcmFcIjtcbiAgICBPU0Rpc3Ryb1tPU0Rpc3Ryb1tcIkNlbnRPU1wiXSA9IDVdID0gXCJDZW50T1NcIjtcbiAgICAvLyBUaGUgcmVtYWluZGVyIGFyZW4ndCBvZmZpY2lhbGx5IHN1cHBvcnRlZC5cbiAgICAvLyBTZWU6IGh0dHBzOi8vY29kZS52aXN1YWxzdHVkaW8uY29tL2RvY3Mvc3VwcG9ydGluZy9yZXF1aXJlbWVudHNcbiAgICBPU0Rpc3Ryb1tPU0Rpc3Ryb1tcIlN1c2VcIl0gPSA2XSA9IFwiU3VzZVwiO1xuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiR2VudG9vXCJdID0gN10gPSBcIkdlbnRvb1wiO1xuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiQXJjaFwiXSA9IDhdID0gXCJBcmNoXCI7XG59KShPU0Rpc3RybyA9IGV4cG9ydHMuT1NEaXN0cm8gfHwgKGV4cG9ydHMuT1NEaXN0cm8gPSB7fSkpO1xubGV0IGxvY2FsO1xuZnVuY3Rpb24gZ2V0TG9jYWwoKSB7XG4gICAgaWYgKCFsb2NhbCkge1xuICAgICAgICBsb2NhbCA9IGdldEluZm8oKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvY2FsO1xufVxuZnVuY3Rpb24gZ2V0T1NUeXBlKHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybSkge1xuICAgIGlmICgvXndpbi8udGVzdChwbGF0Zm9ybSkpIHtcbiAgICAgICAgcmV0dXJuIE9TVHlwZS5XaW5kb3dzO1xuICAgIH1cbiAgICBlbHNlIGlmICgvXmRhcndpbi8udGVzdChwbGF0Zm9ybSkpIHtcbiAgICAgICAgcmV0dXJuIE9TVHlwZS5PU1g7XG4gICAgfVxuICAgIGVsc2UgaWYgKC9ebGludXgvLnRlc3QocGxhdGZvcm0pKSB7XG4gICAgICAgIHJldHVybiBPU1R5cGUuTGludXg7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gT1NUeXBlLlVua25vd247XG4gICAgfVxufVxuZXhwb3J0cy5nZXRPU1R5cGUgPSBnZXRPU1R5cGU7XG5jbGFzcyBJbmZvIHtcbiAgICBjb25zdHJ1Y3Rvcih0eXBlLCBhcmNoID0gb3MuYXJjaCgpLCBcbiAgICAvLyBTZWU6XG4gICAgLy8gIGh0dHBzOi8vZ2l0aHViLmNvbS9EZWZpbml0ZWx5VHlwZWQvRGVmaW5pdGVseVR5cGVkL2Jsb2IvbWFzdGVyL3R5cGVzL3NlbXZlci9pbmRleC5kLnRzI0wxNTJcbiAgICB2ZXJzaW9uID0gbmV3IHNlbXZlci5TZW1WZXIoJzAuMC4wJyksIGRpc3RybyA9IE9TRGlzdHJvLlVua25vd24pIHtcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5hcmNoID0gYXJjaDtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgICAgdGhpcy5kaXN0cm8gPSBkaXN0cm87XG4gICAgfVxuICAgIGdldCBhcmNoaXRlY3R1cmUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyY2ggPT09ICd4NjQnID8gQXJjaGl0ZWN0dXJlLng2NCA6IEFyY2hpdGVjdHVyZS54ODY7XG4gICAgfVxuICAgIG1hdGNoUGxhdGZvcm0obmFtZXMpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoUGxhdGZvcm0obmFtZXMsIHRoaXMpO1xuICAgIH1cbn1cbmV4cG9ydHMuSW5mbyA9IEluZm87XG5mdW5jdGlvbiBnZXRJbmZvKGdldEFyY2ggPSBvcy5hcmNoLCBnZXRSZWxlYXNlID0gb3MucmVsZWFzZSwgZ2V0RGlzdHJvID0gZ2V0TGludXhEaXN0cm8sIHBsYXRmb3JtKSB7XG4gICAgY29uc3Qgb3NUeXBlID0gZ2V0T1NUeXBlKHBsYXRmb3JtKTtcbiAgICBjb25zdCBhcmNoID0gZ2V0QXJjaCgpO1xuICAgIHN3aXRjaCAob3NUeXBlKSB7XG4gICAgICAgIGNhc2UgT1NUeXBlLldpbmRvd3M6XG4gICAgICAgICAgICByZXR1cm4gZ2V0RGVmYXVsdEluZm8ob3NUeXBlLCBhcmNoLCBnZXRSZWxlYXNlKTtcbiAgICAgICAgY2FzZSBPU1R5cGUuT1NYOlxuICAgICAgICAgICAgcmV0dXJuIGdldERlZmF1bHRJbmZvKG9zVHlwZSwgYXJjaCwgZ2V0UmVsZWFzZSk7XG4gICAgICAgIGNhc2UgT1NUeXBlLkxpbnV4OlxuICAgICAgICAgICAgcmV0dXJuIGdldExpbnV4SW5mbyhhcmNoLCBnZXREaXN0cm8pO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIG5ldyBJbmZvKE9TVHlwZS5Vbmtub3duLCBhcmNoKTtcbiAgICB9XG59XG5leHBvcnRzLmdldEluZm8gPSBnZXRJbmZvO1xuZnVuY3Rpb24gZ2V0RGVmYXVsdEluZm8ob3NUeXBlLCBhcmNoLCBnZXRSZWxlYXNlKSB7XG4gICAgY29uc3QgdmVyc2lvbiA9IHZlcnNpb25fMS5wYXJzZVZlcnNpb24oZ2V0UmVsZWFzZSgpKTtcbiAgICByZXR1cm4gbmV3IEluZm8ob3NUeXBlLCBhcmNoLCB2ZXJzaW9uKTtcbn1cbmZ1bmN0aW9uIGdldExpbnV4SW5mbyhhcmNoLCBnZXREaXN0cm8pIHtcbiAgICBjb25zdCBbZGlzdHJvLCB2ZXJzaW9uXSA9IGdldERpc3RybygpO1xuICAgIHJldHVybiBuZXcgSW5mbyhPU1R5cGUuTGludXgsIGFyY2gsIHZlcnNpb24sIGRpc3Rybyk7XG59XG5mdW5jdGlvbiBnZXRMaW51eERpc3RybygpIHtcbiAgICBsZXQgZGlzdHJvID0gT1NEaXN0cm8uVW5rbm93bjtcbiAgICBsZXQgdmVyc2lvbiA9IG5ldyBzZW12ZXIuU2VtVmVyKCcwLjAuMCcpO1xuICAgIGdldG9zKChleGMsIGluZm8pID0+IHtcbiAgICAgICAgaWYgKGV4Yykge1xuICAgICAgICAgICAgdGhyb3cgZXhjO1xuICAgICAgICB9XG4gICAgICAgIGRpc3RybyA9IGdldExpbnV4RGlzdHJvRnJvbU5hbWUoaW5mby5kaXN0KTtcbiAgICAgICAgdmVyc2lvbiA9IHZlcnNpb25fMS5wYXJzZVZlcnNpb24oaW5mby5yZWxlYXNlKTtcbiAgICB9KTtcbiAgICByZXR1cm4gW2Rpc3RybywgdmVyc2lvbl07XG59XG5mdW5jdGlvbiBnZXRMaW51eERpc3Ryb0Zyb21OYW1lKG5hbWUpIHtcbiAgICBuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20venlnYS9vcy1yZWxlYXNlLXpvby5cbiAgICBpZiAoL3VidW50dS8udGVzdChuYW1lKSkge1xuICAgICAgICByZXR1cm4gT1NEaXN0cm8uVWJ1bnR1O1xuICAgIH1cbiAgICBlbHNlIGlmICgvZGViaWFuLy50ZXN0KG5hbWUpKSB7XG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5EZWJpYW47XG4gICAgfVxuICAgIGVsc2UgaWYgKC9yaGVsLy50ZXN0KG5hbWUpIHx8IC9yZWQgaGF0Ly50ZXN0KG5hbWUpKSB7XG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5SSEVMO1xuICAgIH1cbiAgICBlbHNlIGlmICgvZmVkb3JhLy50ZXN0KG5hbWUpKSB7XG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5GZWRvcmE7XG4gICAgfVxuICAgIGVsc2UgaWYgKC9jZW50b3MvLnRlc3QobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLkNlbnRPUztcbiAgICB9XG4gICAgLy8gVGhlIHJlbWFpbmRlciBhcmVuJ3Qgb2ZmaWNpYWxseSBzdXBwb3J0ZWQgYnkgVlMgQ29kZS5cbiAgICBpZiAoL3N1c2UvLnRlc3QobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLlN1c2U7XG4gICAgfVxuICAgIGVsc2UgaWYgKC9nZW50b28vLnRlc3QobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLlN1c2U7XG4gICAgfVxuICAgIGVsc2UgaWYgKC9hcmNoLy50ZXN0KG5hbWUpKSB7XG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5BcmNoO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLlVua25vd247XG4gICAgfVxufVxuLy8gaGVscGVyc1xuZnVuY3Rpb24gaXNXaW5kb3dzKGluZm8pIHtcbiAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgaW5mbyA9IGdldExvY2FsKCk7XG4gICAgfVxuICAgIHJldHVybiBpbmZvLnR5cGUgPT09IE9TVHlwZS5XaW5kb3dzO1xufVxuZXhwb3J0cy5pc1dpbmRvd3MgPSBpc1dpbmRvd3M7XG5mdW5jdGlvbiBpc01hYyhpbmZvKSB7XG4gICAgaWYgKCFpbmZvKSB7XG4gICAgICAgIGluZm8gPSBnZXRMb2NhbCgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5mby50eXBlID09PSBPU1R5cGUuT1NYO1xufVxuZXhwb3J0cy5pc01hYyA9IGlzTWFjO1xuZnVuY3Rpb24gaXNMaW51eChpbmZvKSB7XG4gICAgaWYgKCFpbmZvKSB7XG4gICAgICAgIGluZm8gPSBnZXRMb2NhbCgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5mby50eXBlID09PSBPU1R5cGUuTGludXg7XG59XG5leHBvcnRzLmlzTGludXggPSBpc0xpbnV4O1xuZnVuY3Rpb24gaXM2NGJpdChpbmZvKSB7XG4gICAgaWYgKCFpbmZvKSB7XG4gICAgICAgIGluZm8gPSBnZXRMb2NhbCgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5mby5hcmNoaXRlY3R1cmUgPT09IEFyY2hpdGVjdHVyZS54NjQ7XG59XG5leHBvcnRzLmlzNjRiaXQgPSBpczY0Yml0O1xuLy8gTWF0Y2ggdGhlIHBsYXRmb3JtIHN0cmluZyB0byB0aGUgZ2l2ZW4gT1MgaW5mby5cbmZ1bmN0aW9uIG1hdGNoUGxhdGZvcm0obmFtZXMsIGluZm8gPSBnZXRJbmZvKCkpIHtcbiAgICBpZiAoaW5mby50eXBlID09PSBPU1R5cGUuVW5rbm93bikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIG5hbWVzID0gbmFtZXMudHJpbSgpO1xuICAgIGlmIChuYW1lcyA9PT0gJycpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGZvciAobGV0IG5hbWUgb2YgbmFtZXMuc3BsaXQoJ3wnKSkge1xuICAgICAgICBuYW1lID0gbmFtZS50cmltKCk7XG4gICAgICAgIGlmIChtYXRjaE9uZVBsYXRmb3JtKG5hbWUsIGluZm8pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5leHBvcnRzLm1hdGNoUGxhdGZvcm0gPSBtYXRjaFBsYXRmb3JtO1xuZnVuY3Rpb24gbWF0Y2hPbmVQbGF0Zm9ybShuYW1lLCBpbmZvKSB7XG4gICAgaWYgKG5hbWUgPT09ICcnIHx8IG5hbWUgPT09ICctJykge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IG5lZ2F0ZSA9IG5hbWVbMF0gPT09ICctJztcbiAgICBpZiAobmVnYXRlKSB7XG4gICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL14tLywgJycpO1xuICAgIH1cbiAgICBjb25zdCBbb3NUeXBlLCBkaXN0cm9dID0gaWRlbnRpZnlPUyhuYW1lKTtcbiAgICBpZiAob3NUeXBlID09PSBPU1R5cGUuVW5rbm93bikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGxldCByZXN1bHQgPSBmYWxzZTtcbiAgICBpZiAob3NUeXBlID09PSBpbmZvLnR5cGUpIHtcbiAgICAgICAgcmVzdWx0ID0gdHJ1ZTtcbiAgICAgICAgaWYgKG9zVHlwZSA9PT0gT1NUeXBlLkxpbnV4KSB7XG4gICAgICAgICAgICBpZiAoZGlzdHJvICE9PSBPU0Rpc3Ryby5Vbmtub3duKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZGlzdHJvID09PSBpbmZvLmRpc3RybztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmVnYXRlID8gIXJlc3VsdCA6IHJlc3VsdDtcbn1cbmZ1bmN0aW9uIGlkZW50aWZ5T1MobmFtZSkge1xuICAgIG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKC93aW4vLnRlc3QobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuV2luZG93cywgT1NEaXN0cm8uVW5rbm93bl07XG4gICAgfVxuICAgIGVsc2UgaWYgKC9kYXJ3aW58bWFjfG9zeC8udGVzdChuYW1lKSkge1xuICAgICAgICByZXR1cm4gW09TVHlwZS5PU1gsIE9TRGlzdHJvLlVua25vd25dO1xuICAgIH1cbiAgICBlbHNlIGlmICgvbGludXgvLnRlc3QobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuTGludXgsIE9TRGlzdHJvLlVua25vd25dO1xuICAgIH1cbiAgICAvLyBUcnkgbGludXggZGlzdHJvcy5cbiAgICBjb25zdCBkaXN0cm8gPSBnZXRMaW51eERpc3Ryb0Zyb21OYW1lKG5hbWUpO1xuICAgIGlmIChkaXN0cm8gIT09IE9TRGlzdHJvLlVua25vd24pIHtcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuTGludXgsIGRpc3Ryb107XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gW09TVHlwZS5Vbmtub3duLCBPU0Rpc3Ryby5Vbmtub3duXTtcbiAgICB9XG59XG4vLyMgc291cmNlTWFwcGluZ1VSTD1wbGF0Zm9ybS5qcy5tYXAiXX0=