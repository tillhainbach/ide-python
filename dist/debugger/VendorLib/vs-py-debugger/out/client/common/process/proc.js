"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any

const child_process_1 = require("child_process");

const Observable_1 = require("rxjs/Observable");

const async_1 = require("../utils/async");

const constants_1 = require("./constants");

const types_1 = require("./types");

class ProcessService {
  constructor(decoder, env) {
    this.decoder = decoder;
    this.env = env;
  }

  static isAlive(pid) {
    try {
      process.kill(pid, 0);
      return true;
    } catch (_a) {
      return false;
    }
  }

  static kill(pid) {
    // tslint:disable-next-line:no-require-imports
    const killProcessTree = require('tree-kill');

    try {
      killProcessTree(pid);
    } catch (_a) {// Ignore.
    }
  }

  execObservable(file, args, options = {}) {
    const encoding = options.encoding = typeof options.encoding === 'string' && options.encoding.length > 0 ? options.encoding : constants_1.DEFAULT_ENCODING;
    delete options.encoding;
    const spawnOptions = Object.assign({}, options);

    if (!spawnOptions.env || Object.keys(spawnOptions).length === 0) {
      const env = this.env ? this.env : process.env;
      spawnOptions.env = Object.assign({}, env);
    } // Always ensure we have unbuffered output.


    spawnOptions.env.PYTHONUNBUFFERED = '1';

    if (!spawnOptions.env.PYTHONIOENCODING) {
      spawnOptions.env.PYTHONIOENCODING = 'utf-8';
    }

    const proc = child_process_1.spawn(file, args, spawnOptions);
    let procExited = false;
    const output = new Observable_1.Observable(subscriber => {
      const disposables = [];

      const on = (ee, name, fn) => {
        ee.on(name, fn);
        disposables.push({
          dispose: () => ee.removeListener(name, fn)
        });
      };

      if (options.token) {
        disposables.push(options.token.onCancellationRequested(() => {
          if (!procExited && !proc.killed) {
            proc.kill();
            procExited = true;
          }
        }));
      }

      const sendOutput = (source, data) => {
        const out = this.decoder.decode([data], encoding);

        if (source === 'stderr' && options.throwOnStdErr) {
          subscriber.error(new types_1.StdErrError(out));
        } else {
          subscriber.next({
            source,
            out: out
          });
        }
      };

      on(proc.stdout, 'data', data => sendOutput('stdout', data));
      on(proc.stderr, 'data', data => sendOutput('stderr', data));
      proc.once('close', () => {
        procExited = true;
        subscriber.complete();
        disposables.forEach(disposable => disposable.dispose());
      });
      proc.once('error', ex => {
        procExited = true;
        subscriber.error(ex);
        disposables.forEach(disposable => disposable.dispose());
      });
    });
    return {
      proc,
      out: output
    };
  }

  exec(file, args, options = {}) {
    const encoding = options.encoding = typeof options.encoding === 'string' && options.encoding.length > 0 ? options.encoding : constants_1.DEFAULT_ENCODING;
    delete options.encoding;
    const spawnOptions = Object.assign({}, options);

    if (!spawnOptions.env || Object.keys(spawnOptions).length === 0) {
      const env = this.env ? this.env : process.env;
      spawnOptions.env = Object.assign({}, env);
    } // Always ensure we have unbuffered output.


    spawnOptions.env.PYTHONUNBUFFERED = '1';

    if (!spawnOptions.env.PYTHONIOENCODING) {
      spawnOptions.env.PYTHONIOENCODING = 'utf-8';
    }

    const proc = child_process_1.spawn(file, args, spawnOptions);
    const deferred = async_1.createDeferred();
    const disposables = [];

    const on = (ee, name, fn) => {
      ee.on(name, fn);
      disposables.push({
        dispose: () => ee.removeListener(name, fn)
      });
    };

    if (options.token) {
      disposables.push(options.token.onCancellationRequested(() => {
        if (!proc.killed && !deferred.completed) {
          proc.kill();
        }
      }));
    }

    const stdoutBuffers = [];
    on(proc.stdout, 'data', data => stdoutBuffers.push(data));
    const stderrBuffers = [];
    on(proc.stderr, 'data', data => {
      if (options.mergeStdOutErr) {
        stdoutBuffers.push(data);
        stderrBuffers.push(data);
      } else {
        stderrBuffers.push(data);
      }
    });
    proc.once('close', () => {
      if (deferred.completed) {
        return;
      }

      const stderr = stderrBuffers.length === 0 ? undefined : this.decoder.decode(stderrBuffers, encoding);

      if (stderr && stderr.length > 0 && options.throwOnStdErr) {
        deferred.reject(new types_1.StdErrError(stderr));
      } else {
        const stdout = this.decoder.decode(stdoutBuffers, encoding);
        deferred.resolve({
          stdout,
          stderr
        });
      }

      disposables.forEach(disposable => disposable.dispose());
    });
    proc.once('error', ex => {
      deferred.reject(ex);
      disposables.forEach(disposable => disposable.dispose());
    });
    return deferred.promise;
  }

}

exports.ProcessService = ProcessService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2MuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJjaGlsZF9wcm9jZXNzXzEiLCJyZXF1aXJlIiwiT2JzZXJ2YWJsZV8xIiwiYXN5bmNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMSIsIlByb2Nlc3NTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJkZWNvZGVyIiwiZW52IiwiaXNBbGl2ZSIsInBpZCIsInByb2Nlc3MiLCJraWxsIiwiX2EiLCJraWxsUHJvY2Vzc1RyZWUiLCJleGVjT2JzZXJ2YWJsZSIsImZpbGUiLCJhcmdzIiwib3B0aW9ucyIsImVuY29kaW5nIiwibGVuZ3RoIiwiREVGQVVMVF9FTkNPRElORyIsInNwYXduT3B0aW9ucyIsImFzc2lnbiIsImtleXMiLCJQWVRIT05VTkJVRkZFUkVEIiwiUFlUSE9OSU9FTkNPRElORyIsInByb2MiLCJzcGF3biIsInByb2NFeGl0ZWQiLCJvdXRwdXQiLCJPYnNlcnZhYmxlIiwic3Vic2NyaWJlciIsImRpc3Bvc2FibGVzIiwib24iLCJlZSIsIm5hbWUiLCJmbiIsInB1c2giLCJkaXNwb3NlIiwicmVtb3ZlTGlzdGVuZXIiLCJ0b2tlbiIsIm9uQ2FuY2VsbGF0aW9uUmVxdWVzdGVkIiwia2lsbGVkIiwic2VuZE91dHB1dCIsInNvdXJjZSIsImRhdGEiLCJvdXQiLCJkZWNvZGUiLCJ0aHJvd09uU3RkRXJyIiwiZXJyb3IiLCJTdGRFcnJFcnJvciIsIm5leHQiLCJzdGRvdXQiLCJzdGRlcnIiLCJvbmNlIiwiY29tcGxldGUiLCJmb3JFYWNoIiwiZGlzcG9zYWJsZSIsImV4IiwiZXhlYyIsImRlZmVycmVkIiwiY3JlYXRlRGVmZXJyZWQiLCJjb21wbGV0ZWQiLCJzdGRvdXRCdWZmZXJzIiwic3RkZXJyQnVmZmVycyIsIm1lcmdlU3RkT3V0RXJyIiwidW5kZWZpbmVkIiwicmVqZWN0IiwicmVzb2x2ZSIsInByb21pc2UiXSwibWFwcGluZ3MiOiJBQUFB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T0FBTCxDQUFheUMsTUFBYixDQUFvQmlCLGFBQXBCLEVBQW1DOUMsUUFBbkMsQ0FBeEQ7O0FBQ0EsVUFBSW1DLE1BQU0sSUFBSUEsTUFBTSxDQUFDbEMsTUFBUCxHQUFnQixDQUExQixJQUErQkYsT0FBTyxDQUFDK0IsYUFBM0MsRUFBMEQ7QUFDdERZLFFBQUFBLFFBQVEsQ0FBQ08sTUFBVCxDQUFnQixJQUFJaEUsT0FBTyxDQUFDK0MsV0FBWixDQUF3QkcsTUFBeEIsQ0FBaEI7QUFDSCxPQUZELE1BR0s7QUFDRCxjQUFNRCxNQUFNLEdBQUcsS0FBSzlDLE9BQUwsQ0FBYXlDLE1BQWIsQ0FBb0JnQixhQUFwQixFQUFtQzdDLFFBQW5DLENBQWY7QUFDQTBDLFFBQUFBLFFBQVEsQ0FBQ1EsT0FBVCxDQUFpQjtBQUFFaEIsVUFBQUEsTUFBRjtBQUFVQyxVQUFBQTtBQUFWLFNBQWpCO0FBQ0g7O0FBQ0RyQixNQUFBQSxXQUFXLENBQUN3QixPQUFaLENBQW9CQyxVQUFVLElBQUlBLFVBQVUsQ0FBQ25CLE9BQVgsRUFBbEM7QUFDSCxLQWJEO0FBY0FaLElBQUFBLElBQUksQ0FBQzRCLElBQUwsQ0FBVSxPQUFWLEVBQW1CSSxFQUFFLElBQUk7QUFDckJFLE1BQUFBLFFBQVEsQ0FBQ08sTUFBVCxDQUFnQlQsRUFBaEI7QUFDQTFCLE1BQUFBLFdBQVcsQ0FBQ3dCLE9BQVosQ0FBb0JDLFVBQVUsSUFBSUEsVUFBVSxDQUFDbkIsT0FBWCxFQUFsQztBQUNILEtBSEQ7QUFJQSxXQUFPc0IsUUFBUSxDQUFDUyxPQUFoQjtBQUNIOztBQXZJZ0I7O0FBeUlyQnpFLE9BQU8sQ0FBQ1EsY0FBUixHQUF5QkEsY0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuLy8gdHNsaW50OmRpc2FibGU6bm8tYW55XG5jb25zdCBjaGlsZF9wcm9jZXNzXzEgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcbmNvbnN0IE9ic2VydmFibGVfMSA9IHJlcXVpcmUoXCJyeGpzL09ic2VydmFibGVcIik7XG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uL3V0aWxzL2FzeW5jXCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi9jb25zdGFudHNcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XG5jbGFzcyBQcm9jZXNzU2VydmljZSB7XG4gICAgY29uc3RydWN0b3IoZGVjb2RlciwgZW52KSB7XG4gICAgICAgIHRoaXMuZGVjb2RlciA9IGRlY29kZXI7XG4gICAgICAgIHRoaXMuZW52ID0gZW52O1xuICAgIH1cbiAgICBzdGF0aWMgaXNBbGl2ZShwaWQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHByb2Nlc3Mua2lsbChwaWQsIDApO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKF9hKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgc3RhdGljIGtpbGwocGlkKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1yZXF1aXJlLWltcG9ydHNcbiAgICAgICAgY29uc3Qga2lsbFByb2Nlc3NUcmVlID0gcmVxdWlyZSgndHJlZS1raWxsJyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBraWxsUHJvY2Vzc1RyZWUocGlkKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoX2EpIHtcbiAgICAgICAgICAgIC8vIElnbm9yZS5cbiAgICAgICAgfVxuICAgIH1cbiAgICBleGVjT2JzZXJ2YWJsZShmaWxlLCBhcmdzLCBvcHRpb25zID0ge30pIHtcbiAgICAgICAgY29uc3QgZW5jb2RpbmcgPSBvcHRpb25zLmVuY29kaW5nID0gdHlwZW9mIG9wdGlvbnMuZW5jb2RpbmcgPT09ICdzdHJpbmcnICYmIG9wdGlvbnMuZW5jb2RpbmcubGVuZ3RoID4gMCA/IG9wdGlvbnMuZW5jb2RpbmcgOiBjb25zdGFudHNfMS5ERUZBVUxUX0VOQ09ESU5HO1xuICAgICAgICBkZWxldGUgb3B0aW9ucy5lbmNvZGluZztcbiAgICAgICAgY29uc3Qgc3Bhd25PcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG4gICAgICAgIGlmICghc3Bhd25PcHRpb25zLmVudiB8fCBPYmplY3Qua2V5cyhzcGF3bk9wdGlvbnMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY29uc3QgZW52ID0gdGhpcy5lbnYgPyB0aGlzLmVudiA6IHByb2Nlc3MuZW52O1xuICAgICAgICAgICAgc3Bhd25PcHRpb25zLmVudiA9IE9iamVjdC5hc3NpZ24oe30sIGVudik7XG4gICAgICAgIH1cbiAgICAgICAgLy8gQWx3YXlzIGVuc3VyZSB3ZSBoYXZlIHVuYnVmZmVyZWQgb3V0cHV0LlxuICAgICAgICBzcGF3bk9wdGlvbnMuZW52LlBZVEhPTlVOQlVGRkVSRUQgPSAnMSc7XG4gICAgICAgIGlmICghc3Bhd25PcHRpb25zLmVudi5QWVRIT05JT0VOQ09ESU5HKSB7XG4gICAgICAgICAgICBzcGF3bk9wdGlvbnMuZW52LlBZVEhPTklPRU5DT0RJTkcgPSAndXRmLTgnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByb2MgPSBjaGlsZF9wcm9jZXNzXzEuc3Bhd24oZmlsZSwgYXJncywgc3Bhd25PcHRpb25zKTtcbiAgICAgICAgbGV0IHByb2NFeGl0ZWQgPSBmYWxzZTtcbiAgICAgICAgY29uc3Qgb3V0cHV0ID0gbmV3IE9ic2VydmFibGVfMS5PYnNlcnZhYmxlKHN1YnNjcmliZXIgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGlzcG9zYWJsZXMgPSBbXTtcbiAgICAgICAgICAgIGNvbnN0IG9uID0gKGVlLCBuYW1lLCBmbikgPT4ge1xuICAgICAgICAgICAgICAgIGVlLm9uKG5hbWUsIGZuKTtcbiAgICAgICAgICAgICAgICBkaXNwb3NhYmxlcy5wdXNoKHsgZGlzcG9zZTogKCkgPT4gZWUucmVtb3ZlTGlzdGVuZXIobmFtZSwgZm4pIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnRva2VuKSB7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZXMucHVzaChvcHRpb25zLnRva2VuLm9uQ2FuY2VsbGF0aW9uUmVxdWVzdGVkKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcm9jRXhpdGVkICYmICFwcm9jLmtpbGxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvYy5raWxsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jRXhpdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHNlbmRPdXRwdXQgPSAoc291cmNlLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3V0ID0gdGhpcy5kZWNvZGVyLmRlY29kZShbZGF0YV0sIGVuY29kaW5nKTtcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlID09PSAnc3RkZXJyJyAmJiBvcHRpb25zLnRocm93T25TdGRFcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJlci5lcnJvcihuZXcgdHlwZXNfMS5TdGRFcnJFcnJvcihvdXQpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZXIubmV4dCh7IHNvdXJjZSwgb3V0OiBvdXQgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG9uKHByb2Muc3Rkb3V0LCAnZGF0YScsIChkYXRhKSA9PiBzZW5kT3V0cHV0KCdzdGRvdXQnLCBkYXRhKSk7XG4gICAgICAgICAgICBvbihwcm9jLnN0ZGVyciwgJ2RhdGEnLCAoZGF0YSkgPT4gc2VuZE91dHB1dCgnc3RkZXJyJywgZGF0YSkpO1xuICAgICAgICAgICAgcHJvYy5vbmNlKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBwcm9jRXhpdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcHJvYy5vbmNlKCdlcnJvcicsIGV4ID0+IHtcbiAgICAgICAgICAgICAgICBwcm9jRXhpdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGV4KTtcbiAgICAgICAgICAgICAgICBkaXNwb3NhYmxlcy5mb3JFYWNoKGRpc3Bvc2FibGUgPT4gZGlzcG9zYWJsZS5kaXNwb3NlKCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4geyBwcm9jLCBvdXQ6IG91dHB1dCB9O1xuICAgIH1cbiAgICBleGVjKGZpbGUsIGFyZ3MsIG9wdGlvbnMgPSB7fSkge1xuICAgICAgICBjb25zdCBlbmNvZGluZyA9IG9wdGlvbnMuZW5jb2RpbmcgPSB0eXBlb2Ygb3B0aW9ucy5lbmNvZGluZyA9PT0gJ3N0cmluZycgJiYgb3B0aW9ucy5lbmNvZGluZy5sZW5ndGggPiAwID8gb3B0aW9ucy5lbmNvZGluZyA6IGNvbnN0YW50c18xLkRFRkFVTFRfRU5DT0RJTkc7XG4gICAgICAgIGRlbGV0ZSBvcHRpb25zLmVuY29kaW5nO1xuICAgICAgICBjb25zdCBzcGF3bk9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcbiAgICAgICAgaWYgKCFzcGF3bk9wdGlvbnMuZW52IHx8IE9iamVjdC5rZXlzKHNwYXduT3B0aW9ucykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBjb25zdCBlbnYgPSB0aGlzLmVudiA/IHRoaXMuZW52IDogcHJvY2Vzcy5lbnY7XG4gICAgICAgICAgICBzcGF3bk9wdGlvbnMuZW52ID0gT2JqZWN0LmFzc2lnbih7fSwgZW52KTtcbiAgICAgICAgfVxuICAgICAgICAvLyBBbHdheXMgZW5zdXJlIHdlIGhhdmUgdW5idWZmZXJlZCBvdXRwdXQuXG4gICAgICAgIHNwYXduT3B0aW9ucy5lbnYuUFlUSE9OVU5CVUZGRVJFRCA9ICcxJztcbiAgICAgICAgaWYgKCFzcGF3bk9wdGlvbnMuZW52LlBZVEhPTklPRU5DT0RJTkcpIHtcbiAgICAgICAgICAgIHNwYXduT3B0aW9ucy5lbnYuUFlUSE9OSU9FTkNPRElORyA9ICd1dGYtOCc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJvYyA9IGNoaWxkX3Byb2Nlc3NfMS5zcGF3bihmaWxlLCBhcmdzLCBzcGF3bk9wdGlvbnMpO1xuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZXMgPSBbXTtcbiAgICAgICAgY29uc3Qgb24gPSAoZWUsIG5hbWUsIGZuKSA9PiB7XG4gICAgICAgICAgICBlZS5vbihuYW1lLCBmbik7XG4gICAgICAgICAgICBkaXNwb3NhYmxlcy5wdXNoKHsgZGlzcG9zZTogKCkgPT4gZWUucmVtb3ZlTGlzdGVuZXIobmFtZSwgZm4pIH0pO1xuICAgICAgICB9O1xuICAgICAgICBpZiAob3B0aW9ucy50b2tlbikge1xuICAgICAgICAgICAgZGlzcG9zYWJsZXMucHVzaChvcHRpb25zLnRva2VuLm9uQ2FuY2VsbGF0aW9uUmVxdWVzdGVkKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXByb2Mua2lsbGVkICYmICFkZWZlcnJlZC5jb21wbGV0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvYy5raWxsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0ZG91dEJ1ZmZlcnMgPSBbXTtcbiAgICAgICAgb24ocHJvYy5zdGRvdXQsICdkYXRhJywgKGRhdGEpID0+IHN0ZG91dEJ1ZmZlcnMucHVzaChkYXRhKSk7XG4gICAgICAgIGNvbnN0IHN0ZGVyckJ1ZmZlcnMgPSBbXTtcbiAgICAgICAgb24ocHJvYy5zdGRlcnIsICdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLm1lcmdlU3RkT3V0RXJyKSB7XG4gICAgICAgICAgICAgICAgc3Rkb3V0QnVmZmVycy5wdXNoKGRhdGEpO1xuICAgICAgICAgICAgICAgIHN0ZGVyckJ1ZmZlcnMucHVzaChkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0ZGVyckJ1ZmZlcnMucHVzaChkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHByb2Mub25jZSgnY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoZGVmZXJyZWQuY29tcGxldGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc3RkZXJyID0gc3RkZXJyQnVmZmVycy5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiB0aGlzLmRlY29kZXIuZGVjb2RlKHN0ZGVyckJ1ZmZlcnMsIGVuY29kaW5nKTtcbiAgICAgICAgICAgIGlmIChzdGRlcnIgJiYgc3RkZXJyLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy50aHJvd09uU3RkRXJyKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyB0eXBlc18xLlN0ZEVyckVycm9yKHN0ZGVycikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3Rkb3V0ID0gdGhpcy5kZWNvZGVyLmRlY29kZShzdGRvdXRCdWZmZXJzLCBlbmNvZGluZyk7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh7IHN0ZG91dCwgc3RkZXJyIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByb2Mub25jZSgnZXJyb3InLCBleCA9PiB7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXgpO1xuICAgICAgICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cbn1cbmV4cG9ydHMuUHJvY2Vzc1NlcnZpY2UgPSBQcm9jZXNzU2VydmljZTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXByb2MuanMubWFwIl19