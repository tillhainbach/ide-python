"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

const registry_1 = require("../common/platform/registry");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/process/types");

const types_4 = require("../common/types");

const types_5 = require("../ioc/types");

const types_6 = require("./configuration/types");

const contracts_1 = require("./contracts");

const types_7 = require("./virtualEnvs/types");

const EXPITY_DURATION = 24 * 60 * 60 * 1000;
let InterpreterService = class InterpreterService {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.didChangeInterpreterEmitter = new vscode_1.EventEmitter();

    this.onConfigChanged = () => {
      this.didChangeInterpreterEmitter.fire();
      const interpreterDisplay = this.serviceContainer.get(contracts_1.IInterpreterDisplay);
      interpreterDisplay.refresh().catch(ex => console.error('Python Extension: display.refresh', ex));
    };

    this.locator = serviceContainer.get(contracts_1.IInterpreterLocatorService, contracts_1.INTERPRETER_LOCATOR_SERVICE);
    this.helper = serviceContainer.get(contracts_1.IInterpreterHelper);
    this.pythonPathUpdaterService = this.serviceContainer.get(types_6.IPythonPathUpdaterServiceManager);
    this.fs = this.serviceContainer.get(types_2.IFileSystem);
    this.persistentStateFactory = this.serviceContainer.get(types_4.IPersistentStateFactory);
  }

  refresh(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const interpreterDisplay = this.serviceContainer.get(contracts_1.IInterpreterDisplay);
      return interpreterDisplay.refresh(resource);
    });
  }

  initialize() {
    const disposables = this.serviceContainer.get(types_4.IDisposableRegistry);
    const documentManager = this.serviceContainer.get(types_1.IDocumentManager);
    disposables.push(documentManager.onDidChangeActiveTextEditor(e => e ? this.refresh(e.document.uri) : undefined));
    const configService = this.serviceContainer.get(types_4.IConfigurationService);
    configService.getSettings().addListener('change', this.onConfigChanged);
  }

  getInterpreters(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const interpreters = yield this.locator.getInterpreters(resource);
      yield Promise.all(interpreters.filter(item => !item.displayName).map(item => __awaiter(this, void 0, void 0, function* () {
        return item.displayName = yield this.getDisplayName(item, resource);
      })));
      return interpreters;
    });
  }

  autoSetInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!(yield this.shouldAutoSetInterpreter())) {
        return;
      }

      const activeWorkspace = this.helper.getActiveWorkspaceUri();

      if (!activeWorkspace) {
        return;
      } // Check pipenv first.


      const pipenvService = this.serviceContainer.get(contracts_1.IInterpreterLocatorService, contracts_1.PIPENV_SERVICE);
      let interpreters = yield pipenvService.getInterpreters(activeWorkspace.folderUri);

      if (interpreters.length > 0) {
        yield this.pythonPathUpdaterService.updatePythonPath(interpreters[0].path, activeWorkspace.configTarget, 'load', activeWorkspace.folderUri);
        return;
      } // Now check virtual environments under the workspace root


      const virtualEnvInterpreterProvider = this.serviceContainer.get(contracts_1.IInterpreterLocatorService, contracts_1.WORKSPACE_VIRTUAL_ENV_SERVICE);
      interpreters = yield virtualEnvInterpreterProvider.getInterpreters(activeWorkspace.folderUri);
      const workspacePathUpper = activeWorkspace.folderUri.fsPath.toUpperCase();
      const interpretersInWorkspace = interpreters.filter(interpreter => vscode_1.Uri.file(interpreter.path).fsPath.toUpperCase().startsWith(workspacePathUpper));

      if (interpretersInWorkspace.length === 0) {
        return;
      } // Always pick the highest version by default.


      interpretersInWorkspace.sort((a, b) => a.version > b.version ? 1 : -1);
      const pythonPath = interpretersInWorkspace[0].path; // Ensure this new environment is at the same level as the current workspace.
      // In windows the interpreter is under scripts/python.exe on linux it is under bin/python.
      // Meaning the sub directory must be either scripts, bin or other (but only one level deep).

      const relativePath = path.dirname(pythonPath).substring(activeWorkspace.folderUri.fsPath.length);

      if (relativePath.split(path.sep).filter(l => l.length > 0).length === 2) {
        yield this.pythonPathUpdaterService.updatePythonPath(pythonPath, activeWorkspace.configTarget, 'load', activeWorkspace.folderUri);
      }
    });
  }

  dispose() {
    this.locator.dispose();
    const configService = this.serviceContainer.get(types_4.IConfigurationService);
    configService.getSettings().removeListener('change', this.onConfigChanged);
    this.didChangeInterpreterEmitter.dispose();
  }

  get onDidChangeInterpreter() {
    return this.didChangeInterpreterEmitter.event;
  }

  getActiveInterpreter(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonExecutionFactory = this.serviceContainer.get(types_3.IPythonExecutionFactory);
      const pythonExecutionService = yield pythonExecutionFactory.create({
        resource
      });
      const fullyQualifiedPath = yield pythonExecutionService.getExecutablePath().catch(() => undefined); // Python path is invalid or python isn't installed.

      if (!fullyQualifiedPath) {
        return;
      }

      return this.getInterpreterDetails(fullyQualifiedPath, resource);
    });
  }

  getInterpreterDetails(pythonPath, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      // If we don't have the fully qualified path, then get it.
      if (path.basename(pythonPath) === pythonPath) {
        const pythonExecutionFactory = this.serviceContainer.get(types_3.IPythonExecutionFactory);
        const pythonExecutionService = yield pythonExecutionFactory.create({
          resource
        });
        pythonPath = yield pythonExecutionService.getExecutablePath().catch(() => ''); // Python path is invalid or python isn't installed.

        if (!pythonPath) {
          return;
        }
      }

      let fileHash = yield this.fs.getFileHash(pythonPath).catch(() => '');
      fileHash = fileHash ? fileHash : '';
      const store = this.persistentStateFactory.createGlobalPersistentState(`${pythonPath}.interpreter.details.v5`, undefined, EXPITY_DURATION);

      if (store.value && fileHash && store.value.fileHash === fileHash) {
        return store.value;
      }

      const fs = this.serviceContainer.get(types_2.IFileSystem);
      const interpreters = yield this.getInterpreters(resource);
      let interpreterInfo = interpreters.find(i => fs.arePathsSame(i.path, pythonPath));

      if (!interpreterInfo) {
        const interpreterHelper = this.serviceContainer.get(contracts_1.IInterpreterHelper);
        const virtualEnvManager = this.serviceContainer.get(types_7.IVirtualEnvironmentManager);
        const [info, type] = yield Promise.all([interpreterHelper.getInterpreterInformation(pythonPath), virtualEnvManager.getEnvironmentType(pythonPath)]);

        if (!info) {
          return;
        }

        const details = Object.assign({}, info, {
          path: pythonPath,
          type: type
        });
        const envName = type === contracts_1.InterpreterType.Unknown ? undefined : yield virtualEnvManager.getEnvironmentName(pythonPath, resource);
        interpreterInfo = Object.assign({}, details, {
          envName
        });
        interpreterInfo.displayName = yield this.getDisplayName(interpreterInfo, resource);
      }

      yield store.updateValue(Object.assign({}, interpreterInfo, {
        path: pythonPath,
        fileHash
      }));
      return interpreterInfo;
    });
  }
  /**
   * Gets the display name of an interpreter.
   * The format is `Python <Version> <bitness> (<env name>: <env type>)`
   * E.g. `Python 3.5.1 32-bit (myenv2: virtualenv)`
   * @param {Partial<PythonInterpreter>} info
   * @returns {string}
   * @memberof InterpreterService
   */


  getDisplayName(info, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const store = this.persistentStateFactory.createGlobalPersistentState(`${info.path}.interpreter.displayName.v5`, undefined, EXPITY_DURATION);

      if (store.value) {
        return store.value;
      }

      const displayNameParts = ['Python'];
      const envSuffixParts = [];

      if (info.version_info && info.version_info.length > 0) {
        displayNameParts.push(info.version_info.slice(0, 3).join('.'));
      }

      if (info.architecture) {
        displayNameParts.push(registry_1.getArchitectureDisplayName(info.architecture));
      }

      if (!info.envName && info.path && info.type && info.type === contracts_1.InterpreterType.PipEnv) {
        // If we do not have the name of the environment, then try to get it again.
        // This can happen based on the context (i.e. resource).
        // I.e. we can determine if an environment is PipEnv only when giving it the right workspacec path (i.e. resource).
        const virtualEnvMgr = this.serviceContainer.get(types_7.IVirtualEnvironmentManager);
        info.envName = yield virtualEnvMgr.getEnvironmentName(info.path, resource);
      }

      if (info.envName && info.envName.length > 0) {
        envSuffixParts.push(`'${info.envName}'`);
      }

      if (info.type) {
        const interpreterHelper = this.serviceContainer.get(contracts_1.IInterpreterHelper);
        const name = interpreterHelper.getInterpreterTypeDisplayName(info.type);

        if (name) {
          envSuffixParts.push(name);
        }
      }

      const envSuffix = envSuffixParts.length === 0 ? '' : `(${envSuffixParts.join(': ')})`;
      const displayName = `${displayNameParts.join(' ')} ${envSuffix}`.trim(); // If dealing with cached entry, then do not store the display name in cache.

      if (!info.cachedEntry) {
        yield store.updateValue(displayName);
      }

      return displayName;
    });
  }

  shouldAutoSetInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      const activeWorkspace = this.helper.getActiveWorkspaceUri();

      if (!activeWorkspace) {
        return false;
      }

      const workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
      const pythonConfig = workspaceService.getConfiguration('python', activeWorkspace.folderUri);
      const pythonPathInConfig = pythonConfig.inspect('pythonPath'); // If we have a value in user settings, then don't auto set the interpreter path.

      if (pythonPathInConfig && pythonPathInConfig.globalValue !== undefined && pythonPathInConfig.globalValue !== 'python') {
        return false;
      }

      if (activeWorkspace.configTarget === vscode_1.ConfigurationTarget.Workspace) {
        return pythonPathInConfig.workspaceValue === undefined || pythonPathInConfig.workspaceValue === 'python';
      }

      if (activeWorkspace.configTarget === vscode_1.ConfigurationTarget.WorkspaceFolder) {
        return pythonPathInConfig.workspaceFolderValue === undefined || pythonPathInConfig.workspaceFolderValue === 'python';
      }

      return false;
    });
  }

};
InterpreterService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_5.IServiceContainer))], InterpreterService);
exports.InterpreterService = InterpreterService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVycHJldGVyU2VydmljZS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsInJlZ2lzdHJ5XzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsInR5cGVzXzQiLCJ0eXBlc181IiwidHlwZXNfNiIsImNvbnRyYWN0c18xIiwidHlwZXNfNyIsIkVYUElUWV9EVVJBVElPTiIsIkludGVycHJldGVyU2VydmljZSIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRpZENoYW5nZUludGVycHJldGVyRW1pdHRlciIsIkV2ZW50RW1pdHRlciIsIm9uQ29uZmlnQ2hhbmdlZCIsImZpcmUiLCJpbnRlcnByZXRlckRpc3BsYXkiLCJnZXQiLCJJSW50ZXJwcmV0ZXJEaXNwbGF5IiwicmVmcmVzaCIsImNhdGNoIiwiZXgiLCJjb25zb2xlIiwiZXJyb3IiLCJsb2NhdG9yIiwiSUludGVycHJldGVyTG9jYXRvclNlcnZpY2UiLCJJTlRFUlBSRVRFUl9MT0NBVE9SX1NFUlZJQ0UiLCJoZWxwZXIiLCJJSW50ZXJwcmV0ZXJIZWxwZXIiLCJweXRob25QYXRoVXBkYXRlclNlcnZpY2UiLCJJUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlciIsImZzIiwiSUZpbGVTeXN0ZW0iLCJwZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkiLCJyZXNvdXJjZSIsImluaXRpYWxpemUiLCJkaXNwb3NhYmxlcyIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJkb2N1bWVudE1hbmFnZXIiLCJJRG9jdW1lbnRNYW5hZ2VyIiwicHVzaCIsIm9uRGlkQ2hhbmdlQWN0aXZlVGV4dEVkaXRvciIsImRvY3VtZW50IiwidXJpIiwidW5kZWZpbmVkIiwiY29uZmlnU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiYWRkTGlzdGVuZXIiLCJnZXRJbnRlcnByZXRlcnMiLCJpbnRlcnByZXRlcnMiLCJhbGwiLCJmaWx0ZXIiLCJpdGVtIiwiZGlzcGxheU5hbWUiLCJtYXAiLCJnZXREaXNwbGF5TmFtZSIsImF1dG9TZXRJbnRlcnByZXRlciIsInNob3VsZEF1dG9TZXRJbnRlcnByZXRlciIsImFjdGl2ZVdvcmtzcGFjZSIsImdldEFjdGl2ZVdvcmtzcGFjZVVyaSIsInBpcGVudlNlcnZpY2UiLCJQSVBFTlZfU0VSVklDRSIsImZvbGRlclVyaSIsInVwZGF0ZVB5dGhvblBhdGgiLCJjb25maWdUYXJnZXQiLCJ2aXJ0dWFsRW52SW50ZXJwcmV0ZXJQcm92aWRlciIsIldPUktTUEFDRV9WSVJUVUFMX0VOVl9TRVJWSUNFIiwid29ya3NwYWNlUGF0aFVwcGVyIiwiZnNQYXRoIiwidG9VcHBlckNhc2UiLCJpbnRlcnByZXRlcnNJbldvcmtzcGFjZSIsImludGVycHJldGVyIiwiVXJpIiwiZmlsZSIsInN0YXJ0c1dpdGgiLCJzb3J0IiwiYSIsImIiLCJ2ZXJzaW9uIiwicHl0aG9uUGF0aCIsInJlbGF0aXZlUGF0aCIsImRpcm5hbWUiLCJzdWJzdHJpbmciLCJzcGxpdCIsInNlcCIsImwiLCJkaXNwb3NlIiwicmVtb3ZlTGlzdGVuZXIiLCJvbkRpZENoYW5nZUludGVycHJldGVyIiwiZXZlbnQiLCJnZXRBY3RpdmVJbnRlcnByZXRlciIsInB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJJUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSIsInB5dGhvbkV4ZWN1dGlvblNlcnZpY2UiLCJjcmVhdGUiLCJmdWxseVF1YWxpZmllZFBhdGgiLCJnZXRFeGVjdXRhYmxlUGF0aCIsImdldEludGVycHJldGVyRGV0YWlscyIsImJhc2VuYW1lIiwiZmlsZUhhc2giLCJnZXRGaWxlSGFzaCIsInN0b3JlIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwiaW50ZXJwcmV0ZXJJbmZvIiwiZmluZCIsImFyZVBhdGhzU2FtZSIsImludGVycHJldGVySGVscGVyIiwidmlydHVhbEVudk1hbmFnZXIiLCJJVmlydHVhbEVudmlyb25tZW50TWFuYWdlciIsImluZm8iLCJ0eXBlIiwiZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbiIsImdldEVudmlyb25tZW50VHlwZSIsImRldGFpbHMiLCJhc3NpZ24iLCJlbnZOYW1lIiwiSW50ZXJwcmV0ZXJUeXBlIiwiVW5rbm93biIsImdldEVudmlyb25tZW50TmFtZSIsInVwZGF0ZVZhbHVlIiwiZGlzcGxheU5hbWVQYXJ0cyIsImVudlN1ZmZpeFBhcnRzIiwidmVyc2lvbl9pbmZvIiwic2xpY2UiLCJqb2luIiwiYXJjaGl0ZWN0dXJlIiwiZ2V0QXJjaGl0ZWN0dXJlRGlzcGxheU5hbWUiLCJQaXBFbnYiLCJ2aXJ0dWFsRW52TWdyIiwibmFtZSIsImdldEludGVycHJldGVyVHlwZURpc3BsYXlOYW1lIiwiZW52U3VmZml4IiwidHJpbSIsImNhY2hlZEVudHJ5Iiwid29ya3NwYWNlU2VydmljZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwicHl0aG9uQ29uZmlnIiwiZ2V0Q29uZmlndXJhdGlvbiIsInB5dGhvblBhdGhJbkNvbmZpZyIsImluc3BlY3QiLCJnbG9iYWxWYWx1ZSIsIkNvbmZpZ3VyYXRpb25UYXJnZXQiLCJXb3Jrc3BhY2UiLCJ3b3Jrc3BhY2VWYWx1ZSIsIldvcmtzcGFjZUZvbGRlciIsIndvcmtzcGFjZUZvbGRlclZhbHVlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRCRyxDQUFDLENB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Q0QsYUFBTyxLQUFQO0FBQ0gsS0FuQmUsQ0FBaEI7QUFvQkg7O0FBN002QyxDQUFsRDtBQStNQTFJLGtCQUFrQixHQUFHcEQsVUFBVSxDQUFDLENBQzVCc0MsV0FBVyxDQUFDeUosVUFBWixFQUQ0QixFQUU1Qi9LLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMwSixNQUFaLENBQW1CakosT0FBTyxDQUFDa0osaUJBQTNCLENBQUosQ0FGcUIsQ0FBRCxFQUc1QjdJLGtCQUg0QixDQUEvQjtBQUlBZixPQUFPLENBQUNlLGtCQUFSLEdBQTZCQSxrQkFBN0IiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbmNvbnN0IHJlZ2lzdHJ5XzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3BsYXRmb3JtL3JlZ2lzdHJ5XCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc181ID0gcmVxdWlyZShcIi4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzYgPSByZXF1aXJlKFwiLi9jb25maWd1cmF0aW9uL3R5cGVzXCIpO1xuY29uc3QgY29udHJhY3RzXzEgPSByZXF1aXJlKFwiLi9jb250cmFjdHNcIik7XG5jb25zdCB0eXBlc183ID0gcmVxdWlyZShcIi4vdmlydHVhbEVudnMvdHlwZXNcIik7XG5jb25zdCBFWFBJVFlfRFVSQVRJT04gPSAyNCAqIDYwICogNjAgKiAxMDAwO1xubGV0IEludGVycHJldGVyU2VydmljZSA9IGNsYXNzIEludGVycHJldGVyU2VydmljZSB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgICAgICB0aGlzLmRpZENoYW5nZUludGVycHJldGVyRW1pdHRlciA9IG5ldyB2c2NvZGVfMS5FdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5vbkNvbmZpZ0NoYW5nZWQgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRpZENoYW5nZUludGVycHJldGVyRW1pdHRlci5maXJlKCk7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlckRpc3BsYXkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlckRpc3BsYXkpO1xuICAgICAgICAgICAgaW50ZXJwcmV0ZXJEaXNwbGF5LnJlZnJlc2goKVxuICAgICAgICAgICAgICAgIC5jYXRjaChleCA9PiBjb25zb2xlLmVycm9yKCdQeXRob24gRXh0ZW5zaW9uOiBkaXNwbGF5LnJlZnJlc2gnLCBleCkpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmxvY2F0b3IgPSBzZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJMb2NhdG9yU2VydmljZSwgY29udHJhY3RzXzEuSU5URVJQUkVURVJfTE9DQVRPUl9TRVJWSUNFKTtcbiAgICAgICAgdGhpcy5oZWxwZXIgPSBzZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJIZWxwZXIpO1xuICAgICAgICB0aGlzLnB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNi5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlcik7XG4gICAgICAgIHRoaXMuZnMgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUZpbGVTeXN0ZW0pO1xuICAgICAgICB0aGlzLnBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpO1xuICAgIH1cbiAgICByZWZyZXNoKHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlckRpc3BsYXkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlckRpc3BsYXkpO1xuICAgICAgICAgICAgcmV0dXJuIGludGVycHJldGVyRGlzcGxheS5yZWZyZXNoKHJlc291cmNlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklEaXNwb3NhYmxlUmVnaXN0cnkpO1xuICAgICAgICBjb25zdCBkb2N1bWVudE1hbmFnZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcik7XG4gICAgICAgIGRpc3Bvc2FibGVzLnB1c2goZG9jdW1lbnRNYW5hZ2VyLm9uRGlkQ2hhbmdlQWN0aXZlVGV4dEVkaXRvcigoZSkgPT4gZSA/IHRoaXMucmVmcmVzaChlLmRvY3VtZW50LnVyaSkgOiB1bmRlZmluZWQpKTtcbiAgICAgICAgY29uc3QgY29uZmlnU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xuICAgICAgICBjb25maWdTZXJ2aWNlLmdldFNldHRpbmdzKCkuYWRkTGlzdGVuZXIoJ2NoYW5nZScsIHRoaXMub25Db25maWdDaGFuZ2VkKTtcbiAgICB9XG4gICAgZ2V0SW50ZXJwcmV0ZXJzKHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCB0aGlzLmxvY2F0b3IuZ2V0SW50ZXJwcmV0ZXJzKHJlc291cmNlKTtcbiAgICAgICAgICAgIHlpZWxkIFByb21pc2UuYWxsKGludGVycHJldGVyc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiAhaXRlbS5kaXNwbGF5TmFtZSlcbiAgICAgICAgICAgICAgICAubWFwKChpdGVtKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7IHJldHVybiBpdGVtLmRpc3BsYXlOYW1lID0geWllbGQgdGhpcy5nZXREaXNwbGF5TmFtZShpdGVtLCByZXNvdXJjZSk7IH0pKSk7XG4gICAgICAgICAgICByZXR1cm4gaW50ZXJwcmV0ZXJzO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgYXV0b1NldEludGVycHJldGVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCEoeWllbGQgdGhpcy5zaG91bGRBdXRvU2V0SW50ZXJwcmV0ZXIoKSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBhY3RpdmVXb3Jrc3BhY2UgPSB0aGlzLmhlbHBlci5nZXRBY3RpdmVXb3Jrc3BhY2VVcmkoKTtcbiAgICAgICAgICAgIGlmICghYWN0aXZlV29ya3NwYWNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ2hlY2sgcGlwZW52IGZpcnN0LlxuICAgICAgICAgICAgY29uc3QgcGlwZW52U2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyTG9jYXRvclNlcnZpY2UsIGNvbnRyYWN0c18xLlBJUEVOVl9TRVJWSUNFKTtcbiAgICAgICAgICAgIGxldCBpbnRlcnByZXRlcnMgPSB5aWVsZCBwaXBlbnZTZXJ2aWNlLmdldEludGVycHJldGVycyhhY3RpdmVXb3Jrc3BhY2UuZm9sZGVyVXJpKTtcbiAgICAgICAgICAgIGlmIChpbnRlcnByZXRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMucHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLnVwZGF0ZVB5dGhvblBhdGgoaW50ZXJwcmV0ZXJzWzBdLnBhdGgsIGFjdGl2ZVdvcmtzcGFjZS5jb25maWdUYXJnZXQsICdsb2FkJywgYWN0aXZlV29ya3NwYWNlLmZvbGRlclVyaSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gTm93IGNoZWNrIHZpcnR1YWwgZW52aXJvbm1lbnRzIHVuZGVyIHRoZSB3b3Jrc3BhY2Ugcm9vdFxuICAgICAgICAgICAgY29uc3QgdmlydHVhbEVudkludGVycHJldGVyUHJvdmlkZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlckxvY2F0b3JTZXJ2aWNlLCBjb250cmFjdHNfMS5XT1JLU1BBQ0VfVklSVFVBTF9FTlZfU0VSVklDRSk7XG4gICAgICAgICAgICBpbnRlcnByZXRlcnMgPSB5aWVsZCB2aXJ0dWFsRW52SW50ZXJwcmV0ZXJQcm92aWRlci5nZXRJbnRlcnByZXRlcnMoYWN0aXZlV29ya3NwYWNlLmZvbGRlclVyaSk7XG4gICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VQYXRoVXBwZXIgPSBhY3RpdmVXb3Jrc3BhY2UuZm9sZGVyVXJpLmZzUGF0aC50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJzSW5Xb3Jrc3BhY2UgPSBpbnRlcnByZXRlcnMuZmlsdGVyKGludGVycHJldGVyID0+IHZzY29kZV8xLlVyaS5maWxlKGludGVycHJldGVyLnBhdGgpLmZzUGF0aC50b1VwcGVyQ2FzZSgpLnN0YXJ0c1dpdGgod29ya3NwYWNlUGF0aFVwcGVyKSk7XG4gICAgICAgICAgICBpZiAoaW50ZXJwcmV0ZXJzSW5Xb3Jrc3BhY2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQWx3YXlzIHBpY2sgdGhlIGhpZ2hlc3QgdmVyc2lvbiBieSBkZWZhdWx0LlxuICAgICAgICAgICAgaW50ZXJwcmV0ZXJzSW5Xb3Jrc3BhY2Uuc29ydCgoYSwgYikgPT4gYS52ZXJzaW9uID4gYi52ZXJzaW9uID8gMSA6IC0xKTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSBpbnRlcnByZXRlcnNJbldvcmtzcGFjZVswXS5wYXRoO1xuICAgICAgICAgICAgLy8gRW5zdXJlIHRoaXMgbmV3IGVudmlyb25tZW50IGlzIGF0IHRoZSBzYW1lIGxldmVsIGFzIHRoZSBjdXJyZW50IHdvcmtzcGFjZS5cbiAgICAgICAgICAgIC8vIEluIHdpbmRvd3MgdGhlIGludGVycHJldGVyIGlzIHVuZGVyIHNjcmlwdHMvcHl0aG9uLmV4ZSBvbiBsaW51eCBpdCBpcyB1bmRlciBiaW4vcHl0aG9uLlxuICAgICAgICAgICAgLy8gTWVhbmluZyB0aGUgc3ViIGRpcmVjdG9yeSBtdXN0IGJlIGVpdGhlciBzY3JpcHRzLCBiaW4gb3Igb3RoZXIgKGJ1dCBvbmx5IG9uZSBsZXZlbCBkZWVwKS5cbiAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHBhdGguZGlybmFtZShweXRob25QYXRoKS5zdWJzdHJpbmcoYWN0aXZlV29ya3NwYWNlLmZvbGRlclVyaS5mc1BhdGgubGVuZ3RoKTtcbiAgICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGguc3BsaXQocGF0aC5zZXApLmZpbHRlcihsID0+IGwubGVuZ3RoID4gMCkubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgeWllbGQgdGhpcy5weXRob25QYXRoVXBkYXRlclNlcnZpY2UudXBkYXRlUHl0aG9uUGF0aChweXRob25QYXRoLCBhY3RpdmVXb3Jrc3BhY2UuY29uZmlnVGFyZ2V0LCAnbG9hZCcsIGFjdGl2ZVdvcmtzcGFjZS5mb2xkZXJVcmkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgdGhpcy5sb2NhdG9yLmRpc3Bvc2UoKTtcbiAgICAgICAgY29uc3QgY29uZmlnU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xuICAgICAgICBjb25maWdTZXJ2aWNlLmdldFNldHRpbmdzKCkucmVtb3ZlTGlzdGVuZXIoJ2NoYW5nZScsIHRoaXMub25Db25maWdDaGFuZ2VkKTtcbiAgICAgICAgdGhpcy5kaWRDaGFuZ2VJbnRlcnByZXRlckVtaXR0ZXIuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBnZXQgb25EaWRDaGFuZ2VJbnRlcnByZXRlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlkQ2hhbmdlSW50ZXJwcmV0ZXJFbWl0dGVyLmV2ZW50O1xuICAgIH1cbiAgICBnZXRBY3RpdmVJbnRlcnByZXRlcihyZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uRXhlY3V0aW9uRmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XG4gICAgICAgICAgICBjb25zdCBweXRob25FeGVjdXRpb25TZXJ2aWNlID0geWllbGQgcHl0aG9uRXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoeyByZXNvdXJjZSB9KTtcbiAgICAgICAgICAgIGNvbnN0IGZ1bGx5UXVhbGlmaWVkUGF0aCA9IHlpZWxkIHB5dGhvbkV4ZWN1dGlvblNlcnZpY2UuZ2V0RXhlY3V0YWJsZVBhdGgoKS5jYXRjaCgoKSA9PiB1bmRlZmluZWQpO1xuICAgICAgICAgICAgLy8gUHl0aG9uIHBhdGggaXMgaW52YWxpZCBvciBweXRob24gaXNuJ3QgaW5zdGFsbGVkLlxuICAgICAgICAgICAgaWYgKCFmdWxseVF1YWxpZmllZFBhdGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnRlcnByZXRlckRldGFpbHMoZnVsbHlRdWFsaWZpZWRQYXRoLCByZXNvdXJjZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRJbnRlcnByZXRlckRldGFpbHMocHl0aG9uUGF0aCwgcmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgdGhlIGZ1bGx5IHF1YWxpZmllZCBwYXRoLCB0aGVuIGdldCBpdC5cbiAgICAgICAgICAgIGlmIChwYXRoLmJhc2VuYW1lKHB5dGhvblBhdGgpID09PSBweXRob25QYXRoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHl0aG9uRXhlY3V0aW9uRmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcHl0aG9uRXhlY3V0aW9uU2VydmljZSA9IHlpZWxkIHB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkuY3JlYXRlKHsgcmVzb3VyY2UgfSk7XG4gICAgICAgICAgICAgICAgcHl0aG9uUGF0aCA9IHlpZWxkIHB5dGhvbkV4ZWN1dGlvblNlcnZpY2UuZ2V0RXhlY3V0YWJsZVBhdGgoKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgICAgICAgICAgICAgLy8gUHl0aG9uIHBhdGggaXMgaW52YWxpZCBvciBweXRob24gaXNuJ3QgaW5zdGFsbGVkLlxuICAgICAgICAgICAgICAgIGlmICghcHl0aG9uUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGZpbGVIYXNoID0geWllbGQgdGhpcy5mcy5nZXRGaWxlSGFzaChweXRob25QYXRoKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgICAgICAgICBmaWxlSGFzaCA9IGZpbGVIYXNoID8gZmlsZUhhc2ggOiAnJztcbiAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gdGhpcy5wZXJzaXN0ZW50U3RhdGVGYWN0b3J5LmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShgJHtweXRob25QYXRofS5pbnRlcnByZXRlci5kZXRhaWxzLnY1YCwgdW5kZWZpbmVkLCBFWFBJVFlfRFVSQVRJT04pO1xuICAgICAgICAgICAgaWYgKHN0b3JlLnZhbHVlICYmIGZpbGVIYXNoICYmIHN0b3JlLnZhbHVlLmZpbGVIYXNoID09PSBmaWxlSGFzaCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdG9yZS52YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGZzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklGaWxlU3lzdGVtKTtcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVycyA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJzKHJlc291cmNlKTtcbiAgICAgICAgICAgIGxldCBpbnRlcnByZXRlckluZm8gPSBpbnRlcnByZXRlcnMuZmluZChpID0+IGZzLmFyZVBhdGhzU2FtZShpLnBhdGgsIHB5dGhvblBhdGgpKTtcbiAgICAgICAgICAgIGlmICghaW50ZXJwcmV0ZXJJbmZvKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJIZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlckhlbHBlcik7XG4gICAgICAgICAgICAgICAgY29uc3QgdmlydHVhbEVudk1hbmFnZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzcuSVZpcnR1YWxFbnZpcm9ubWVudE1hbmFnZXIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IFtpbmZvLCB0eXBlXSA9IHlpZWxkIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXJIZWxwZXIuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbihweXRob25QYXRoKSxcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbEVudk1hbmFnZXIuZ2V0RW52aXJvbm1lbnRUeXBlKHB5dGhvblBhdGgpXG4gICAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgZGV0YWlscyA9IE9iamVjdC5hc3NpZ24oe30sIGluZm8sIHsgcGF0aDogcHl0aG9uUGF0aCwgdHlwZTogdHlwZSB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBlbnZOYW1lID0gdHlwZSA9PT0gY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLlVua25vd24gPyB1bmRlZmluZWQgOiB5aWVsZCB2aXJ0dWFsRW52TWFuYWdlci5nZXRFbnZpcm9ubWVudE5hbWUocHl0aG9uUGF0aCwgcmVzb3VyY2UpO1xuICAgICAgICAgICAgICAgIGludGVycHJldGVySW5mbyA9IE9iamVjdC5hc3NpZ24oe30sIGRldGFpbHMsIHsgZW52TmFtZSB9KTtcbiAgICAgICAgICAgICAgICBpbnRlcnByZXRlckluZm8uZGlzcGxheU5hbWUgPSB5aWVsZCB0aGlzLmdldERpc3BsYXlOYW1lKGludGVycHJldGVySW5mbywgcmVzb3VyY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgeWllbGQgc3RvcmUudXBkYXRlVmFsdWUoT2JqZWN0LmFzc2lnbih7fSwgaW50ZXJwcmV0ZXJJbmZvLCB7IHBhdGg6IHB5dGhvblBhdGgsIGZpbGVIYXNoIH0pKTtcbiAgICAgICAgICAgIHJldHVybiBpbnRlcnByZXRlckluZm87XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBkaXNwbGF5IG5hbWUgb2YgYW4gaW50ZXJwcmV0ZXIuXG4gICAgICogVGhlIGZvcm1hdCBpcyBgUHl0aG9uIDxWZXJzaW9uPiA8Yml0bmVzcz4gKDxlbnYgbmFtZT46IDxlbnYgdHlwZT4pYFxuICAgICAqIEUuZy4gYFB5dGhvbiAzLjUuMSAzMi1iaXQgKG15ZW52MjogdmlydHVhbGVudilgXG4gICAgICogQHBhcmFtIHtQYXJ0aWFsPFB5dGhvbkludGVycHJldGVyPn0gaW5mb1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICogQG1lbWJlcm9mIEludGVycHJldGVyU2VydmljZVxuICAgICAqL1xuICAgIGdldERpc3BsYXlOYW1lKGluZm8sIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IHRoaXMucGVyc2lzdGVudFN0YXRlRmFjdG9yeS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoYCR7aW5mby5wYXRofS5pbnRlcnByZXRlci5kaXNwbGF5TmFtZS52NWAsIHVuZGVmaW5lZCwgRVhQSVRZX0RVUkFUSU9OKTtcbiAgICAgICAgICAgIGlmIChzdG9yZS52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdG9yZS52YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlOYW1lUGFydHMgPSBbJ1B5dGhvbiddO1xuICAgICAgICAgICAgY29uc3QgZW52U3VmZml4UGFydHMgPSBbXTtcbiAgICAgICAgICAgIGlmIChpbmZvLnZlcnNpb25faW5mbyAmJiBpbmZvLnZlcnNpb25faW5mby5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWVQYXJ0cy5wdXNoKGluZm8udmVyc2lvbl9pbmZvLnNsaWNlKDAsIDMpLmpvaW4oJy4nKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaW5mby5hcmNoaXRlY3R1cmUpIHtcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZVBhcnRzLnB1c2gocmVnaXN0cnlfMS5nZXRBcmNoaXRlY3R1cmVEaXNwbGF5TmFtZShpbmZvLmFyY2hpdGVjdHVyZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFpbmZvLmVudk5hbWUgJiYgaW5mby5wYXRoICYmIGluZm8udHlwZSAmJiBpbmZvLnR5cGUgPT09IGNvbnRyYWN0c18xLkludGVycHJldGVyVHlwZS5QaXBFbnYpIHtcbiAgICAgICAgICAgICAgICAvLyBJZiB3ZSBkbyBub3QgaGF2ZSB0aGUgbmFtZSBvZiB0aGUgZW52aXJvbm1lbnQsIHRoZW4gdHJ5IHRvIGdldCBpdCBhZ2Fpbi5cbiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gYmFzZWQgb24gdGhlIGNvbnRleHQgKGkuZS4gcmVzb3VyY2UpLlxuICAgICAgICAgICAgICAgIC8vIEkuZS4gd2UgY2FuIGRldGVybWluZSBpZiBhbiBlbnZpcm9ubWVudCBpcyBQaXBFbnYgb25seSB3aGVuIGdpdmluZyBpdCB0aGUgcmlnaHQgd29ya3NwYWNlYyBwYXRoIChpLmUuIHJlc291cmNlKS5cbiAgICAgICAgICAgICAgICBjb25zdCB2aXJ0dWFsRW52TWdyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc183LklWaXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyKTtcbiAgICAgICAgICAgICAgICBpbmZvLmVudk5hbWUgPSB5aWVsZCB2aXJ0dWFsRW52TWdyLmdldEVudmlyb25tZW50TmFtZShpbmZvLnBhdGgsIHJlc291cmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpbmZvLmVudk5hbWUgJiYgaW5mby5lbnZOYW1lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBlbnZTdWZmaXhQYXJ0cy5wdXNoKGAnJHtpbmZvLmVudk5hbWV9J2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGluZm8udHlwZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVySGVscGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJIZWxwZXIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBpbnRlcnByZXRlckhlbHBlci5nZXRJbnRlcnByZXRlclR5cGVEaXNwbGF5TmFtZShpbmZvLnR5cGUpO1xuICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGVudlN1ZmZpeFBhcnRzLnB1c2gobmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZW52U3VmZml4ID0gZW52U3VmZml4UGFydHMubGVuZ3RoID09PSAwID8gJycgOlxuICAgICAgICAgICAgICAgIGAoJHtlbnZTdWZmaXhQYXJ0cy5qb2luKCc6ICcpfSlgO1xuICAgICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBgJHtkaXNwbGF5TmFtZVBhcnRzLmpvaW4oJyAnKX0gJHtlbnZTdWZmaXh9YC50cmltKCk7XG4gICAgICAgICAgICAvLyBJZiBkZWFsaW5nIHdpdGggY2FjaGVkIGVudHJ5LCB0aGVuIGRvIG5vdCBzdG9yZSB0aGUgZGlzcGxheSBuYW1lIGluIGNhY2hlLlxuICAgICAgICAgICAgaWYgKCFpbmZvLmNhY2hlZEVudHJ5KSB7XG4gICAgICAgICAgICAgICAgeWllbGQgc3RvcmUudXBkYXRlVmFsdWUoZGlzcGxheU5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2hvdWxkQXV0b1NldEludGVycHJldGVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgYWN0aXZlV29ya3NwYWNlID0gdGhpcy5oZWxwZXIuZ2V0QWN0aXZlV29ya3NwYWNlVXJpKCk7XG4gICAgICAgICAgICBpZiAoIWFjdGl2ZVdvcmtzcGFjZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVdvcmtzcGFjZVNlcnZpY2UpO1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uQ29uZmlnID0gd29ya3NwYWNlU2VydmljZS5nZXRDb25maWd1cmF0aW9uKCdweXRob24nLCBhY3RpdmVXb3Jrc3BhY2UuZm9sZGVyVXJpKTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGhJbkNvbmZpZyA9IHB5dGhvbkNvbmZpZy5pbnNwZWN0KCdweXRob25QYXRoJyk7XG4gICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGEgdmFsdWUgaW4gdXNlciBzZXR0aW5ncywgdGhlbiBkb24ndCBhdXRvIHNldCB0aGUgaW50ZXJwcmV0ZXIgcGF0aC5cbiAgICAgICAgICAgIGlmIChweXRob25QYXRoSW5Db25maWcgJiYgcHl0aG9uUGF0aEluQ29uZmlnLmdsb2JhbFZhbHVlICE9PSB1bmRlZmluZWQgJiYgcHl0aG9uUGF0aEluQ29uZmlnLmdsb2JhbFZhbHVlICE9PSAncHl0aG9uJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhY3RpdmVXb3Jrc3BhY2UuY29uZmlnVGFyZ2V0ID09PSB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBweXRob25QYXRoSW5Db25maWcud29ya3NwYWNlVmFsdWUgPT09IHVuZGVmaW5lZCB8fCBweXRob25QYXRoSW5Db25maWcud29ya3NwYWNlVmFsdWUgPT09ICdweXRob24nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFjdGl2ZVdvcmtzcGFjZS5jb25maWdUYXJnZXQgPT09IHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHB5dGhvblBhdGhJbkNvbmZpZy53b3Jrc3BhY2VGb2xkZXJWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHB5dGhvblBhdGhJbkNvbmZpZy53b3Jrc3BhY2VGb2xkZXJWYWx1ZSA9PT0gJ3B5dGhvbic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5JbnRlcnByZXRlclNlcnZpY2UgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfNS5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBJbnRlcnByZXRlclNlcnZpY2UpO1xuZXhwb3J0cy5JbnRlcnByZXRlclNlcnZpY2UgPSBJbnRlcnByZXRlclNlcnZpY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1pbnRlcnByZXRlclNlcnZpY2UuanMubWFwIl19