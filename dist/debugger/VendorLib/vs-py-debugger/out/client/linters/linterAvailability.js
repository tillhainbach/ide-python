// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

const logger_1 = require("../common/logger");

const types_2 = require("../common/types");

let AvailableLinterActivator = class AvailableLinterActivator {
  constructor(appShell, installer, workspaceConfig, configService) {
    this.appShell = appShell;
    this.installer = installer;
    this.workspaceConfig = workspaceConfig;
    this.configService = configService;
  }
  /**
   * Check if it is possible to enable an otherwise-unconfigured linter in
   * the current workspace, and if so ask the user if they want that linter
   * configured explicitly.
   *
   * @param linterInfo The linter to check installation status.
   * @param resource Context for the operation (required when in multi-root workspaces).
   *
   * @returns true if configuration was updated in any way, false otherwise.
   */


  promptIfLinterAvailable(linterInfo, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      // Has the feature been enabled yet?
      if (!this.isFeatureEnabled) {
        return false;
      } // Has the linter in question has been configured explicitly? If so, no need to continue.


      if (!this.isLinterUsingDefaultConfiguration(linterInfo, resource)) {
        return false;
      } // Is the linter available in the current workspace?


      if (yield this.isLinterAvailable(linterInfo.product, resource)) {
        // great, it is - ask the user if they'd like to enable it.
        return this.promptToConfigureAvailableLinter(linterInfo);
      }

      return false;
    });
  }
  /**
   * Raise a dialog asking the user if they would like to explicitly configure a
   * linter or not in their current workspace.
   *
   * @param linterInfo The linter to ask the user to enable or not.
   *
   * @returns true if the user requested a configuration change, false otherwise.
   */


  promptToConfigureAvailableLinter(linterInfo) {
    return __awaiter(this, void 0, void 0, function* () {
      const optButtons = [{
        title: `Enable ${linterInfo.id}`,
        enabled: true
      }, {
        title: `Disable ${linterInfo.id}`,
        enabled: false
      }]; // tslint:disable-next-line:messages-must-be-localized

      const pick = yield this.appShell.showInformationMessage(`Linter ${linterInfo.id} is available but not enabled.`, ...optButtons);

      if (pick) {
        yield linterInfo.enableAsync(pick.enabled);
        return true;
      }

      return false;
    });
  }
  /**
   * Check if the linter itself is available in the workspace's Python environment or
   * not.
   *
   * @param linterProduct Linter to check in the current workspace environment.
   * @param resource Context information for workspace.
   */


  isLinterAvailable(linterProduct, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      return this.installer.isInstalled(linterProduct, resource).catch(reason => {
        // report and continue, assume the linter is unavailable.
        logger_1.traceError(`[WARNING]: Failed to discover if linter ${linterProduct} is installed.`, reason);
        return false;
      });
    });
  }
  /**
   * Check if the given linter has been configured by the user in this workspace or not.
   *
   * @param linterInfo Linter to check for configuration status.
   * @param resource Context information.
   *
   * @returns true if the linter has not been configured at the user, workspace, or workspace-folder scope. false otherwise.
   */


  isLinterUsingDefaultConfiguration(linterInfo, resource) {
    const ws = this.workspaceConfig.getConfiguration('python.linting', resource);
    const pe = ws.inspect(linterInfo.enabledSettingName);
    return pe.globalValue === undefined && pe.workspaceValue === undefined && pe.workspaceFolderValue === undefined;
  }
  /**
   * Check if this feature is enabled yet.
   *
   * This is a feature of the vscode-python extension that will become enabled once the
   * Python Language Server becomes the default, replacing Jedi as the default. Testing
   * the global default setting for `"python.jediEnabled": false` enables it.
   *
   * @returns true if the global default for python.jediEnabled is false.
   */


  get isFeatureEnabled() {
    return !this.configService.getSettings().jediEnabled;
  }

};
AvailableLinterActivator = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IInstaller)), __param(2, inversify_1.inject(types_1.IWorkspaceService)), __param(3, inversify_1.inject(types_2.IConfigurationService))], AvailableLinterActivator);
exports.AvailableLinterActivator = AvailableLinterActivator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRlckF2YWlsYWJpbGl0eS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsImxvZ2dlcl8xIiwidHlwZXNfMiIsIkF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJpbnN0YWxsZXIiLCJ3b3Jrc3BhY2VDb25maWciLCJjb25maWdTZXJ2aWNlIiwicHJvbXB0SWZMaW50ZXJBdmFpbGFibGUiLCJsaW50ZXJJbmZvIiwicmVzb3VyY2UiLCJpc0ZlYXR1cmVFbmFibGVkIiwiaXNMaW50ZXJVc2luZ0RlZmF1bHRDb25maWd1cmF0aW9uIiwiaXNMaW50ZXJBdmFpbGFibGUiLCJwcm9kdWN0IiwicHJvbXB0VG9Db25maWd1cmVBdmFpbGFibGVMaW50ZXIiLCJvcHRCdXR0b25zIiwidGl0bGUiLCJpZCIsImVuYWJsZWQiLCJwaWNrIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsImVuYWJsZUFzeW5jIiwibGludGVyUHJvZHVjdCIsImlzSW5zdGFsbGVkIiwiY2F0Y2giLCJyZWFzb24iLCJ0cmFjZUVycm9yIiwid3MiLCJnZXRDb25maWd1cmF0aW9uIiwicGUiLCJpbnNwZWN0IiwiZW5hYmxlZFNldHRpbmdOYW1lIiwiZ2xvYmFsVmFsdWUiLCJ1bmRlZmluZWQiLCJ3b3Jrc3BhY2VWYWx1ZSIsIndvcmtzcGFjZUZvbGRlclZhbHVlIiwiZ2V0U2V0dGluZ3MiLCJqZWRpRW5hYmxlZCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklJbnN0YWxsZXIiLCJJV29ya3NwYWNlU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMs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LFFBQXhELENBQVg7QUFDQSxVQUFNb0IsRUFBRSxHQUFHRixFQUFFLENBQUNHLE9BQUgsQ0FBV3RCLFVBQVUsQ0FBQ3VCLGtCQUF0QixDQUFYO0FBQ0EsV0FBUUYsRUFBRSxDQUFDRyxXQUFILEtBQW1CQyxTQUFuQixJQUFnQ0osRUFBRSxDQUFDSyxjQUFILEtBQXNCRCxTQUF0RCxJQUFtRUosRUFBRSxDQUFDTSxvQkFBSCxLQUE0QkYsU0FBdkc7QUFDSDtBQUNEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0ksTUFBSXZCLGdCQUFKLEdBQXVCO0FBQ25CLFdBQU8sQ0FBQyxLQUFLSixhQUFMLENBQW1COEIsV0FBbkIsR0FBaUNDLFdBQXpDO0FBQ0g7O0FBekd5RCxDQUE5RDtBQTJHQXBDLHdCQUF3QixHQUFHM0MsVUFBVSxDQUFDLENBQ2xDc0MsV0FBVyxDQUFDMEMsVUFBWixFQURrQyxFQUVsQ2hFLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMyQyxNQUFaLENBQW1CekMsT0FBTyxDQUFDMEMsaUJBQTNCLENBQUosQ0FGMkIsRUFHbENsRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDMkMsTUFBWixDQUFtQnZDLE9BQU8sQ0FBQ3lDLFVBQTNCLENBQUosQ0FIMkIsRUFJbENuRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDMkMsTUFBWixDQUFtQnpDLE9BQU8sQ0FBQzRDLGlCQUEzQixDQUFKLENBSjJCLEVBS2xDcEUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzJDLE1BQVosQ0FBbUJ2QyxPQUFPLENBQUMyQyxxQkFBM0IsQ0FBSixDQUwyQixDQUFELEVBTWxDMUMsd0JBTmtDLENBQXJDO0FBT0FOLE9BQU8sQ0FBQ00sd0JBQVIsR0FBbUNBLHdCQUFuQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuJ3VzZSBzdHJpY3QnO1xudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xuY29uc3QgbG9nZ2VyXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2xvZ2dlclwiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xubGV0IEF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciA9IGNsYXNzIEF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciB7XG4gICAgY29uc3RydWN0b3IoYXBwU2hlbGwsIGluc3RhbGxlciwgd29ya3NwYWNlQ29uZmlnLCBjb25maWdTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuYXBwU2hlbGwgPSBhcHBTaGVsbDtcbiAgICAgICAgdGhpcy5pbnN0YWxsZXIgPSBpbnN0YWxsZXI7XG4gICAgICAgIHRoaXMud29ya3NwYWNlQ29uZmlnID0gd29ya3NwYWNlQ29uZmlnO1xuICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UgPSBjb25maWdTZXJ2aWNlO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBpdCBpcyBwb3NzaWJsZSB0byBlbmFibGUgYW4gb3RoZXJ3aXNlLXVuY29uZmlndXJlZCBsaW50ZXIgaW5cbiAgICAgKiB0aGUgY3VycmVudCB3b3Jrc3BhY2UsIGFuZCBpZiBzbyBhc2sgdGhlIHVzZXIgaWYgdGhleSB3YW50IHRoYXQgbGludGVyXG4gICAgICogY29uZmlndXJlZCBleHBsaWNpdGx5LlxuICAgICAqXG4gICAgICogQHBhcmFtIGxpbnRlckluZm8gVGhlIGxpbnRlciB0byBjaGVjayBpbnN0YWxsYXRpb24gc3RhdHVzLlxuICAgICAqIEBwYXJhbSByZXNvdXJjZSBDb250ZXh0IGZvciB0aGUgb3BlcmF0aW9uIChyZXF1aXJlZCB3aGVuIGluIG11bHRpLXJvb3Qgd29ya3NwYWNlcykuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB0cnVlIGlmIGNvbmZpZ3VyYXRpb24gd2FzIHVwZGF0ZWQgaW4gYW55IHdheSwgZmFsc2Ugb3RoZXJ3aXNlLlxuICAgICAqL1xuICAgIHByb21wdElmTGludGVyQXZhaWxhYmxlKGxpbnRlckluZm8sIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICAvLyBIYXMgdGhlIGZlYXR1cmUgYmVlbiBlbmFibGVkIHlldD9cbiAgICAgICAgICAgIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSGFzIHRoZSBsaW50ZXIgaW4gcXVlc3Rpb24gaGFzIGJlZW4gY29uZmlndXJlZCBleHBsaWNpdGx5PyBJZiBzbywgbm8gbmVlZCB0byBjb250aW51ZS5cbiAgICAgICAgICAgIGlmICghdGhpcy5pc0xpbnRlclVzaW5nRGVmYXVsdENvbmZpZ3VyYXRpb24obGludGVySW5mbywgcmVzb3VyY2UpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSXMgdGhlIGxpbnRlciBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgd29ya3NwYWNlP1xuICAgICAgICAgICAgaWYgKHlpZWxkIHRoaXMuaXNMaW50ZXJBdmFpbGFibGUobGludGVySW5mby5wcm9kdWN0LCByZXNvdXJjZSkpIHtcbiAgICAgICAgICAgICAgICAvLyBncmVhdCwgaXQgaXMgLSBhc2sgdGhlIHVzZXIgaWYgdGhleSdkIGxpa2UgdG8gZW5hYmxlIGl0LlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByb21wdFRvQ29uZmlndXJlQXZhaWxhYmxlTGludGVyKGxpbnRlckluZm8pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogUmFpc2UgYSBkaWFsb2cgYXNraW5nIHRoZSB1c2VyIGlmIHRoZXkgd291bGQgbGlrZSB0byBleHBsaWNpdGx5IGNvbmZpZ3VyZSBhXG4gICAgICogbGludGVyIG9yIG5vdCBpbiB0aGVpciBjdXJyZW50IHdvcmtzcGFjZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBsaW50ZXJJbmZvIFRoZSBsaW50ZXIgdG8gYXNrIHRoZSB1c2VyIHRvIGVuYWJsZSBvciBub3QuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB0cnVlIGlmIHRoZSB1c2VyIHJlcXVlc3RlZCBhIGNvbmZpZ3VyYXRpb24gY2hhbmdlLCBmYWxzZSBvdGhlcndpc2UuXG4gICAgICovXG4gICAgcHJvbXB0VG9Db25maWd1cmVBdmFpbGFibGVMaW50ZXIobGludGVySW5mbykge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3Qgb3B0QnV0dG9ucyA9IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBgRW5hYmxlICR7bGludGVySW5mby5pZH1gLFxuICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiB0cnVlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBgRGlzYWJsZSAke2xpbnRlckluZm8uaWR9YCxcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZDogZmFsc2VcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lc3NhZ2VzLW11c3QtYmUtbG9jYWxpemVkXG4gICAgICAgICAgICBjb25zdCBwaWNrID0geWllbGQgdGhpcy5hcHBTaGVsbC5zaG93SW5mb3JtYXRpb25NZXNzYWdlKGBMaW50ZXIgJHtsaW50ZXJJbmZvLmlkfSBpcyBhdmFpbGFibGUgYnV0IG5vdCBlbmFibGVkLmAsIC4uLm9wdEJ1dHRvbnMpO1xuICAgICAgICAgICAgaWYgKHBpY2spIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBsaW50ZXJJbmZvLmVuYWJsZUFzeW5jKHBpY2suZW5hYmxlZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0aGUgbGludGVyIGl0c2VsZiBpcyBhdmFpbGFibGUgaW4gdGhlIHdvcmtzcGFjZSdzIFB5dGhvbiBlbnZpcm9ubWVudCBvclxuICAgICAqIG5vdC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBsaW50ZXJQcm9kdWN0IExpbnRlciB0byBjaGVjayBpbiB0aGUgY3VycmVudCB3b3Jrc3BhY2UgZW52aXJvbm1lbnQuXG4gICAgICogQHBhcmFtIHJlc291cmNlIENvbnRleHQgaW5mb3JtYXRpb24gZm9yIHdvcmtzcGFjZS5cbiAgICAgKi9cbiAgICBpc0xpbnRlckF2YWlsYWJsZShsaW50ZXJQcm9kdWN0LCByZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zdGFsbGVyLmlzSW5zdGFsbGVkKGxpbnRlclByb2R1Y3QsIHJlc291cmNlKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgocmVhc29uKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gcmVwb3J0IGFuZCBjb250aW51ZSwgYXNzdW1lIHRoZSBsaW50ZXIgaXMgdW5hdmFpbGFibGUuXG4gICAgICAgICAgICAgICAgbG9nZ2VyXzEudHJhY2VFcnJvcihgW1dBUk5JTkddOiBGYWlsZWQgdG8gZGlzY292ZXIgaWYgbGludGVyICR7bGludGVyUHJvZHVjdH0gaXMgaW5zdGFsbGVkLmAsIHJlYXNvbik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0aGUgZ2l2ZW4gbGludGVyIGhhcyBiZWVuIGNvbmZpZ3VyZWQgYnkgdGhlIHVzZXIgaW4gdGhpcyB3b3Jrc3BhY2Ugb3Igbm90LlxuICAgICAqXG4gICAgICogQHBhcmFtIGxpbnRlckluZm8gTGludGVyIHRvIGNoZWNrIGZvciBjb25maWd1cmF0aW9uIHN0YXR1cy5cbiAgICAgKiBAcGFyYW0gcmVzb3VyY2UgQ29udGV4dCBpbmZvcm1hdGlvbi5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHRydWUgaWYgdGhlIGxpbnRlciBoYXMgbm90IGJlZW4gY29uZmlndXJlZCBhdCB0aGUgdXNlciwgd29ya3NwYWNlLCBvciB3b3Jrc3BhY2UtZm9sZGVyIHNjb3BlLiBmYWxzZSBvdGhlcndpc2UuXG4gICAgICovXG4gICAgaXNMaW50ZXJVc2luZ0RlZmF1bHRDb25maWd1cmF0aW9uKGxpbnRlckluZm8sIHJlc291cmNlKSB7XG4gICAgICAgIGNvbnN0IHdzID0gdGhpcy53b3Jrc3BhY2VDb25maWcuZ2V0Q29uZmlndXJhdGlvbigncHl0aG9uLmxpbnRpbmcnLCByZXNvdXJjZSk7XG4gICAgICAgIGNvbnN0IHBlID0gd3MuaW5zcGVjdChsaW50ZXJJbmZvLmVuYWJsZWRTZXR0aW5nTmFtZSk7XG4gICAgICAgIHJldHVybiAocGUuZ2xvYmFsVmFsdWUgPT09IHVuZGVmaW5lZCAmJiBwZS53b3Jrc3BhY2VWYWx1ZSA9PT0gdW5kZWZpbmVkICYmIHBlLndvcmtzcGFjZUZvbGRlclZhbHVlID09PSB1bmRlZmluZWQpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB0aGlzIGZlYXR1cmUgaXMgZW5hYmxlZCB5ZXQuXG4gICAgICpcbiAgICAgKiBUaGlzIGlzIGEgZmVhdHVyZSBvZiB0aGUgdnNjb2RlLXB5dGhvbiBleHRlbnNpb24gdGhhdCB3aWxsIGJlY29tZSBlbmFibGVkIG9uY2UgdGhlXG4gICAgICogUHl0aG9uIExhbmd1YWdlIFNlcnZlciBiZWNvbWVzIHRoZSBkZWZhdWx0LCByZXBsYWNpbmcgSmVkaSBhcyB0aGUgZGVmYXVsdC4gVGVzdGluZ1xuICAgICAqIHRoZSBnbG9iYWwgZGVmYXVsdCBzZXR0aW5nIGZvciBgXCJweXRob24uamVkaUVuYWJsZWRcIjogZmFsc2VgIGVuYWJsZXMgaXQuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB0cnVlIGlmIHRoZSBnbG9iYWwgZGVmYXVsdCBmb3IgcHl0aG9uLmplZGlFbmFibGVkIGlzIGZhbHNlLlxuICAgICAqL1xuICAgIGdldCBpc0ZlYXR1cmVFbmFibGVkKCkge1xuICAgICAgICByZXR1cm4gIXRoaXMuY29uZmlnU2VydmljZS5nZXRTZXR0aW5ncygpLmplZGlFbmFibGVkO1xuICAgIH1cbn07XG5BdmFpbGFibGVMaW50ZXJBY3RpdmF0b3IgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSUluc3RhbGxlcikpLFxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSVdvcmtzcGFjZVNlcnZpY2UpKSxcbiAgICBfX3BhcmFtKDMsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkpXG5dLCBBdmFpbGFibGVMaW50ZXJBY3RpdmF0b3IpO1xuZXhwb3J0cy5BdmFpbGFibGVMaW50ZXJBY3RpdmF0b3IgPSBBdmFpbGFibGVMaW50ZXJBY3RpdmF0b3I7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1saW50ZXJBdmFpbGFiaWxpdHkuanMubWFwIl19