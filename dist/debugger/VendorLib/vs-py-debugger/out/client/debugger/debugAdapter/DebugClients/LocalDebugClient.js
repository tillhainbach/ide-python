"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const child_process_1 = require("child_process");

const path = require("path");

const vscode_debugadapter_1 = require("vscode-debugadapter");

const open_1 = require("../../../common/open");

const pathUtils_1 = require("../../../common/platform/pathUtils");

const currentProcess_1 = require("../../../common/process/currentProcess");

const misc_1 = require("../../../common/utils/misc");

const environment_1 = require("../../../common/variables/environment");

const types_1 = require("../../types");

const Utils_1 = require("../Common/Utils");

const LocalDebugServerV2_1 = require("../DebugServers/LocalDebugServerV2");

const DebugClient_1 = require("./DebugClient");

const helper_1 = require("./helper");

const VALID_DEBUG_OPTIONS = ['RedirectOutput', 'DebugStdLib', 'StopOnEntry', 'ShowReturnValue', 'BreakOnSystemExitZero', 'DjangoDebugging', 'Django'];
var DebugServerStatus;

(function (DebugServerStatus) {
  DebugServerStatus[DebugServerStatus["Unknown"] = 1] = "Unknown";
  DebugServerStatus[DebugServerStatus["Running"] = 2] = "Running";
  DebugServerStatus[DebugServerStatus["NotRunning"] = 3] = "NotRunning";
})(DebugServerStatus || (DebugServerStatus = {}));

class LocalDebugClient extends DebugClient_1.DebugClient {
  constructor(args, debugSession, canLaunchTerminal, launcherScriptProvider) {
    super(args, debugSession);
    this.canLaunchTerminal = canLaunchTerminal;
    this.launcherScriptProvider = launcherScriptProvider;
  }

  get debugServerStatus() {
    if (this.debugServer && this.debugServer.IsRunning) {
      return DebugServerStatus.Running;
    }

    if (this.debugServer && !this.debugServer.IsRunning) {
      return DebugServerStatus.NotRunning;
    }

    return DebugServerStatus.Unknown;
  }

  CreateDebugServer(serviceContainer) {
    this.debugServer = new LocalDebugServerV2_1.LocalDebugServerV2(this.debugSession, this.args, serviceContainer);
    return this.debugServer;
  }

  get DebugType() {
    return DebugClient_1.DebugType.Local;
  }

  Stop() {
    if (this.debugServer) {
      this.debugServer.Stop();
      this.debugServer = undefined;
    }

    if (this.pyProc) {
      this.pyProc.kill();
      this.pyProc = undefined;
    }
  } // tslint:disable-next-line:no-any


  displayError(error) {
    const errorMsg = typeof error === 'string' ? error : error.message && error.message.length > 0 ? error.message : '';

    if (errorMsg.length > 0) {
      this.debugSession.sendEvent(new vscode_debugadapter_1.OutputEvent(errorMsg, 'stderr'));
    }
  } // tslint:disable-next-line:max-func-body-length member-ordering no-any


  LaunchApplicationToDebug(dbgServer) {
    return __awaiter(this, void 0, void 0, function* () {
      const pathUtils = new pathUtils_1.PathUtils(Utils_1.IS_WINDOWS);
      const currentProcess = new currentProcess_1.CurrentProcess();
      const environmentVariablesService = new environment_1.EnvironmentVariablesService(pathUtils);
      const helper = new helper_1.DebugClientHelper(environmentVariablesService, pathUtils, currentProcess);
      const environmentVariables = yield helper.getEnvironmentVariables(this.args); // tslint:disable-next-line:max-func-body-length cyclomatic-complexity no-any

      return new Promise((resolve, reject) => {
        const fileDir = this.args && this.args.program ? path.dirname(this.args.program) : '';
        let processCwd = fileDir;

        if (typeof this.args.cwd === 'string' && this.args.cwd.length > 0 && this.args.cwd !== 'null') {
          processCwd = this.args.cwd;
        }

        let pythonPath = 'python';

        if (typeof this.args.pythonPath === 'string' && this.args.pythonPath.trim().length > 0) {
          pythonPath = this.args.pythonPath;
        }

        const args = this.buildLaunchArguments(processCwd, dbgServer.port);

        switch (this.args.console) {
          case 'externalTerminal':
          case 'integratedTerminal':
            {
              const isSudo = Array.isArray(this.args.debugOptions) && this.args.debugOptions.some(opt => opt === 'Sudo');
              this.launchExternalTerminal(isSudo, processCwd, pythonPath, args, environmentVariables).then(resolve).catch(reject);
              break;
            }

          default:
            {
              this.pyProc = child_process_1.spawn(pythonPath, args, {
                cwd: processCwd,
                env: environmentVariables
              });
              this.handleProcessOutput(this.pyProc, reject); // Here we wait for the application to connect to the socket server.
              // Only once connected do we know that the application has successfully launched.

              this.debugServer.DebugClientConnected.then(resolve).catch(ex => console.error('Python Extension: debugServer.DebugClientConnected', ex));
            }
        }
      });
    });
  } // tslint:disable-next-line:member-ordering


  handleProcessOutput(proc, failedToLaunch) {
    proc.on('error', error => {
      // If debug server has started, then don't display errors.
      // The debug adapter will get this info from the debugger (e.g. ptvsd lib).
      const status = this.debugServerStatus;

      if (status === DebugServerStatus.Running) {
        return;
      }

      if (status === DebugServerStatus.NotRunning && typeof error === 'object' && error !== null) {
        return failedToLaunch(error);
      } // This could happen when the debugger didn't launch at all, e.g. python doesn't exist.


      this.displayError(error);
    });
    proc.stderr.setEncoding('utf8');
    proc.stderr.on('data', misc_1.noop);
    proc.stdout.on('data', d => {
      // This is necessary so we read the stdout of the python process,
      // Else it just keep building up (related to issue #203 and #52).
      // tslint:disable-next-line:prefer-const no-unused-variable
      let x = 0;
    });
  }

  buildLaunchArguments(cwd, debugPort) {
    return [...this.buildDebugArguments(cwd, debugPort), ...this.buildStandardArguments()];
  } // tslint:disable-next-line:member-ordering


  buildDebugArguments(cwd, debugPort) {
    const ptVSToolsFilePath = this.launcherScriptProvider.getLauncherFilePath();
    const vsDebugOptions = [types_1.DebugOptions.RedirectOutput];

    if (Array.isArray(this.args.debugOptions)) {
      this.args.debugOptions.filter(opt => VALID_DEBUG_OPTIONS.indexOf(opt) >= 0).forEach(item => vsDebugOptions.push(item));
    }

    const djangoIndex = vsDebugOptions.indexOf(types_1.DebugOptions.Django); // PTVSD expects the string `DjangoDebugging`

    if (djangoIndex >= 0) {
      vsDebugOptions[djangoIndex] = 'DjangoDebugging';
    }

    return [ptVSToolsFilePath, cwd, debugPort.toString(), '34806ad9-833a-4524-8cd6-18ca4aa74f14', vsDebugOptions.join(',')];
  } // tslint:disable-next-line:member-ordering


  buildStandardArguments() {
    const programArgs = Array.isArray(this.args.args) && this.args.args.length > 0 ? this.args.args : [];

    if (typeof this.args.module === 'string' && this.args.module.length > 0) {
      return ['-m', this.args.module, ...programArgs];
    }

    if (this.args.program && this.args.program.length > 0) {
      return [this.args.program, ...programArgs];
    }

    return programArgs;
  }

  launchExternalTerminal(sudo, cwd, pythonPath, args, env) {
    return new Promise((resolve, reject) => {
      if (this.canLaunchTerminal) {
        const command = sudo ? 'sudo' : pythonPath;
        const commandArgs = sudo ? [pythonPath].concat(args) : args;
        const isExternalTerminal = this.args.console === 'externalTerminal';
        const consoleKind = isExternalTerminal ? 'external' : 'integrated';
        const termArgs = {
          kind: consoleKind,
          title: 'Python Debug Console',
          cwd,
          args: [command].concat(commandArgs),
          env
        };
        this.debugSession.runInTerminalRequest(termArgs, 5000, response => {
          if (response.success) {
            resolve();
          } else {
            reject(response);
          }
        });
      } else {
        open_1.open({
          wait: false,
          app: [pythonPath].concat(args),
          cwd,
          env,
          sudo: sudo
        }).then(proc => {
          this.pyProc = proc;
          resolve();
        }, error => {
          if (this.debugServerStatus === DebugServerStatus.Running) {
            return;
          }

          reject(error);
        });
      }
    });
  }

}

exports.LocalDebugClient = LocalDebugClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkxvY2FsRGVidWdDbGllbnQuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoaWxkX3Byb2Nlc3NfMSIsInJlcXVpcmUiLCJwYXRoIiwidnNjb2RlX2RlYnVnYWRhcHRlcl8xIiwib3Blbl8xIiwicGF0aFV0aWxzXzEiLCJjdXJyZW50UHJvY2Vzc18xIiwibWlzY18xIiwiZW52aXJvbm1lbnRfMSIsInR5cGVzXzEiLCJVdGlsc18xIiwiTG9jYWxEZWJ1Z1NlcnZlclYyXzEiLCJEZWJ1Z0NsaWVudF8xIiwiaGVscGVyXzEiLCJWQUxJRF9ERUJVR19PUFRJT05TIiwiRGVidWdTZXJ2ZXJTdGF0dXMiLCJMb2NhbERlYnVnQ2xpZW50IiwiRGVidWdDbGllbnQiLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJkZWJ1Z1Nlc3Npb24iLCJjYW5MYXVuY2hUZXJtaW5hbCIsImxhdW5jaGVyU2NyaXB0UHJvdmlkZXIiLCJkZWJ1Z1NlcnZlclN0YXR1cyIsImRlYnVnU2VydmVyIiwiSXNSdW5uaW5nIiwiUnVubmluZyIsIk5vdFJ1bm5pbmciLCJVbmtub3duIiwiQ3JlYXRlRGVidWdTZXJ2ZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiTG9jYWxEZWJ1Z1NlcnZlclYyIiwiRGVidWdUeXBlIiwiTG9jYWwiLCJTdG9wIiwidW5kZWZpbmVkIiwicHlQcm9jIiwia2lsbCIsImRpc3BsYXlFcnJvciIsImVycm9yIiwiZXJyb3JNc2ciLCJtZXNzYWdlIiwibGVuZ3RoIiwic2VuZEV2ZW50IiwiT3V0cHV0RXZlbnQiLCJMYXVuY2hBcHBsaWNhdGlvblRvRGVidWciLCJkYmdTZXJ2ZXIiLCJwYXRoVXRpbHMiLCJQYXRoVXRpbHMiLCJJU19XSU5ET1dTIiwiY3VycmVudFByb2Nlc3MiLCJDdXJyZW50UHJvY2VzcyIsImVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSIsIkVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSIsImhlbHBlciIsIkRlYnVnQ2xpZW50SGVscGVyIiwiZW52aXJvbm1lbnRWYXJpYWJsZXMiLCJnZXRFbnZpcm9ubWVudFZhcmlhYmxlcyIsImZpbGVEaXIiLCJwcm9ncmFtIiwiZGlybmFtZSIsInByb2Nlc3NDd2QiLCJjd2QiLCJweXRob25QYXRoIiwidHJpbSIsImJ1aWxkTGF1bmNoQXJndW1lbnRzIiwicG9ydCIsImNvbnNvbGUiLCJpc1N1ZG8iLCJBcnJheSIsImlzQXJyYXkiLCJkZWJ1Z09wdGlvbnMiLCJzb21lIiwib3B0IiwibGF1bmNoRXh0ZXJuYWxUZXJtaW5hbCIsImNhdGNoIiwic3Bhd24iLCJlbnYiLCJoYW5kbGVQcm9jZXNzT3V0cHV0IiwiRGVidWdDbGllbnRDb25uZWN0ZWQiLCJleCIsInByb2MiLCJmYWlsZWRUb0xhdW5jaCIsIm9uIiwic3RhdHVzIiwic3RkZXJyIiwic2V0RW5jb2RpbmciLCJub29wIiwic3Rkb3V0IiwiZCIsIngiLCJkZWJ1Z1BvcnQiLCJidWlsZERlYnVnQXJndW1lbnRzIiwiYnVpbGRTdGFuZGFyZEFyZ3VtZW50cyIsInB0VlNUb29sc0ZpbGVQYXRoIiwiZ2V0TGF1bmNoZXJGaWxlUGF0aCIsInZzRGVidWdPcHRpb25zIiwiRGVidWdPcHRpb25zIiwiUmVkaXJlY3RPdXRwdXQiLCJmaWx0ZXIiLCJpbmRleE9mIiwiZm9yRWFjaCIsIml0ZW0iLCJwdXNoIiwiZGphbmdvSW5kZXgiLCJEamFuZ28iLCJ0b1N0cmluZyIsImpvaW4iLCJwcm9ncmFtQXJncyIsIm1vZHVsZSIsInN1ZG8iLCJjb21tYW5kIiwiY29tbWFuZEFyZ3MiLCJjb25jYXQiLCJpc0V4dGVybmFsVGVybWluYWwiLCJjb25zb2xlS2luZCIsInRlcm1BcmdzIiwia2luZCIsInRpdGxlIiwicnVuSW5UZXJtaW5hbFJlcXVlc3QiLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJvcGVuIiwid2FpdCIsImFwcCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBUDtBQUF3QixPQUFuRCxFQUFxRE8sSUFBckQsQ0FBMERSLFNBQTFELEVBQXFFSyxR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YXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBjaGlsZF9wcm9jZXNzXzEgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHZzY29kZV9kZWJ1Z2FkYXB0ZXJfMSA9IHJlcXVpcmUoXCJ2c2NvZGUtZGVidWdhZGFwdGVyXCIpO1xuY29uc3Qgb3Blbl8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9vcGVuXCIpO1xuY29uc3QgcGF0aFV0aWxzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3BsYXRmb3JtL3BhdGhVdGlsc1wiKTtcbmNvbnN0IGN1cnJlbnRQcm9jZXNzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3Byb2Nlc3MvY3VycmVudFByb2Nlc3NcIik7XG5jb25zdCBtaXNjXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3V0aWxzL21pc2NcIik7XG5jb25zdCBlbnZpcm9ubWVudF8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi92YXJpYWJsZXMvZW52aXJvbm1lbnRcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL3R5cGVzXCIpO1xuY29uc3QgVXRpbHNfMSA9IHJlcXVpcmUoXCIuLi9Db21tb24vVXRpbHNcIik7XG5jb25zdCBMb2NhbERlYnVnU2VydmVyVjJfMSA9IHJlcXVpcmUoXCIuLi9EZWJ1Z1NlcnZlcnMvTG9jYWxEZWJ1Z1NlcnZlclYyXCIpO1xuY29uc3QgRGVidWdDbGllbnRfMSA9IHJlcXVpcmUoXCIuL0RlYnVnQ2xpZW50XCIpO1xuY29uc3QgaGVscGVyXzEgPSByZXF1aXJlKFwiLi9oZWxwZXJcIik7XG5jb25zdCBWQUxJRF9ERUJVR19PUFRJT05TID0gW1xuICAgICdSZWRpcmVjdE91dHB1dCcsXG4gICAgJ0RlYnVnU3RkTGliJyxcbiAgICAnU3RvcE9uRW50cnknLFxuICAgICdTaG93UmV0dXJuVmFsdWUnLFxuICAgICdCcmVha09uU3lzdGVtRXhpdFplcm8nLFxuICAgICdEamFuZ29EZWJ1Z2dpbmcnLFxuICAgICdEamFuZ28nXG5dO1xudmFyIERlYnVnU2VydmVyU3RhdHVzO1xuKGZ1bmN0aW9uIChEZWJ1Z1NlcnZlclN0YXR1cykge1xuICAgIERlYnVnU2VydmVyU3RhdHVzW0RlYnVnU2VydmVyU3RhdHVzW1wiVW5rbm93blwiXSA9IDFdID0gXCJVbmtub3duXCI7XG4gICAgRGVidWdTZXJ2ZXJTdGF0dXNbRGVidWdTZXJ2ZXJTdGF0dXNbXCJSdW5uaW5nXCJdID0gMl0gPSBcIlJ1bm5pbmdcIjtcbiAgICBEZWJ1Z1NlcnZlclN0YXR1c1tEZWJ1Z1NlcnZlclN0YXR1c1tcIk5vdFJ1bm5pbmdcIl0gPSAzXSA9IFwiTm90UnVubmluZ1wiO1xufSkoRGVidWdTZXJ2ZXJTdGF0dXMgfHwgKERlYnVnU2VydmVyU3RhdHVzID0ge30pKTtcbmNsYXNzIExvY2FsRGVidWdDbGllbnQgZXh0ZW5kcyBEZWJ1Z0NsaWVudF8xLkRlYnVnQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihhcmdzLCBkZWJ1Z1Nlc3Npb24sIGNhbkxhdW5jaFRlcm1pbmFsLCBsYXVuY2hlclNjcmlwdFByb3ZpZGVyKSB7XG4gICAgICAgIHN1cGVyKGFyZ3MsIGRlYnVnU2Vzc2lvbik7XG4gICAgICAgIHRoaXMuY2FuTGF1bmNoVGVybWluYWwgPSBjYW5MYXVuY2hUZXJtaW5hbDtcbiAgICAgICAgdGhpcy5sYXVuY2hlclNjcmlwdFByb3ZpZGVyID0gbGF1bmNoZXJTY3JpcHRQcm92aWRlcjtcbiAgICB9XG4gICAgZ2V0IGRlYnVnU2VydmVyU3RhdHVzKCkge1xuICAgICAgICBpZiAodGhpcy5kZWJ1Z1NlcnZlciAmJiB0aGlzLmRlYnVnU2VydmVyLklzUnVubmluZykge1xuICAgICAgICAgICAgcmV0dXJuIERlYnVnU2VydmVyU3RhdHVzLlJ1bm5pbmc7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZGVidWdTZXJ2ZXIgJiYgIXRoaXMuZGVidWdTZXJ2ZXIuSXNSdW5uaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gRGVidWdTZXJ2ZXJTdGF0dXMuTm90UnVubmluZztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gRGVidWdTZXJ2ZXJTdGF0dXMuVW5rbm93bjtcbiAgICB9XG4gICAgQ3JlYXRlRGVidWdTZXJ2ZXIoc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLmRlYnVnU2VydmVyID0gbmV3IExvY2FsRGVidWdTZXJ2ZXJWMl8xLkxvY2FsRGVidWdTZXJ2ZXJWMih0aGlzLmRlYnVnU2Vzc2lvbiwgdGhpcy5hcmdzLCBzZXJ2aWNlQ29udGFpbmVyKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGVidWdTZXJ2ZXI7XG4gICAgfVxuICAgIGdldCBEZWJ1Z1R5cGUoKSB7XG4gICAgICAgIHJldHVybiBEZWJ1Z0NsaWVudF8xLkRlYnVnVHlwZS5Mb2NhbDtcbiAgICB9XG4gICAgU3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZGVidWdTZXJ2ZXIpIHtcbiAgICAgICAgICAgIHRoaXMuZGVidWdTZXJ2ZXIuU3RvcCgpO1xuICAgICAgICAgICAgdGhpcy5kZWJ1Z1NlcnZlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5weVByb2MpIHtcbiAgICAgICAgICAgIHRoaXMucHlQcm9jLmtpbGwoKTtcbiAgICAgICAgICAgIHRoaXMucHlQcm9jID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcbiAgICBkaXNwbGF5RXJyb3IoZXJyb3IpIHtcbiAgICAgICAgY29uc3QgZXJyb3JNc2cgPSB0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnID8gZXJyb3IgOiAoKGVycm9yLm1lc3NhZ2UgJiYgZXJyb3IubWVzc2FnZS5sZW5ndGggPiAwKSA/IGVycm9yLm1lc3NhZ2UgOiAnJyk7XG4gICAgICAgIGlmIChlcnJvck1zZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmRlYnVnU2Vzc2lvbi5zZW5kRXZlbnQobmV3IHZzY29kZV9kZWJ1Z2FkYXB0ZXJfMS5PdXRwdXRFdmVudChlcnJvck1zZywgJ3N0ZGVycicpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGggbWVtYmVyLW9yZGVyaW5nIG5vLWFueVxuICAgIExhdW5jaEFwcGxpY2F0aW9uVG9EZWJ1ZyhkYmdTZXJ2ZXIpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGhVdGlscyA9IG5ldyBwYXRoVXRpbHNfMS5QYXRoVXRpbHMoVXRpbHNfMS5JU19XSU5ET1dTKTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQcm9jZXNzID0gbmV3IGN1cnJlbnRQcm9jZXNzXzEuQ3VycmVudFByb2Nlc3MoKTtcbiAgICAgICAgICAgIGNvbnN0IGVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSA9IG5ldyBlbnZpcm9ubWVudF8xLkVudmlyb25tZW50VmFyaWFibGVzU2VydmljZShwYXRoVXRpbHMpO1xuICAgICAgICAgICAgY29uc3QgaGVscGVyID0gbmV3IGhlbHBlcl8xLkRlYnVnQ2xpZW50SGVscGVyKGVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSwgcGF0aFV0aWxzLCBjdXJyZW50UHJvY2Vzcyk7XG4gICAgICAgICAgICBjb25zdCBlbnZpcm9ubWVudFZhcmlhYmxlcyA9IHlpZWxkIGhlbHBlci5nZXRFbnZpcm9ubWVudFZhcmlhYmxlcyh0aGlzLmFyZ3MpO1xuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoIGN5Y2xvbWF0aWMtY29tcGxleGl0eSBuby1hbnlcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZURpciA9IHRoaXMuYXJncyAmJiB0aGlzLmFyZ3MucHJvZ3JhbSA/IHBhdGguZGlybmFtZSh0aGlzLmFyZ3MucHJvZ3JhbSkgOiAnJztcbiAgICAgICAgICAgICAgICBsZXQgcHJvY2Vzc0N3ZCA9IGZpbGVEaXI7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmFyZ3MuY3dkID09PSAnc3RyaW5nJyAmJiB0aGlzLmFyZ3MuY3dkLmxlbmd0aCA+IDAgJiYgdGhpcy5hcmdzLmN3ZCAhPT0gJ251bGwnKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3NDd2QgPSB0aGlzLmFyZ3MuY3dkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsZXQgcHl0aG9uUGF0aCA9ICdweXRob24nO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5hcmdzLnB5dGhvblBhdGggPT09ICdzdHJpbmcnICYmIHRoaXMuYXJncy5weXRob25QYXRoLnRyaW0oKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHB5dGhvblBhdGggPSB0aGlzLmFyZ3MucHl0aG9uUGF0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgYXJncyA9IHRoaXMuYnVpbGRMYXVuY2hBcmd1bWVudHMocHJvY2Vzc0N3ZCwgZGJnU2VydmVyLnBvcnQpO1xuICAgICAgICAgICAgICAgIHN3aXRjaCAodGhpcy5hcmdzLmNvbnNvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZXh0ZXJuYWxUZXJtaW5hbCc6XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ludGVncmF0ZWRUZXJtaW5hbCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzU3VkbyA9IEFycmF5LmlzQXJyYXkodGhpcy5hcmdzLmRlYnVnT3B0aW9ucykgJiYgdGhpcy5hcmdzLmRlYnVnT3B0aW9ucy5zb21lKG9wdCA9PiBvcHQgPT09ICdTdWRvJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdW5jaEV4dGVybmFsVGVybWluYWwoaXNTdWRvLCBwcm9jZXNzQ3dkLCBweXRob25QYXRoLCBhcmdzLCBlbnZpcm9ubWVudFZhcmlhYmxlcykudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5weVByb2MgPSBjaGlsZF9wcm9jZXNzXzEuc3Bhd24ocHl0aG9uUGF0aCwgYXJncywgeyBjd2Q6IHByb2Nlc3NDd2QsIGVudjogZW52aXJvbm1lbnRWYXJpYWJsZXMgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVByb2Nlc3NPdXRwdXQodGhpcy5weVByb2MsIHJlamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIZXJlIHdlIHdhaXQgZm9yIHRoZSBhcHBsaWNhdGlvbiB0byBjb25uZWN0IHRvIHRoZSBzb2NrZXQgc2VydmVyLlxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBvbmNlIGNvbm5lY3RlZCBkbyB3ZSBrbm93IHRoYXQgdGhlIGFwcGxpY2F0aW9uIGhhcyBzdWNjZXNzZnVsbHkgbGF1bmNoZWQuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYnVnU2VydmVyLkRlYnVnQ2xpZW50Q29ubmVjdGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzb2x2ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gY29uc29sZS5lcnJvcignUHl0aG9uIEV4dGVuc2lvbjogZGVidWdTZXJ2ZXIuRGVidWdDbGllbnRDb25uZWN0ZWQnLCBleCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVtYmVyLW9yZGVyaW5nXG4gICAgaGFuZGxlUHJvY2Vzc091dHB1dChwcm9jLCBmYWlsZWRUb0xhdW5jaCkge1xuICAgICAgICBwcm9jLm9uKCdlcnJvcicsIGVycm9yID0+IHtcbiAgICAgICAgICAgIC8vIElmIGRlYnVnIHNlcnZlciBoYXMgc3RhcnRlZCwgdGhlbiBkb24ndCBkaXNwbGF5IGVycm9ycy5cbiAgICAgICAgICAgIC8vIFRoZSBkZWJ1ZyBhZGFwdGVyIHdpbGwgZ2V0IHRoaXMgaW5mbyBmcm9tIHRoZSBkZWJ1Z2dlciAoZS5nLiBwdHZzZCBsaWIpLlxuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gdGhpcy5kZWJ1Z1NlcnZlclN0YXR1cztcbiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IERlYnVnU2VydmVyU3RhdHVzLlJ1bm5pbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3RhdHVzID09PSBEZWJ1Z1NlcnZlclN0YXR1cy5Ob3RSdW5uaW5nICYmIHR5cGVvZiAoZXJyb3IpID09PSAnb2JqZWN0JyAmJiBlcnJvciAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWlsZWRUb0xhdW5jaChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiB3aGVuIHRoZSBkZWJ1Z2dlciBkaWRuJ3QgbGF1bmNoIGF0IGFsbCwgZS5nLiBweXRob24gZG9lc24ndCBleGlzdC5cbiAgICAgICAgICAgIHRoaXMuZGlzcGxheUVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByb2Muc3RkZXJyLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICAgIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgbWlzY18xLm5vb3ApO1xuICAgICAgICBwcm9jLnN0ZG91dC5vbignZGF0YScsIGQgPT4ge1xuICAgICAgICAgICAgLy8gVGhpcyBpcyBuZWNlc3Nhcnkgc28gd2UgcmVhZCB0aGUgc3Rkb3V0IG9mIHRoZSBweXRob24gcHJvY2VzcyxcbiAgICAgICAgICAgIC8vIEVsc2UgaXQganVzdCBrZWVwIGJ1aWxkaW5nIHVwIChyZWxhdGVkIHRvIGlzc3VlICMyMDMgYW5kICM1MikuXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWNvbnN0IG5vLXVudXNlZC12YXJpYWJsZVxuICAgICAgICAgICAgbGV0IHggPSAwO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgYnVpbGRMYXVuY2hBcmd1bWVudHMoY3dkLCBkZWJ1Z1BvcnQpIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLmJ1aWxkRGVidWdBcmd1bWVudHMoY3dkLCBkZWJ1Z1BvcnQpLCAuLi50aGlzLmJ1aWxkU3RhbmRhcmRBcmd1bWVudHMoKV07XG4gICAgfVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptZW1iZXItb3JkZXJpbmdcbiAgICBidWlsZERlYnVnQXJndW1lbnRzKGN3ZCwgZGVidWdQb3J0KSB7XG4gICAgICAgIGNvbnN0IHB0VlNUb29sc0ZpbGVQYXRoID0gdGhpcy5sYXVuY2hlclNjcmlwdFByb3ZpZGVyLmdldExhdW5jaGVyRmlsZVBhdGgoKTtcbiAgICAgICAgY29uc3QgdnNEZWJ1Z09wdGlvbnMgPSBbdHlwZXNfMS5EZWJ1Z09wdGlvbnMuUmVkaXJlY3RPdXRwdXRdO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmFyZ3MuZGVidWdPcHRpb25zKSkge1xuICAgICAgICAgICAgdGhpcy5hcmdzLmRlYnVnT3B0aW9ucy5maWx0ZXIob3B0ID0+IFZBTElEX0RFQlVHX09QVElPTlMuaW5kZXhPZihvcHQpID49IDApXG4gICAgICAgICAgICAgICAgLmZvckVhY2goaXRlbSA9PiB2c0RlYnVnT3B0aW9ucy5wdXNoKGl0ZW0pKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkamFuZ29JbmRleCA9IHZzRGVidWdPcHRpb25zLmluZGV4T2YodHlwZXNfMS5EZWJ1Z09wdGlvbnMuRGphbmdvKTtcbiAgICAgICAgLy8gUFRWU0QgZXhwZWN0cyB0aGUgc3RyaW5nIGBEamFuZ29EZWJ1Z2dpbmdgXG4gICAgICAgIGlmIChkamFuZ29JbmRleCA+PSAwKSB7XG4gICAgICAgICAgICB2c0RlYnVnT3B0aW9uc1tkamFuZ29JbmRleF0gPSAnRGphbmdvRGVidWdnaW5nJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW3B0VlNUb29sc0ZpbGVQYXRoLCBjd2QsIGRlYnVnUG9ydC50b1N0cmluZygpLCAnMzQ4MDZhZDktODMzYS00NTI0LThjZDYtMThjYTRhYTc0ZjE0JywgdnNEZWJ1Z09wdGlvbnMuam9pbignLCcpXTtcbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xuICAgIGJ1aWxkU3RhbmRhcmRBcmd1bWVudHMoKSB7XG4gICAgICAgIGNvbnN0IHByb2dyYW1BcmdzID0gQXJyYXkuaXNBcnJheSh0aGlzLmFyZ3MuYXJncykgJiYgdGhpcy5hcmdzLmFyZ3MubGVuZ3RoID4gMCA/IHRoaXMuYXJncy5hcmdzIDogW107XG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5hcmdzLm1vZHVsZSA9PT0gJ3N0cmluZycgJiYgdGhpcy5hcmdzLm1vZHVsZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gWyctbScsIHRoaXMuYXJncy5tb2R1bGUsIC4uLnByb2dyYW1BcmdzXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5hcmdzLnByb2dyYW0gJiYgdGhpcy5hcmdzLnByb2dyYW0ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFt0aGlzLmFyZ3MucHJvZ3JhbSwgLi4ucHJvZ3JhbUFyZ3NdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwcm9ncmFtQXJncztcbiAgICB9XG4gICAgbGF1bmNoRXh0ZXJuYWxUZXJtaW5hbChzdWRvLCBjd2QsIHB5dGhvblBhdGgsIGFyZ3MsIGVudikge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuY2FuTGF1bmNoVGVybWluYWwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gc3VkbyA/ICdzdWRvJyA6IHB5dGhvblBhdGg7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZEFyZ3MgPSBzdWRvID8gW3B5dGhvblBhdGhdLmNvbmNhdChhcmdzKSA6IGFyZ3M7XG4gICAgICAgICAgICAgICAgY29uc3QgaXNFeHRlcm5hbFRlcm1pbmFsID0gdGhpcy5hcmdzLmNvbnNvbGUgPT09ICdleHRlcm5hbFRlcm1pbmFsJztcbiAgICAgICAgICAgICAgICBjb25zdCBjb25zb2xlS2luZCA9IGlzRXh0ZXJuYWxUZXJtaW5hbCA/ICdleHRlcm5hbCcgOiAnaW50ZWdyYXRlZCc7XG4gICAgICAgICAgICAgICAgY29uc3QgdGVybUFyZ3MgPSB7XG4gICAgICAgICAgICAgICAgICAgIGtpbmQ6IGNvbnNvbGVLaW5kLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ1B5dGhvbiBEZWJ1ZyBDb25zb2xlJyxcbiAgICAgICAgICAgICAgICAgICAgY3dkLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiBbY29tbWFuZF0uY29uY2F0KGNvbW1hbmRBcmdzKSxcbiAgICAgICAgICAgICAgICAgICAgZW52XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnU2Vzc2lvbi5ydW5JblRlcm1pbmFsUmVxdWVzdCh0ZXJtQXJncywgNTAwMCwgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcGVuXzEub3Blbih7IHdhaXQ6IGZhbHNlLCBhcHA6IFtweXRob25QYXRoXS5jb25jYXQoYXJncyksIGN3ZCwgZW52LCBzdWRvOiBzdWRvIH0pLnRoZW4ocHJvYyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHlQcm9jID0gcHJvYztcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWdTZXJ2ZXJTdGF0dXMgPT09IERlYnVnU2VydmVyU3RhdHVzLlJ1bm5pbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG5leHBvcnRzLkxvY2FsRGVidWdDbGllbnQgPSBMb2NhbERlYnVnQ2xpZW50O1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9TG9jYWxEZWJ1Z0NsaWVudC5qcy5tYXAiXX0=