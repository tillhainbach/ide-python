"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setRpcService = setRpcService;
exports.listenToRemoteDebugCommands = listenToRemoteDebugCommands;
exports.getRemoteDebuggerCommandServiceByNuclideUri = getRemoteDebuggerCommandServiceByNuclideUri;

var _debugger = require("@atom-ide-community/nuclide-commons-atom/debugger");

var _projects = require("@atom-ide-community/nuclide-commons-atom/projects");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

var RemoteDebuggerCommandServiceLocal = _interopRequireWildcard(require("./RemoteDebuggerCommandService"));

var _nullthrows = _interopRequireDefault(require("nullthrows"));

var _log4js = require("log4js");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let _rpcService = null;

function getPythonAttachTargetProcessConfig(targetRootUri, target) {
  return {
    targetUri: targetRootUri,
    debugMode: 'attach',
    adapterType: "python",
    config: getPythonAttachTargetConfig(target),
    servicedFileExtensions: ['py']
  };
}

function getPythonAttachTargetConfig(target) {
  return {
    localRoot: target.localRoot,
    remoteRoot: target.remoteRoot,
    port: target.port,
    host: '127.0.0.1'
  };
}

function setRpcService(rpcService) {
  _rpcService = rpcService;
  return new _UniversalDisposable.default(() => {
    _rpcService = null;
  });
}

function listenToRemoteDebugCommands() {
  const addedHostnames = (0, _projects.observeAddedHostnames)().startWith('local');
  const remoteDebuggerServices = addedHostnames.flatMap(hostname => {
    const rootUri = hostname === 'local' ? '' : _nuclideUri.default.createRemoteUri(hostname, '/');
    const service = getRemoteDebuggerCommandServiceByNuclideUri(rootUri);

    if (service == null) {
      (0, _log4js.getLogger)().error('null remote command service for uri:', rootUri);
      return _rxjsCompatUmdMin.Observable.empty();
    } else {
      return _rxjsCompatUmdMin.Observable.of({
        service,
        rootUri
      });
    }
  });
  return new _UniversalDisposable.default(remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeAttachDebugTargets().refCount().map(targets => findDuplicateAttachTargetIds(targets));
  }).subscribe(duplicateTargetIds => notifyDuplicateDebugTargets(duplicateTargetIds)), remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeRemoteDebugCommands().refCount().catch(error => {
      // eslint-disable-next-line no-console
      console.warn('Failed to listen to remote debug commands - ' + 'You could be running locally with two Atom windows. ' + `IsLocal: ${String(rootUri === '')}`);
      return _rxjsCompatUmdMin.Observable.empty();
    }).map(command => ({
      rootUri,
      command
    }));
  }).let((0, _observable.fastDebounce)(500)).subscribe(async ({
    rootUri,
    command
  }) => {
    const attachProcessConfig = getPythonAttachTargetProcessConfig(rootUri, command.target);
    const debuggerService = await (0, _debugger.getDebuggerService)();
    (0, _analytics.track)('fb-python-debugger-auto-attach');
    debuggerService.startVspDebugging(attachProcessConfig); // Otherwise, we're already debugging that target.
  }));
}

let shouldNotifyDuplicateTargets = true;
let duplicateTargetsNotification;

function notifyDuplicateDebugTargets(duplicateTargetIds) {
  if (duplicateTargetIds.size > 0 && shouldNotifyDuplicateTargets && duplicateTargetsNotification == null) {
    const formattedIds = Array.from(duplicateTargetIds).join(', ');
    duplicateTargetsNotification = atom.notifications.addInfo(`Debugger: duplicate attach targets: \`${formattedIds}\``, {
      buttons: [{
        onDidClick: () => {
          shouldNotifyDuplicateTargets = false;

          if (duplicateTargetsNotification != null) {
            duplicateTargetsNotification.dismiss();
          }
        },
        text: 'Ignore'
      }],
      description: `Nuclide debugger detected duplicate attach targets with ids (${formattedIds}) ` + 'That could be instagram running multiple processes - check out https://our.intern.facebook.com/intern/dex/instagram-server/debugging-with-nuclide/',
      dismissable: true
    });
    duplicateTargetsNotification.onDidDismiss(() => {
      duplicateTargetsNotification = null;
    });
  }
}

function findDuplicateAttachTargetIds(targets) {
  const targetIds = new Set();
  const duplicateTargetIds = new Set();
  targets.forEach(target => {
    const {
      id
    } = target;

    if (id == null) {
      return;
    }

    if (targetIds.has(id)) {
      duplicateTargetIds.add(id);
    } else {
      targetIds.add(id);
    }
  });
  return duplicateTargetIds;
}

function getRemoteDebuggerCommandServiceByNuclideUri(uri) {
  if (_rpcService == null && !_nuclideUri.default.isRemote(uri)) {
    return RemoteDebuggerCommandServiceLocal;
  }

  return (0, _nullthrows.default)(_rpcService).getServiceByNuclideUri('RemoteDebuggerCommandService', uri);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9ycGNTZXJ2aWNlIiwiZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyIsInRhcmdldFJvb3RVcmkiLCJ0YXJnZXQiLCJ0YXJnZXRVcmkiLCJkZWJ1Z01vZGUiLCJhZGFwdGVyVHlwZSIsImNvbmZpZyIsImdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyIsInNlcnZpY2VkRmlsZUV4dGVuc2lvbnMiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwicG9ydCIsImhvc3QiLCJzZXRScGNTZXJ2aWNlIiwicnBjU2VydmljZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMiLCJhZGRlZEhvc3RuYW1lcyIsInN0YXJ0V2l0aCIsInJlbW90ZURlYnVnZ2VyU2VydmljZXMiLCJmbGF0TWFwIiwiaG9zdG5hbWUiLCJyb290VXJpIiwibnVjbGlkZVVyaSIsImNyZWF0ZVJlbW90ZVVyaSIsInNlcnZpY2UiLCJnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpIiwiZXJyb3IiLCJPYnNlcnZhYmxlIiwiZW1wdHkiLCJvZiIsIm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMiLCJyZWZDb3VudCIsIm1hcCIsInRhcmdldHMiLCJmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzIiwic3Vic2NyaWJlIiwiZHVwbGljYXRlVGFyZ2V0SWRzIiwibm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJjYXRjaCIsImNvbnNvbGUiLCJ3YXJuIiwiU3RyaW5nIiwiY29tbWFuZCIsImxldCIsImF0dGFjaFByb2Nlc3NDb25maWciLCJkZWJ1Z2dlclNlcnZpY2UiLCJzdGFydFZzcERlYnVnZ2luZyIsInNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMiLCJkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uIiwic2l6ZSIsImZvcm1hdHRlZElkcyIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFkZEluZm8iLCJidXR0b25zIiwib25EaWRDbGljayIsImRpc21pc3MiLCJ0ZXh0IiwiZGVzY3JpcHRpb24iLCJkaXNtaXNzYWJsZSIsIm9uRGlkRGlzbWlzcyIsInRhcmdldElkcyIsIlNldCIsImZvckVhY2giLCJpZCIsImhhcyIsImFkZCIsInVyaSIsImlzUmVtb3RlIiwiUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIiwiZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBUUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBSUEsV0FBZ0MsR0FBRyxJQUF2Qzs7QUFFQSxTQUFTQyxrQ0FBVCxDQUNFQyxhQURGLEVBRUVDLE1BRkYsRUFHa0I7QUFDaEIsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUVGLGFBRE47QUFFTEcsSUFBQUEsU0FBUyxFQUFFLFFBRk47QUFHTEMsSUFBQUEsV0FBVyxFQUFFLFFBSFI7QUFJTEMsSUFBQUEsTUFBTSxFQUFFQywyQkFBMkIsQ0FBQ0wsTUFBRCxDQUo5QjtBQUtMTSxJQUFBQSxzQkFBc0IsRUFBRSxDQUFDLElBQUQ7QUFMbkIsR0FBUDtBQU9EOztBQUVELFNBQVNELDJCQUFULENBQ0VMLE1BREYsRUFFVTtBQUNSLFNBQU87QUFDTE8sSUFBQUEsU0FBUyxFQUFFUCxNQUFNLENBQUNPLFNBRGI7QUFFTEMsSUFBQUEsVUFBVSxFQUFFUixNQUFNLENBQUNRLFVBRmQ7QUFHTEMsSUFBQUEsSUFBSSxFQUFFVCxNQUFNLENBQUNTLElBSFI7QUFJTEMsSUFBQUEsSUFBSSxFQUFFO0FBSkQsR0FBUDtBQU1EOztBQUVNLFNBQVNDLGFBQVQsQ0FBdUJDLFVBQXZCLEVBQW9FO0FBQ3pFZixFQUFBQSxXQUFXLEdBQUdlLFVBQWQ7QUFD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QUNEOztBQUVNLFNBQVNYLDJDQUFULENBQ0w4QyxHQURLLEVBRXlCO0FBQzlCLE1BQUl6RSxXQUFXLElBQUksSUFBZixJQUF1QixDQUFDd0Isb0JBQVdrRCxRQUFYLENBQW9CRCxHQUFwQixDQUE1QixFQUFzRDtBQUNwRCxXQUFPRSxpQ0FBUDtBQUNEOztBQUVELFNBQU8seUJBQVczRSxXQUFYLEVBQXdCNEUsc0JBQXhCLENBQ0wsOEJBREssRUFFTEgsR0FGSyxDQUFQO0FBSUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XG5pbXBvcnQgdHlwZSB7XG4gIFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0LFxuICBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0LFxufSBmcm9tICcuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2UnO1xuaW1wb3J0IHR5cGUge0lQcm9jZXNzQ29uZmlnfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtZGVidWdnZXItY29tbW9uJztcbmltcG9ydCB0eXBlb2YgKiBhcyBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XG5cbmltcG9ydCB7Z2V0RGVidWdnZXJTZXJ2aWNlfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL2RlYnVnZ2VyJztcbmltcG9ydCB7b2JzZXJ2ZUFkZGVkSG9zdG5hbWVzfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL3Byb2plY3RzJztcbmltcG9ydCBudWNsaWRlVXJpIGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL251Y2xpZGVVcmknO1xuaW1wb3J0IHtmYXN0RGVib3VuY2V9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL29ic2VydmFibGUnO1xuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XG5pbXBvcnQge3RyYWNrfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9hbmFseXRpY3MnO1xuaW1wb3J0ICogYXMgUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XG5pbXBvcnQgbnVsbHRocm93cyBmcm9tICdudWxsdGhyb3dzJztcbmltcG9ydCB7Z2V0TG9nZ2VyfSBmcm9tICdsb2c0anMnO1xuXG5sZXQgX3JwY1NlcnZpY2U6ID9udWNsaWRlJFJwY1NlcnZpY2UgPSBudWxsO1xuXG5mdW5jdGlvbiBnZXRQeXRob25BdHRhY2hUYXJnZXRQcm9jZXNzQ29uZmlnKFxuICB0YXJnZXRSb290VXJpOiBOdWNsaWRlVXJpLFxuICB0YXJnZXQ6IFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0LFxuKTogSVByb2Nlc3NDb25maWcge1xuICByZXR1cm4ge1xuICAgIHRhcmdldFVyaTogdGFyZ2V0Um9vdFVyaSxcbiAgICBkZWJ1Z01vZGU6ICdhdHRhY2gnLFxuICAgIGFkYXB0ZXJUeXBlOiBcInB5dGhvblwiLFxuICAgIGNvbmZpZzogZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0Q29uZmlnKHRhcmdldCksXG4gICAgc2VydmljZWRGaWxlRXh0ZW5zaW9uczogWydweSddLFxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRQeXRob25BdHRhY2hUYXJnZXRDb25maWcoXG4gIHRhcmdldDogUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQsXG4pOiBPYmplY3Qge1xuICByZXR1cm4ge1xuICAgIGxvY2FsUm9vdDogdGFyZ2V0LmxvY2FsUm9vdCxcbiAgICByZW1vdGVSb290OiB0YXJnZXQucmVtb3RlUm9vdCxcbiAgICBwb3J0OiB0YXJnZXQucG9ydCxcbiAgICBob3N0OiAnMTI3LjAuMC4xJyxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFJwY1NlcnZpY2UocnBjU2VydmljZTogbnVjbGlkZSRScGNTZXJ2aWNlKTogSURpc3Bvc2FibGUge1xuICBfcnBjU2VydmljZSA9IHJwY1NlcnZpY2U7XG4gIHJldHVybiBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgX3JwY1NlcnZpY2UgPSBudWxsO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RlblRvUmVtb3RlRGVidWdDb21tYW5kcygpOiBJRGlzcG9zYWJsZSB7XG4gIGNvbnN0IGFkZGVkSG9zdG5hbWVzID0gb2JzZXJ2ZUFkZGVkSG9zdG5hbWVzKCkuc3RhcnRXaXRoKCdsb2NhbCcpO1xuXG4gIGNvbnN0IHJlbW90ZURlYnVnZ2VyU2VydmljZXMgPSBhZGRlZEhvc3RuYW1lcy5mbGF0TWFwKGhvc3RuYW1lID0+IHtcbiAgICBjb25zdCByb290VXJpID1cbiAgICAgIGhvc3RuYW1lID09PSAnbG9jYWwnID8gJycgOiBudWNsaWRlVXJpLmNyZWF0ZVJlbW90ZVVyaShob3N0bmFtZSwgJy8nKTtcbiAgICBjb25zdCBzZXJ2aWNlID0gZ2V0UmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUJ5TnVjbGlkZVVyaShyb290VXJpKTtcbiAgICBpZiAoc2VydmljZSA9PSBudWxsKSB7XG4gICAgICBnZXRMb2dnZXIoKS5lcnJvcignbnVsbCByZW1vdGUgY29tbWFuZCBzZXJ2aWNlIGZvciB1cmk6Jywgcm9vdFVyaSk7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZih7c2VydmljZSwgcm9vdFVyaX0pO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKFxuICAgIHJlbW90ZURlYnVnZ2VyU2VydmljZXNcbiAgICAgIC5mbGF0TWFwKCh7c2VydmljZSwgcm9vdFVyaX0pID0+IHtcbiAgICAgICAgcmV0dXJuIHNlcnZpY2VcbiAgICAgICAgICAub2JzZXJ2ZUF0dGFjaERlYnVnVGFyZ2V0cygpXG4gICAgICAgICAgLnJlZkNvdW50KClcbiAgICAgICAgICAubWFwKHRhcmdldHMgPT4gZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyh0YXJnZXRzKSk7XG4gICAgICB9KVxuXG4gICAgICAuc3Vic2NyaWJlKGR1cGxpY2F0ZVRhcmdldElkcyA9PlxuICAgICAgICBub3RpZnlEdXBsaWNhdGVEZWJ1Z1RhcmdldHMoZHVwbGljYXRlVGFyZ2V0SWRzKSxcbiAgICAgICksXG4gICAgcmVtb3RlRGVidWdnZXJTZXJ2aWNlc1xuICAgICAgLmZsYXRNYXAoKHtzZXJ2aWNlLCByb290VXJpfSkgPT4ge1xuICAgICAgICByZXR1cm4gc2VydmljZVxuICAgICAgICAgIC5vYnNlcnZlUmVtb3RlRGVidWdDb21tYW5kcygpXG4gICAgICAgICAgLnJlZkNvdW50KClcbiAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgJ0ZhaWxlZCB0byBsaXN0ZW4gdG8gcmVtb3RlIGRlYnVnIGNvbW1hbmRzIC0gJyArXG4gICAgICAgICAgICAgICAgJ1lvdSBjb3VsZCBiZSBydW5uaW5nIGxvY2FsbHkgd2l0aCB0d28gQXRvbSB3aW5kb3dzLiAnICtcbiAgICAgICAgICAgICAgICBgSXNMb2NhbDogJHtTdHJpbmcocm9vdFVyaSA9PT0gJycpfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZW1wdHkoKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5tYXAoKGNvbW1hbmQ6IFJlbW90ZURlYnVnQ29tbWFuZFJlcXVlc3QpID0+ICh7cm9vdFVyaSwgY29tbWFuZH0pKTtcbiAgICAgIH0pXG4gICAgICAubGV0KGZhc3REZWJvdW5jZSg1MDApKVxuICAgICAgLnN1YnNjcmliZShhc3luYyAoe3Jvb3RVcmksIGNvbW1hbmR9KSA9PiB7XG4gICAgICAgIGNvbnN0IGF0dGFjaFByb2Nlc3NDb25maWcgPSBnZXRQeXRob25BdHRhY2hUYXJnZXRQcm9jZXNzQ29uZmlnKFxuICAgICAgICAgIHJvb3RVcmksXG4gICAgICAgICAgY29tbWFuZC50YXJnZXQsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGRlYnVnZ2VyU2VydmljZSA9IGF3YWl0IGdldERlYnVnZ2VyU2VydmljZSgpO1xuICAgICAgICB0cmFjaygnZmItcHl0aG9uLWRlYnVnZ2VyLWF1dG8tYXR0YWNoJyk7XG4gICAgICAgIGRlYnVnZ2VyU2VydmljZS5zdGFydFZzcERlYnVnZ2luZyhhdHRhY2hQcm9jZXNzQ29uZmlnKTtcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSdyZSBhbHJlYWR5IGRlYnVnZ2luZyB0aGF0IHRhcmdldC5cbiAgICAgIH0pLFxuICApO1xufVxuXG5sZXQgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyA9IHRydWU7XG5sZXQgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbjtcblxuZnVuY3Rpb24gbm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzKGR1cGxpY2F0ZVRhcmdldElkczogU2V0PHN0cmluZz4pOiB2b2lkIHtcbiAgaWYgKFxuICAgIGR1cGxpY2F0ZVRhcmdldElkcy5zaXplID4gMCAmJlxuICAgIHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgJiZcbiAgICBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uID09IG51bGxcbiAgKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkSWRzID0gQXJyYXkuZnJvbShkdXBsaWNhdGVUYXJnZXRJZHMpLmpvaW4oJywgJyk7XG4gICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKFxuICAgICAgYERlYnVnZ2VyOiBkdXBsaWNhdGUgYXR0YWNoIHRhcmdldHM6IFxcYCR7Zm9ybWF0dGVkSWRzfVxcYGAsXG4gICAgICB7XG4gICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgIHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24uZGlzbWlzcygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGV4dDogJ0lnbm9yZScsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgICAgYE51Y2xpZGUgZGVidWdnZXIgZGV0ZWN0ZWQgZHVwbGljYXRlIGF0dGFjaCB0YXJnZXRzIHdpdGggaWRzICgke2Zvcm1hdHRlZElkc30pIGAgK1xuICAgICAgICAgICdUaGF0IGNvdWxkIGJlIGluc3RhZ3JhbSBydW5uaW5nIG11bHRpcGxlIHByb2Nlc3NlcyAtIGNoZWNrIG91dCBodHRwczovL291ci5pbnRlcm4uZmFjZWJvb2suY29tL2ludGVybi9kZXgvaW5zdGFncmFtLXNlcnZlci9kZWJ1Z2dpbmctd2l0aC1udWNsaWRlLycsXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgfSxcbiAgICApO1xuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24ub25EaWREaXNtaXNzKCgpID0+IHtcbiAgICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gPSBudWxsO1xuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmREdXBsaWNhdGVBdHRhY2hUYXJnZXRJZHMoXG4gIHRhcmdldHM6IEFycmF5PFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0Pixcbik6IFNldDxzdHJpbmc+IHtcbiAgY29uc3QgdGFyZ2V0SWRzID0gbmV3IFNldCgpO1xuICBjb25zdCBkdXBsaWNhdGVUYXJnZXRJZHMgPSBuZXcgU2V0KCk7XG4gIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4ge1xuICAgIGNvbnN0IHtpZH0gPSB0YXJnZXQ7XG4gICAgaWYgKGlkID09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRhcmdldElkcy5oYXMoaWQpKSB7XG4gICAgICBkdXBsaWNhdGVUYXJnZXRJZHMuYWRkKGlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFyZ2V0SWRzLmFkZChpZCk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGR1cGxpY2F0ZVRhcmdldElkcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VCeU51Y2xpZGVVcmkoXG4gIHVyaTogTnVjbGlkZVVyaSxcbik6IFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2Uge1xuICBpZiAoX3JwY1NlcnZpY2UgPT0gbnVsbCAmJiAhbnVjbGlkZVVyaS5pc1JlbW90ZSh1cmkpKSB7XG4gICAgcmV0dXJuIFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VMb2NhbDtcbiAgfVxuXG4gIHJldHVybiBudWxsdGhyb3dzKF9ycGNTZXJ2aWNlKS5nZXRTZXJ2aWNlQnlOdWNsaWRlVXJpKFxuICAgICdSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlJyxcbiAgICB1cmksXG4gICk7XG59XG4iXX0=